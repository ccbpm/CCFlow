<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>会签</title>
    <!--<link href="./css/themes/default/jquery.mobile-1.4.5.min.css" rel="stylesheet" type="text/css" />
    <link href="./css/themes/classic/theme-classic.css" rel="stylesheet" type="text/css" />-->
    <!-- <link href="./css/Main.css" rel="stylesheet" type="text/css" />-->
    <link href="js/mui/css/mui.min.css" rel="stylesheet" type="text/css" />
    <script src="./js/mui/js/mui.min.js" type="text/javascript"></script>
    <script src="./js/jquery.js" type="text/javascript"></script>
    <script src="./js/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
    <script src="./Scripts/config.js" type="text/javascript"></script>
    <script src="Comm/Gener.js" type="text/javascript"></script>
    <style>
        p {
            color: #000;
        }
    </style>
    <script type="text/javascript">

        mui.init();
        mui.ready(
            //加载数据
            function Load_HuiQianList() {

                var handler = new HttpHandler("BP.WF.HttpHandler.CCMobile");
                var data = handler.DoMethodReturnString("HuiQianList_Init");

                $("#LV_HuiQianList").empty();

                var pushData = cceval('(' + data + ')');

                var _Html = "";
                var flowNames = "";

                //判断是否有数据
                if (pushData.length == 0) {
                    mui.alert("记录为空！", function () {
                        SetHref('../CCMobilePortal/Home.htm?s=' + Math.random());

                    });
                    //                _Html = "<button class='ui-btn ui-state-disabled ui-icon-alert ui-btn-icon-top'>记录为空</button>";
                }

                for (var k = 0; k < pushData.length; k++) {
                    if (flowNames.indexOf(pushData[k].FlowName) > -1)
                        continue;
                    flowNames += pushData[k].FlowName + ",";
                }

                var flowName_Arrary = flowNames.split(",");
                for (var j = 0; j < flowName_Arrary.length; j++) {
                    if (flowName_Arrary[j] == "")
                        continue;
                    _Html += "<li class='mui-table-view-cell mui-collapse mui-active'><a class='mui-navigate-right' href='#'>" + flowName_Arrary[j] + "</a>";
                    _Html += "<ul class='mui-table-view mui-table-view-chevron'>";
                    //                _Html += "<li data-role=\"list-divider\">";
                    //                _Html += flowName_Arrary[j];
                    //                _Html += "</li>";

                    for (var i = 0; i < pushData.length; i++) {
                        if (pushData[i].FlowName != flowName_Arrary[j])
                            continue;

                        var en = pushData[i];

                        var fk_flow = en.FK_Flow;
                        var fk_node = en.FK_Node;
                        var workid = en.WorkID;
                        var fid = en.FID;
                        var isRead = en.IsRead;
                        var paras = en.AtPara;
                        if (paras == null || paras == "") {
                            paras = "";
                        }
                        else {
                            if (paras.indexOf("IsCC=1") > -1) {
                                paras = "IsCC=1";
                            } else {
                                paras = "";
                            }
                        }

                        var href = "MyFlow.htm?FK_Flow=" + fk_flow + "&From=HuiQianList&FK_Node=" + fk_node + "&WorkID=" + workid + "&IsRead=" + isRead + "&Paras=" + paras + "&T=" + Math.random();

                        _Html += "<li  class='mui-table-view-cell' style='padding-left:15px'>";
                        _Html += "   <a href='" + href + "' target='_self'>";
                        _Html += "      <h5 style=\"color:#096BC1;\">" + en.Title + "</h5>";
                        _Html += "      <p  style='float:left' >当前节点：" + en.NodeName + "</p><p style='float:right'>发起人:" + en.StarterName + "</p>";
                        //	_Html += "      <p>到达时间：" + en.ADT + "</p>";

                        //退回
                        if (pushData[i].WFState == "5") {
                            _Html += DB_ReturnWorks(fk_node, workid);
                        }

                        _Html += "   </a>";
                        _Html += "</li>";
                    }
                    _Html += "  </ul>";
                    _Html += "</li>";
                }

                //展显
                $(_Html).appendTo('#LV_HuiQianList');
                //刷新,重构暂时去掉
                //            $("#LV_HuiQianList").trigger("create");
                //            $("#LV_HuiQianList").listview('refresh');
                //            MsgHidenLoader();
            }


        );

        //        $(document).on("pageshow", "#page_HuiQianList", function () {
        //            MessageShow("正在加载...", false);
        //            Load_HuiQianList();
        //        });

        //弹出消息
        //        function MessageShow(msg, autoClose) {
        //            if (autoClose == true) {
        //                $.mobile.loading().loader("show", "c", msg, true);
        //                _MsgDialogT = setTimeout("MsgHidenLoader()", 2000);
        //            } else {
        //                $.mobile.loading().loader("show", "c", "", false);
        //                //最长15秒自动隐藏
        //                _MsgDialogT = setTimeout("MsgHidenLoader()", 15000);
        //            }
        //        }

        //关闭消息
        function MsgHidenLoader() {
            $.mobile.loading().loader('hide');
            if (_MsgDialogT != null) {
                clearTimeout(_MsgDialogT);
            }
        }



        //获取退回消息
        function DB_ReturnWorks(FK_Node, WorkID) {
            var _html = "";
            var handler = new HttpHandler("BP.WF.HttpHandler.CCMobile");
            handler.AddPara("FK_Node", FK_Node);
            handler.AddPara("WorkID", WorkID);
            var scorp = handler.DoMethodReturnString("DB_GenerReturnWorks");
            //            $.ajax({
            //                url: Handler + '?DoType=DB_GenerReturnWorks&FK_Node=' + FK_Node + '&WorkID=' + WorkID,
            //                type: 'GET',
            //                async: false,
            //                cache: false,
            //                success: function (scorp, status, xhr) {
            var pushData = cceval('(' + scorp + ')');
            for (var i = 0; i < pushData.length; i++) {
                _html += '<p style="color:#fb12e2;"><strong> 流程退回提示</strong></p>';
                _html += '<p class="mui-ellipsis" style="border-bottom:1px solid #EEE; padding-bottom:0.5em;">';
                _html += '  来自节点：' + pushData[i].ReturnNodeName + '<br />';
                _html += '  退回人：' + pushData[i].ReturnerName + '&nbsp;时间：' + pushData[i].RDT;
                _html += '  <br />';
                _html += '  原 因：' + pushData[i].NoteHtml;
                _html += '</p>';
            }
            //                }
            //            });
            return _html;
        }
        function Back() {
            SetHref('../CCMobilePortal/Home.htm?s=' + Math.random());
            return;
        }
    </script>
</head>
<body>
        <header class="mui-bar mui-bar-nav">
		    <a class="mui-icon mui-icon-left-nav mui-pull-left" href="javascript:Back();"></a>
		    <h1 class="mui-title">会签</h1>
	    </header>
        <div id="page_HuiQianList" data-role="page" data-theme="d">
       
            <div class="mui-content">
                <div class="mui-scroll-wrapper">
			        <div class="mui-scroll">
                        <ul id="LV_HuiQianList" class="mui-table-view mui-table-view-chevron" style="top:46px;height:auto"></ul>
                    </div>
                </div>
            </div>
        <!--<div class="ui-content" data-role="main">
            <ul id="LV_HuiQianList" data-role="listview">
            </ul>
        </div>-->
        <div data-role="panel" id="inside-a" data-position="right" data-display="overlay"
            data-theme="d">
            <ul id="Ul1" data-role="listview" data-theme="b">
                <li data-icon="back"><a href="#" data-rel="close">关闭</a></li>
            </ul>
            <!--  <ul id="ListView_Forms" data-role="listview" style="margin-top:16px;">
                <li>选择查询条件</li>
                <li>
                    <input type="text" id="TB_Keys" placeholder="请输入标题" />
                    <select id="DDL_Flows">
                        <option value='0' selected='selected'>全部流程</option>
                    </select>
                    <input id="Btn_DoQuery" type="button" value="查询" class="ui-btn ui-shadow ui-corner-all" />
                </li>
		    </ul>-->
        </div>
    </div>
</body>
</html>
