<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>退回</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="white">
	<!-- 引入mui -->
	<script src="../js/jquery.js" type="text/javascript"></script>
	<script src="../js/mui/js/mui.min.js" type="text/javascript"></script>
	<link href="../js/mui/css/mui.css" rel="stylesheet" type="text/css" />

	<script src="../Scripts/config.js" type="text/javascript"></script>
	<script src="../Scripts/QueryString.js" type="text/javascript"></script>
	<script src="../Comm/Gener.js" type="text/javascript"></script>
	<script src="../Scripts/commonYangYH.js" type="text/javascript"></script>

		<script type="text/javascript">
		    var pageData = {};
		    $(function () {
		        //初始化页面退回信息

		        pageData = {
		            FK_Node: GetQueryString('FK_Node'),
		            WorkID: GetQueryString('WorkID'),
		            FID: GetQueryString('FID'),
		            Message: GetQueryString('Info'),
		            FK_Flow: GetQueryString("FK_Flow")
		        };

		        if (pageData.Message != undefined && pageData.Message != '') {
		            $('#TB_Doc').val(pageData.Message);
		        }

		        var handler = new HttpHandler("BP.WF.HttpHandler.CCMobile_WorkOpt");
		        handler.AddUrlData();
		        var data = handler.DoMethodReturnString("Return_Init");
		        if (data.indexOf('err@') == 0) {
		            console.error("退回窗口错误信息" + data);

		            mui.alert(data);
		            return;
		        }
		        var returnNodeArr = JSON.parse(data);
		        var items = '';
		        $.each(returnNodeArr, function (i, returnNode) {
		            if (returnNode.AtPara && returnNode.AtPara.indexOf("IsHuiQian==1") >= 0)
		                return true;
		            var val = returnNode.No + '@' + returnNode.Rec;
		            items += '<option data-IsBackTracking=' + returnNode.IsBackTracking + ' value="' + val + '">' + returnNode.RecName + '=&gt;' + returnNode.Name + '</option>';
		        });
		        $('#DDL_Nodes').html(items);

				//获取当前节点属性
				var node = new Entity("BP.WF.Node", pageData.FK_Node)
				if (node.IsBackTracking == "0")
					$('#btnIsBackTracking').css('display', 'none');


		        $("section").show();
		        $(".wait").hide();

		        Common.MaxLengthError();
		        
		        $("#ReturnWork").on("tap",function(){
		        	ReturnWork(0);
				});
		        $("#Back").on("tap",function(){
		        	Back();
				});
				$("#btnIsBackTracking").on("tap",function(){
		        	ReturnWork(1);
				});
		    });



		    //确定 退回 执行退回操作
		    function ReturnWork(isBack) {

		        var val = escape($('#TB_Doc').val());
		        if (val == null || val == "" || val == undefined) {
		            mui.alert("请输入退回原因.");
		            return;
		        }
		        var btnArray = ['否', '是'];
		        mui.confirm('', '您确定要退回吗？', btnArray, function (e) {
                    if (e.index == 1) {
                        $('.foot input').attr('disabled', 'disabled');
                        $('.foot input').css('background', 'gray');

                        var handler = new HttpHandler("BP.WF.HttpHandler.CCMobile_WorkOpt");
                        handler.AddPara("FK_Flow", pageData.FK_Flow);
                        handler.AddPara("WorkID", pageData.WorkID);
                        handler.AddPara("FID", pageData.FID);
                        handler.AddPara("FK_Node", pageData.FK_Node);
                        handler.AddPara("ReturnToNode", $('#DDL_Nodes option:checked').val());
                        handler.AddPara("ReturnToNode", $('#DDL_Nodes option:checked').val());
                        handler.AddPara("ReturnInfo", $('#TB_Doc').val());
                        handler.AddPara("IsBack", isBack);
                        var data = handler.DoMethodReturnString("DoReturnWork");

                        data = data.replace('@', '<br/>@');
                        data = data.replace(/@/g, '\t\n@');
                        data = data.replace(/null/g, '');
                        mui.alert(data, "退回消息提示框", function () {
                            SetHref('../Todolist.htm?m=');

                        });


                        $(".foot").hide();



		    		}

		        });

		    };


		    function Back() {
				var url = "../MyFlow.htm?WorkID=" + GetQueryString("WorkID") + "&FK_Flow=" + GetQueryString("FK_Flow") + "&FK_Node=" + GetQueryString("FK_Node") + "&ms=" + Math.random();
		        SetHref(url);
		    }

		    function BackToHome() {
                SetHref('../../CCMobilePortal/Home.htm?UserNo=' + GetQueryString('UserNo') + "&Token=" + GetQueryString("Token"));
		    }

		    function BackToTodolist() {
                SetHref('../Todolist.htm?UserNo=' + GetQueryString('UserNo') + "&Token=" + GetQueryString("Token"));
		    }

		    function BackToStart() {
                SetHref('../Start.htm?UserNo=' + GetQueryString('UserNo') + "&Token=" + GetQueryString("Token"));
		    }
      
    </script>
        <style>
            .mui-bar-tab .mui-tab-item {
            color:#000;
            }
        </style>
</head>
<body>
	<header class="mui-bar mui-bar-nav"> 
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 id="title" class="mui-title">请选择要退回到的节点</h1>
	</header>
	<nav class="mui-bar mui-bar-tab "> 
		<a class="mui-tab-item"href="#" id="ReturnWork" >确定退回</a>
		<a class="mui-tab-item"href="#" id="btnIsBackTracking" >退回后并发送给我</a>
		<a class="mui-tab-item"href="#" id="Back" >返回</a> 
	</nav>
	<div class="mui-content" style="margin-top: 15px;">
		<div class="mui-content-padded">
			<select id="DDL_Nodes" name="DDL_Nodes" class="mui-btn mui-btn-block"></select> 
			<label for="TB_Doc">退回原因：</label>
			<div class="mui-input-row" style="margin: 10px 5px;">
				<textarea name="TB_Doc" id="TB_Doc" rows="5" placeholder="请输入退回原因.."></textarea>
			</div>
			

		</div>
	</div>
</body>
</html>
