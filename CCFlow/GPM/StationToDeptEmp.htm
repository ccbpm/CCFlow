<html xmlns="http://www.w3.org/1999/xhtml">
<head >
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>岗位授权</title>
    <link rel="stylesheet" type="text/css" href="themes/default/easyui.css" />
    <link href="themes/default/tree.css" rel="stylesheet" type="text/css" />
    <link href="themes/default/datagrid.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="themes/icon.css" />
    <script type="text/javascript" src="jquery/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="jquery/jquery.easyui.min.js"></script>
    <script src="javascript/CC.MessageLib.js" type="text/javascript"></script>
    <script src="jquery/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="jquery/easytemplate.js" type="text/javascript"></script>
  <!--  <script src="javascript/AppData.js" type="text/javascript"></script>
    <script src="javascript/StationToDeptEmp.js" type="text/javascript"></script>-->
    <link href="../DataUser/Style/ccbpm.css" rel="stylesheet" type="text/css" />
    <!-- 引入新版本的类库. -->
    <script src="../WF/Scripts/config.js" type="text/javascript"></script>
    <script src="../WF/Comm/Gener.js" type="text/javascript"></script>

    <script type="text/javascript">
        //页面启动函数.
        $(function () {

            var user = new WebUser();
            if (user.No != 'admin') {
                alert('您没有权限');
                return;
            }

            document.title = '按岗位设置权限:' + user.Name;

            //绑定岗位树.
            BindStationTree();

            //绑定部门树.
           
            GenerBindEntities("DDL_DeptTree", "BP.Port.Depts", user.FK_Dept);
            return;
        });

        function BindStationTree() {

            var stationTypes = new Entities("BP.GPM.StationTypes");
            stationTypes.RetrieveAll();

            var stations = new Entities("BP.GPM.Stations");
            stations.RetrieveAll();

            var html = "<table border=0 style='width:100%;' >";
            
            for (var i = 0; i < stationTypes.length; i++) {

                var type = stationTypes[i];

                html += "<tr><th><span style='float:left'>" + type.Name + "</span></th></tr>";

                html += "<tr><td>";

                for (var idx = 0; idx < stations.length; idx++) {

                    var sta = stations[idx];
                    if (sta.FK_StationType != type.No)
                        continue;

                    html += "<a href=\"javascript:BindEmpByStation('" + sta.No + "')\">" + sta.Name + "</a><br/>";
                }

                html += "</td></tr>";
            }

            html += "</table>";

            $("#StasList").html(html);
        }

        //当前选择的岗位编号.
        var currStationNo = null;
        var currDeptNo = null;


        //显示人员.
        function BindEmpByStation(staNo) {
            currStationNo = staNo;

            if (currDeptNo == null) {
                currDeptNo = $('#DDL_DeptTree').val();
            }

            GenerEmps(staNo, currDeptNo);
        }

        //显示人员.
        function BindEmpByDept() {

            currDeptNo = $('#DDL_DeptTree').val();
            
            GenerEmps(currStationNo, currDeptNo);
        }
        
        //生成页面.
        function GenerEmps(staNo, deptNo) {

            //获得已经选择的人员.
            var empsOfSelected = new Entities("BP.GPM.DeptEmpStations");
            empsOfSelected.Retrieve("FK_Dept", deptNo, "FK_Station", staNo);

            //获得该部门下人员集合.
            var emps = new Entities("BP.GPM.DeptEmps");
            emps.Retrieve("FK_Dept", deptNo);

            if (emps.length == 0) {
                alert('该部门下没有人员');
                return;
            }

            $("#templatePanel").html();


            var dept = new Entity("BP.Port.Dept", deptNo);
            var html = "<h3>" + dept.Name + " 共有(" + emps.length + ")个成员.</h3>";

            var station = new Entity("BP.Port.Station", staNo);
            html += "<h3> 岗位:" + station.Name + " </h3>";

            for (var idx = 0; idx < emps.length; idx++) {

                var emp = emps[idx];

                var myemp = new Entity('BP.Port.Emp', emp.FK_Emp);
                var checked = "";

                var label = myemp.Name;

                //判断是否选中.
                for (var idc = 0; idc < empsOfSelected.length; idc++) {

                    if (empsOfSelected.FK_Emp == emp.FK_Em) {
                        checked = 'checked=true';

                        label = "<font color=green>" + label + "</font>";
                        break;
                    }
                }
                html += "&nbsp;<label><input type=checkbox name='cbgroup' id='" + emp.FK_Emp + "' " + checked + " />" + label + "</label>";
            }

            $("#templatePanel").html(html);
        }


        //全选
        function CheckedAll() {

            var checkedSta = false;
            var ckbAll = document.getElementById("ckbAllText");
            var selected = $('#StationsTree').tree('getSelected');
            //岗位如果没有选择项就返回
            if (!selected) 
                return;

            if (ckbAll.innerHTML == "全选") {
                checkedSta = true;
                ckbAll.innerHTML = "清空";
            } else {
                ckbAll.innerHTML = "全选";
            }
            var ckgroup = document.getElementsByName("ckgroup");
            for (var i = 0; i < ckgroup.length; i++) {
                var ck = $('#StationsTree').tree('find', ckgroup[i]);
                if (hasPower(ck)) {
                    ckgroup[i].checked = checkedSta;
                }
            }
        }

        //保存选择项
        function Save() {

            if (currDeptNo == null || currStationNo == null) {
                alert('没有选择数据');
                return;
            }


            //创建一个实体.
            var myen = new Entity("BP.GPM.DeptEmpStation");
            myen.Delete("FK_Dept", currDeptNo, "FK_Station", currStationNo); //删除现有的数据.

            var en = new Entity("BP.GPM.DeptEmpStation");

            //获得分组
            var ckgroup = document.getElementsByName("cbgroup");

            var num = 0;

            //获取选择项
            for (var i = 0; i < ckgroup.length; i++) {

                if (ckgroup[i].checked == false)
                    continue;

                var empNo = ckgroup[i].id;

                var pkVal = currDeptNo + "_" + empNo + '_' + currStationNo;

                //this.MyPK = this.FK_Dept + "_" + this.FK_Emp + "_" + this.FK_Station;
                //alert(pkVal);

                en.SetPKVal(pkVal);
                en.MyPK = pkVal;
                en.FK_Station = currStationNo;
                en.FK_Emp = empNo;
                en.FK_Dept = currDeptNo;
                en.Insert();  //插入到数据库》
                num++;
            }

            alert('一共[' + num + ']保存成功.');

            // alert('保存成功.');
        }
    </script>

    
</head>
<body class="easyui-layout">
    <!--<div id="pageloading" style="filter: alpha(opacity=80); opacity:0.80;">-->
    </div>
    <div data-options="region:'west',split:true" style="width: 300px; padding: 1px; overflow: hidden;">
        <div style="width: 100%; height: 100%; overflow: auto;">
            <ul id="StationsTree" class="easyui-tree-line" data-options="animate:false,dnd:false">
            </ul>

            <div id="StasList" ></div>
        </div>
    </div>
    <div data-options="region:'center'" style="overflow: hidden;">
        <div style="padding: 0px; background: #fafafa; width: 100%;">
            
            <!--<a href="#" class="easyui-linkbutton" data-options="plain:true"><b><span id="curModelText" >选择按人员分配权限</span></b></a>-->

            <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-reset'" onclick="CheckedAll()"><span id="ckbAllText">全选</span></a> 
            <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-save-save'" onclick="Save('0')">保存</a>
            <!--<a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-save'" onclick="Save('1');">清空保存</a>-->
            <input type="checkbox" id="CB_ViewModel" onclick="GetTemplatePanel()" />显示已选
            | 选择部门：<select id="DDL_DeptTree"   onchange="BindEmpByDept()" style="width: 260px;">
              </select>

             <!-- <select id="Select1" class="easyui-combotree" style="width: 260px;">
              </select>-->
        </div>
        <div style="overflow: auto; height: 95%;">
            <div id="templatePanel" style=" margin:10px;">
            </div>
            <br />
        </div>
    </div>
</body>
</html>
    