<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>权限控制</title>
    <link href="../../Scripts/easyUI/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../../Scripts/easyUI/themes/icon.css" rel="stylesheet" type="text/css" />

    <link href="../../CCForm/JS/mselector.css" rel="stylesheet" type="text/css" />
    <link href="../../Scripts/bootstrap/css/bootstrap.css" rel="stylesheet" />
    <script src="../../Scripts/jquery-1.11.0.min.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI/jquery.easyui.min.js" type="text/javascript"></script>

    <link href="../../../DataUser/Style/ccbpm.css" rel="stylesheet"
          type="text/css" />
    <script type="text/javascript" src="../../Comm/JScript.js"></script>
    <script type="text/javascript"
            src="../../Scripts/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../Scripts/QueryString.js"></script>
    <script type="text/javascript" src="../../Scripts/config.js"></script>
    <script type="text/javascript" src="../../Comm/Gener.js"></script>

    <script type="text/javascript" src="../../Scripts/QueryString2016.js"></script>
    <link href="../../Scripts/bootstrap/css/font-awesome.css" rel="Stylesheet" />
    <script type="text/javascript" src="../../Scripts/bootstrap/js/jquery.cokie.min.js"></script>
    <script src="../../Scripts/bootstrap/BootstrapUIDialog.js" type="text/javascript"></script>
    <script src="../../CCForm/JS/mtags.js" type="text/javascript"></script>
    <style type="text/css">
        .ccflow-input-span-container {
            border: 0;
        }

        th {
            border-width: 1px;
            border-color: #C2D5E3;
            border-style: solid;
            line-height: 25px;
            color: #0a0a0a;
            white-space: nowrap;
            padding: 5px 2px;
            background-color: #e0ecff;
            font-size: 14px;
            text-align: left;
            font-size: 12px;
            font-weight: bolder;
        }
    </style>
    <base target="_self" />

    <script type="text/javascript">
        var currSelectNode = "";
         var models = [];
        //页面启动函数.
        $(function () {
            $("#Msg").html("<img src=../../Img/loading.gif />&nbsp;正在加载,请稍后......");
            InitPage();
            $("#Msg").html("");
        });

        //初始化数据.
        function InitPage() {

            var flowNo = GetQueryString("FK_Flow");

            var ens = new Entities("BP.WF.Template.PowerModels");
            ens.Retrieve("Model", "FlowData", "FlowNo", flowNo);

            var html = "";
            html += "<table style='width:100%;'>";
            html += "<caption>权限控制</caption>";
            html += "<tr>";
            html += "<th>编号</th>";
            html += "<th>权限</th>";
            html += "<th>岗位</th>";
            html += "<th>人员</th>";
            html += "</tr>";

            var itemFlowDataView = { 'PowerFlag': 'FlowDataView', 'PowerFlagName': '查看', 'PortSta': '', 'PortEmp': '' };
            var itemFlowDataPress = { 'PowerFlag': 'FlowDataPress', 'PowerFlagName': '催办', 'PortSta': '', 'PortEmp': '' };
            var itemFlowDataShift = { 'PowerFlag': 'FlowDataShift', 'PowerFlagName': '移交（特送人员）', 'PortSta': '', 'PortEmp': '' };
            var itemFlowDataAddEmps = { 'PowerFlag': 'FlowDataAddEmps', 'PowerFlagName': '增加处理人(委托)', 'PortSta': '', 'PortEmp': '' };
            var itemFlowDataRollback = { 'PowerFlag': 'FlowDataRollback', 'PowerFlagName': '回滚', 'PortSta': '', 'PortEmp': '' };
            var itemFlowDataOver = { 'PowerFlag': 'FlowDataOver', 'PowerFlagName': '结束', 'PortSta': '', 'PortEmp': '' };
            var itemFlowDataSkip = { 'PowerFlag': 'FlowDataSkip', 'PowerFlagName': '跳转', 'PortSta': '', 'PortEmp': '' };
            var itemFlowDataDelete = { 'PowerFlag': 'FlowDataDelete', 'PowerFlagName': '删除', 'PortSta': '', 'PortEmp': '' };

            models.push(itemFlowDataView);
            models.push(itemFlowDataPress);
            models.push(itemFlowDataShift);
            models.push(itemFlowDataAddEmps);
            models.push(itemFlowDataRollback);
            models.push(itemFlowDataOver);
            models.push(itemFlowDataSkip);
            models.push(itemFlowDataDelete);

            for (var i = 0; i < models.length; i++) {
                var model = models[i];

                html += "<tr>";

                html += "<td>" + model.PowerFlag + "</td>";
                html += "<td>" + model.PowerFlagName + "</td>";


                html += "<td></td>";
                html += "<td>1<div id='" + i + "_mtags' data-power=" + model.PowerFlag + " style='width:99%'  class='mtags'></div></td>";

                html += "</tr>";
            }
            html += "</table>";
            $("#docs").html(html);

            var dept = getQueryStringByNameFromUrl("?" + $.cookie('CCS'), "FK_Dept");
            if (dept == null || dept == '' || dept == undefined) {
                dept = $.cookie('FK_Dept');
            }

            if (dept == null || dept == '' || dept == undefined) {
                var u = new WebUser();
                dept = u.FK_Dept;
            }

            if (dept == undefined) {
                dept = "0";
            }

            //绑定用户事件
            for (var i = 0; i < models.length; i++) {
                var mtags = $("#" + i + "_mtags");
                mtags.mtags({
                    "fit": true
                   
                });
            }
            //绑定获取用户事件
            $.each($(".mtags"), function (i, mtags) {
                var w = window.parent.document.body.clientWidth - 300;
                var h = window.parent.document.body.clientHeight - 40;
                $(".mtags").bind("click", function () {
                    debugger;
                    currSelectNode = $(mtags).attr("data-power").replace("_mtags", "");
                    var url = "../../WorkOpt/SelectEmps.htm?FK_Dept=" + dept + "&FK_Node=" + currSelectNode + "&s=" + Math.random();
                    $('#iframeSelectEmpsForm').attr('src', url);
                    $('#SelectEmpsModal').modal().show();                  
                });

            });
        }

        function changeOrOpenTab(flowName, flowNo) {
            //"&UserNo=" + WebUser.No + "&SID=" + WebUser.SID + "&Flow_V=1", node.iconCls
            var url = "../CCBPMDesigner/Designer.htm?FK_Flow=" + flowNo
                + "&UserNo=" + WebUser.No + "&SID=" + WebUser.SID + "&Flow_V=1";
            window.parent.parent.addTab(flowNo, flowNo + "." + flowName, url,
                "icon-flow1");
        }

        //设置选中的人员
        function selectEmpsWindowClose(data) {

            $('#SelectEmpsModal').modal('hide');
            if (data == '取消') {
                return;
            }
            var val = frames["iframeSelectEmpsForm"].window.returnVal;
            
            console.log(val + "_br");
            debugger;
           /* var mypk = currSelectNode + "_" + GetQueryString("WorkID");
            var en = new Entity("BP.WF.TransferCustom", mypk);
            en.Worker = en.Worker + "," + val.No + ",";
            en.WorkerName = en.WorkerName + "," + val.Name + ",";
            en.Update();
            InitMtags($("#" + en.FK_Node + "_mtags"), en.MyPK, en.Worker, en.WorkerName);*/

            
            var modelType = 1;
            var empNos = val.No;
            if (empNos != null && !$.isEmptyObject(empNos)) {
                var empNoArray = empNos.split(',');
                var powerFlag = currSelectNode;
                var flowNo = GetQueryString("FK_Flow");
                $.each(empNoArray, function (i, empNo) {
                    var myPk = modelType + "_" + empNo + "_" + powerFlag + "_" + flowNo;
                    var en = new Entity("BP.WF.Template.PowerModel");
                    en.SetPKVal(myPk); //设置主键.
                    en.Delete();
                    en.SetPKVal(myPk);
                    en.Model = "FlowData";
                    en.PowerFlag = powerFlag;
                    debugger
                    var model = getModelByPowerFlag(powerFlag);
                    if (model != null) {
                        en.PowerFlagName = model.PowerFlagName;
                    }
                   
                    en.FlowNo = flowNo;
                    en.EmpNo = empNo;
                    en.EmpName = val.Name.split(",")[i];
                    en.NodeId = 0;
                    en.PowerCtrlType = 1;
                    en.Insert();
                });
            }
            debugger;
            console.log("deb-br" + currSelectNode);
            InitMtags($("div[data-power='" + currSelectNode + "']"), val);
            
           /* var myPk = modelType + "_" + empNo;
            en.SetPKVal(myPk); //设置主键.
            en.Delete();


            en.PowerFlag = "FlowDataView";
            en.PowerFlagName = "查看";

            en.FlowNo = GetQueryString("FK_Flow");
            en.EmpNo = "sss";
            en.EmpName = "xxxxx";

            en.SetPKVal(myPk); //设置主键.
            en.Insert();*/

        }

        //获取当前结点model根据powerFlag
        function getModelByPowerFlag(powerFlag) {
            for (var i = 0; i < models.length; i++) {
                var model = models[i];
                if (model.PowerFlag == powerFlag) {
                    return model;
                }
            }
            return null;
        }

        //初始化接收人员列表
        function InitMtags(mtags, emp) {
            debugger
            debugger
            debugger;
            console.log("br---" + mtags + "_" + emp.No);
            var initJsonData = [];
            if (emp != null) {
                $.each(emp.No.split(","), function (k, o) {
                    if (o != null && o != "")
                        initJsonData.push({
                            "No": o,
                            "Name": emp.Name.split(',')[k],
                            "MyPK": o
                        });
                });    
            }
            
            mtags.mtags("loadData", initJsonData);
        }

        //删除人员
        function RemoveEmp(mypk, empNo, empName) {
            var en = new Entity("BP.WF.TransferCustom", mypk);
            en.Worker = en.Worker.replace(empNo + ",", "");
            en.WorkerName = en.WorkerName.replace(empName + ",", "");
            en.Update();
            InitMtags($("#" + en.FK_Node + "_mtags"), mypk, en.Worker, en.WorkerName);
        }
    </script>
</head>
<body>


    <div id="docs"></div>

    <div id="Msg"></div>

    <div class="modal fade" id="SelectEmpsModal">
        <div class="modal-dialog">
            <div class="modal-content" style="border-radius: 0px; width: 700px;">
                <div class="modal-header">
                    <button type="button" class="close" style="color: #0000007a; opacity: 1;" data-dismiss="modal"
                            aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title">
                        接受人
                    </h4>
                </div>
                <div class="modal-body">
                    <iframe style="width: 100%; border: 0px; height: 400px;" id="iframeSelectEmpsForm"
                            name="iframeSelectEmpsForm"></iframe>
                </div>
            </div>
            <!-- /.modal-content -->
            '
        </div>
        <!-- /.modal-dialog -->
        '
    </div>
</body>
</html>
