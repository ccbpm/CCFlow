<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
	<title>延续子流程</title>
	 <link href="../../Comm/Style/CommStyle.css" rel="stylesheet" type="text/css" />
    <link href="../../../DataUser/Style/ccbpm.css" rel="stylesheet"  type="text/css" />
    <link href="../../Scripts/easyUI/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../../Scripts/easyUI/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../../Scripts/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../../Scripts/QueryString.js" type="text/javascript"></script>
    <script type="text/javascript" src="../../Scripts/config.js"></script>
    <script type="text/javascript" src="../../Comm/Gener.js"></script>
    <script src="../../Scripts/EasyUIUtility.js" type="text/javascript"></script>

	<base target="_self" />
	<script type="text/javascript">

	    //页面启动函数.
	    $(function () {

	        $("#Msg").html("<img src=../../Img/loading.gif />&nbsp;正在加载,请稍后......");

	        //求出来已经设置的延续子流程.
	        var nodeID = GetQueryString("FK_Node");
	        var ens = new Entities("BP.WF.Template.NodeYGFlows");
	        ens.Retrieve("FK_Node", nodeID);

	        var html = "";
	        for (var i = 0; i < length; i++) {
	            var en = ens[i];
	            html += "<tr>";
	            html += "<td>" + en.FK_FlowT + "</td>";
	            html += "<td>" + en.YGWorkWayT + "</td>";
	            html += "<td><a href=\"javascript:Edit('" + en.OID + "');\" >编辑</a></td>";
	            html += "<td><a href=\"javascript:Delete('" + en.OID + "');\" >删除</a></td>";
	            html += "</tr>";
	        }

	        $("#Msg").html("");

	    });

	    function Save() {

	    }

        //查询集团的流程.
	    function AddGroup() {
	        var webUser = new WebUser();
	        ShowFlows(webUser.GroupNo);
	    }
	    //查询集团的流程.
	    function AddOrg() {
	        var webUser = new WebUser();
	        ShowFlows(webUser.FK_Dept);
	    }

        //显示子流程.
	    function ShowFlows(orgNo) {

	        //查询出来数据.
	        var sql = "SELECT A.No AS SortNo, A.Name as SortName, b.No, b.Name ";
	        sql += " FROM WF_FlowSort a, WF_Flow b WHERE (A.OrgNo='" + orgNo + "' OR A.ParentNo='" + orgNo + "') AND A.No=B.FK_FlowSort ";
	        sql += " ORDER BY A.Idx, b.Idx ";

	        //获得要增加的流程集合.
	        var dt = DBAccess.RunUrlReturnJSON(sql);

	        //          //求出来已经设置的延续子流程,用于显示列表的时候
	        //          var nodeID = GetQueryString("FK_Node");
	        //          var ens = new Entities("BP.WF.Template.NodeYGFlows");
	        //          ens.Retrieve("FK_Node", nodeID);
	    }

	    function ShowFlows_Save(flowNo) {

	        var ens = new Entities("BP.WF.Template.NodeYGFlows");
	        ens.Retrieve("FK_Node", nodeID, "FK_Flow", flowNo);
	        if (ens.length == 1) {
	            alert("该流程已经存在");
	            return;
	        }

	        var en = new Entity("BP.WF.Template.NodeYGFlow");
	        en.FK_Flow = flowNo;
	        en.FK_Node = GetQueryString("FK_Node");
	        en.Insert();

	        window.location.href = window.location.href;
          
	    }

        //删除成功.
        function Delete(pk) {

            if (confirm('您确定要删除吗？') == false)
                return;

            var en = new Entity("BP.WF.Template.NodeYGFlow", pk);
            en.Delete();
            window.location.href = window.location.href;
        }
        //编辑.
        function Edit(pk) {

            if (confirm('您确定要删除吗？') == false)
                return;

            var url = "../../Comm/RefFunc/EnVer.htm?EnName=BP.WF.Template.NodeYGFlow&PKVal=" + pk;
            OpenEasyUiDialogExt(url, '编辑', 500, 400, true);

        }
    </script>
</head>
<body>
	<table id="Table1" style="width: 100%">
		
        <caption>延续子流程 <a href="javascript:AddGroup()">增加集团子流程</a>|<a href="javascript:AddOrg()">增加本组织子流程</a></caption>

        <tr>
        <th>流程名称</th>
        <th>工作方式</th>
        <th>操作</th>
        </tr>
		 
	</table>
    <br />

				<button  id="Btn_Save" onclick="Save()">
					保存</button>


	<div id="Msg">
	</div>

    <fieldset>
					<legend>填写帮助</legend>
					<ul>
						<li></li>
					</ul>
				</fieldset>
</body>
</html>
