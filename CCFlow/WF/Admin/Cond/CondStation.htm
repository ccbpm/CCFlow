<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <title>方向条件-按照岗位计算</title>
    <!-- 于庆海 -->
    <link href="../../Comm/Style/Table0.css" rel="stylesheet" type="text/css" />
    <script src="../../Scripts/bootstrap/js/jquery.min.js" type="text/javascript"></script>
    <script src="../../Scripts/QueryString.js" type="text/javascript"></script>
    
    <!-- 引用通用的js文件. -->
    <script src="../../Scripts/config.js" type="text/javascript"></script>
    <script src="../../Comm/Gener.js" type="text/javascript"></script>
    <script src="../../Comm/JScript.js" type="text/javascript"></script>
    <script src="../CCFlowEnum.js" type="text/javascript"></script>
    <script type="text/javascript" language="javascript">
   
        //页面启动函数.
        $(function () {

            $("#Msg").html("正在加载,请稍后......");

            InitPage();

            $("#Msg").html("");
        });
        //初始化数据.
        function InitPage() {
            //获取URL参数
            var nodeID = GetQueryString("FK_Node");
            var FK_MainNode = GetQueryString("FK_MainNode");
            var ToNodeID = GetQueryString("ToNodeID");

            //条件属性
            var mypk = FK_MainNode + "_" + ToNodeID + "_Dir_" + "Stas";

            var cond = new Entity("BP.WF.Template.Cond", mypk);
            // 运算的值
            var operatorValue = cond.OperatorValue

            //获取已指定操作员的岗位条件
            var CheckStations = operatorValue.split("@");

            //岗位类型集合
            var StationTypes;
            var GStationTypes;
            var OStationTypes;

            //岗位集合
            var Stations;
            var GStations;
            var OStations;

            ////根据用户的信息，判断是否启用那个设置工具。
            var user = new WebUser();

            /*调用通用的.*/
            if (user.FK_Dept == 0) {
                $("#AdminModel").show();
                StationTypes = new Entities("BP.GPM.StationTypes");
                StationTypes.RetrieveAll();

                Stations = new Entities("BP.GPM.Stations");
                Stations.RetrieveAll();
                //初始化岗位Table显示
                InitStationTable("t1", StationTypes, Stations);

             /*调用集团模式的.*/
            } else {
                $("#OrgModel").show();
                //集团模式
                var groupNo = user.GroupNo;
                GStations = new Entities("BP.GPM.Stations");
                GStations.Retrieve("OrgNo", groupNo);
                //查询出来数据.	       
                var sql = "select No,Name from port_StationType where No in (select Fk_StationType from Port_Station where OrgNo =" + groupNo + ")";
                //获得要增加的流程集合.
                GStationTypes = DBAccess.RunSQLReturnTable(sql);
                //初始化岗位Table显示
                InitStationTable("t2", GStationTypes, GStations);

                //组织结构模式
                var orgNo = user.FK_Dept;
                OStations = new Entities("BP.GPM.Stations");
                OStations.Retrieve("OrgNo", orgNo);
                //查询出来数据.	       
                var sql = "select No,Name from port_StationType where No in (select Fk_StationType from Port_Station where OrgNo =" + orgNo + ")";
                //获得要增加的流程集合.
                OStationTypes = DBAccess.RunSQLReturnTable(sql);
                //初始化岗位Table显示
                InitStationTable("t3", OStationTypes, OStations);

            }

            //获取已指定操作员的岗位条件
            for (i = 0, len = CheckStations.length; i < len; i++) {
                if (CheckStations[i] == "") continue;
                var stationObject = document.getElementById("emp_CB_" + CheckStations[i]);
                if(stationObject!=null)stationObject.checked = true;
            }

            //TODO 条件参数
            var atpara = cond.AtPara;
            if (atpara != "") {
                var initDDL_SpecOperWay = atpara.split("@")[1].split("=")[1];
                document.getElementById("initDDL_SpecOperWay").value = initDDL_SpecOperWay;
                document.getElementById("DDL_SpecOperWay").value = initDDL_SpecOperWay;

                var initTB_SpecOperPara = atpara.split("@")[2].split("=")[1];
                document.getElementById("TB_SpecOperPara").value = initTB_SpecOperPara;
                if (initDDL_SpecOperWay != 0) {
                    document.getElementById("TB_SpecOperPara").disabled = "";
                }
                document.getElementById("initTB_SpecOperPara").value = initTB_SpecOperPara;
                $("#span" + initDDL_SpecOperWay).css("display", "inline-block");
                $("#span" + initDDL_SpecOperWay).siblings().css("display", "none");
            }
            //条件参数 end
            //end
            var currCondStation = null
            //调用公共类库的方法:执行批量主表赋值
            if (currCondStation != null)
                GenerFullAllCtrlsVal(currCondStation);
           
        }

        //初始化岗位列表TABLE
        function InitStationTable(tableId, stationTypes, stations) {
            for (var i = 0, len = stationTypes.length; i < len; i++) {
                var typeno = stationTypes[i].No;

                var curstas = [];
                var ids = "";
                for (var j = 0, jlen = stations.length; j < jlen; j++) {
                    if (stations[j].FK_StationType == typeno) {
                        curstas.push(stations[j]);
                        ids += "CB_" + stations[j].No + ",";
                    }
                }

                var title = "<tr><td colspan='3' class='GroupTitle'><input id='CB_type_" + tableId + "_" + typeno + "' type='checkbox' name='CB_type_" + typeno + "' onclick=\"SetSelected(this,'" + ids + "')\"/><label>" + stationTypes[i].Name + "</label></td></tr>";
                $("#"+tableId).append(title);

                for (var k = 0, klen = curstas.length; k < klen; k++) {
                    var td = "<td><input type='checkbox' id='emp_CB_" + curstas[k].No + "' name='emp_CB_" + curstas[k].No + "'/><label for='emp_CB_" + curstas[k].No + "'>" + curstas[k].Name + "</label></td>";
                    if (k % 3 == 0) {
                        $("#" + tableId).append("<tr></tr>");
                    }
                    $("#"+tableId+" tr:last").append(td);
                }
            }

        }

        function Btn_Delete_Click() {

            if (window.confirm('您确定要删除吗？') == false)
                return;
            var handler = new HttpHandler("BP.WF.HttpHandler.WF_Admin_Cond");
            handler.AddPara("FK_Node", GetQueryString("FK_Node"));
            handler.AddPara("FK_MainNode", GetQueryString("FK_MainNode"));
            handler.AddPara("ToNodeID", GetQueryString("ToNodeID"));
            handler.AddPara("DirType", GetQueryString("DirType"));
            handler.AddPara("CondType", GetQueryString("CondType"));
            handler.AddUrlData();
            var data = handler.DoMethodReturnString("CondByStation_Delete");
            window.location.href = window.location.href;
           
        }

        //ajax 提交
        function Btn_Save_Click() {

            var param = location.href.split("?")[1];

            //var checkBoxIDs = GenerCheckIDs(); //获得所有的 checkBox ID传入到后台去,用于解决checkbox控件，在没有被选择的时候，没有值的问题。
            //获取所有选中的checkbox
            var emps = ",";
            $("input[type='checkbox']").each(function () {

                if (this.checked && this.name.indexOf("emp_CB_") == 0) {
                    emps += this.name.replace("emp_CB_","") + ",";
                }
            });
            var frmData = $("#cc").serialize();
            var handler = new HttpHandler("BP.WF.HttpHandler.WF_Admin_Cond");
            handler.AddPara("FK_Node", GetQueryString("FK_Node"));
            handler.AddPara("emps", emps);
            handler.AddPara("FK_MainNode", GetQueryString("FK_MainNode"));
            handler.AddPara("ToNodeID", GetQueryString("ToNodeID"));
            handler.AddPara("DirType", GetQueryString("DirType"));
            handler.AddPara("CondType", GetQueryString("CondType"));
            handler.AddFormData(frmData)
            handler.AddUrlData();
            var data = handler.DoMethodReturnString("CondByStation_Save");
            window.location.href = window.location.href;
            
        }

        function selChange() {
            //01.如果 文本框 有初始值就赋初值
            var idx = document.getElementById("DDL_SpecOperWay").value;
            var idxinit = document.getElementById("initDDL_SpecOperWay").value;
            if (idx == idxinit) {
                document.getElementById("TB_SpecOperPara").value = document.getElementById("initTB_SpecOperPara").value;
            }
            else {
                document.getElementById("TB_SpecOperPara").value = "";
            }

            //02.处理文本框样式
            if (idx == 0) {
                document.getElementById("TB_SpecOperPara").disabled = "disabled";
            } else {
                document.getElementById("TB_SpecOperPara").disabled = "";
            }
            //03.处理标签
            $("#span" + idx).css("display", "inline-block");
            $("#span" + idx).siblings().css("display", "none");
        }
    </script>

    <style type="text/css">
        ul .cond li
        {
            display: none;
            line-height: 50px;
        }
        
        ul .cond li .active
        {
            display: block;
        }
        
        select
        {
            display: inline-block;
            width: 200px;
        }
        
        .btn
        {
            display:inline-block;
            height:20px;
            background-color:#0099ff;
            text-decoration:none;
            color:#fff;
            padding:3px 15px;
            margin:10px 10px;
        }
        .lbls span
        {
            width:80px;
         }
    </style>
</head>
<body>
    <form action="/" method="post" id="cc">
    <div>
        <div id="AdminModel" style="max-height:600px;overflow:auto;">
            <table id="t1" class="Table" cellspacing="1" cellpadding="1" border="1" style="width: 100%">
            </table>
        </div>
        <div id="OrgModel" style="max-height:600px;overflow:auto;">
            <fieldset>
                <legend>集团岗位</legend>
                 <table id="t2" class="Table" cellspacing="1" cellpadding="1" border="1" style="width: 95%;margin:5px">
            </table>
            </fieldset>
           
            <fieldset>
                <legend>组织岗位</legend>
                 <table id="t3" class="Table" cellspacing="1" cellpadding="1" border="1" style="width: 95%;margin:5px">
            </table>
            </fieldset>
        </div>
        <br />
        
        <div>
            指定的操作员：<select id="DDL_SpecOperWay" name="DDL_SpecOperWay" onchange="selChange()">
                <option selected="selected" value="0">当前操作员</option>
                <option value="1">指定节点的操作员</option>
                <option value="2">指定表单字段作为操作员</option>
                <option value="3">指定操作员编号</option>
            </select>
            <input type="hidden" name="initDDL_SpecOperWay" id="initDDL_SpecOperWay" value=" " />
            <input type="hidden" name="initTB_SpecOperPara" id="initTB_SpecOperPara" value=" " />
            <br />
            <br />            
            <span class="lbls">
                <span id="span0">参数：</span>
                <span id="span1" style="display: none">节点编号：</span>
                <span id="span2" style="display: none">表单字段：</span>
                <span id="span3" style="display: none">操作员编号：</span>
            </span>
            <input id="TB_SpecOperPara" name="TB_SpecOperPara" type="text" disabled="disabled" style="width: 200px;" />&nbsp;&nbsp;多个值请用英文“逗号”来分隔。
            <br />
            <a class="btn" href="javascript:Btn_Save_Click();">保存</a>&nbsp;&nbsp; 
            <a class="btn" href="javascript:Btn_Delete_Click();">删除</a>
            
        </div>
    </div>
    </form>
</body>
</html>
