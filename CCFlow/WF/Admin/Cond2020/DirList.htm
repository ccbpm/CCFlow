<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>方向条件</title>
    <script type="text/javascript" src="../../Scripts/bootstrap/js/jquery.min.js"></script>
    <script type="text/javascript" src="../../Scripts/bootstrap/js/bootstrap.min.js"></script>
    <script src="../../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../../Scripts/config.js" type="text/javascript"></script>
    <script src="../../Comm/Gener.js" type="text/javascript"></script>
    <script src="../Admin.js" type="text/javascript"></script>

    <link href="../../Scripts/easyUI/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../../Scripts/easyUI/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../../Scripts/easyUI/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../../Scripts/EasyUIUtility.js" type="text/javascript"></script>
    <link href="../../../DataUser/Style/ccbpm.css" rel="stylesheet" type="text/css" />
    <base target="_self" />
    <style type="text/css">
        caption {
            text-align: left;
            font-family: 'Microsoft YaHei';
            font-weight: bolder;
            border-bottom: none;
            margin-bottom: 10px;
        }
        #state li
        {
            list-style:none;
        }
        #state1 li
        {
            list-style:none;
        }
    </style>
    <script type="text/javascript">
        //获得变量.
        var flowNo = GetQueryString("FK_Flow");
        var nodeID = GetQueryString("FK_Node");
        var toNodeID = GetQueryString("ToNodeID");
        var condType = GetQueryString("CondType");
        var dir = null;
        //初始化页面函数.....
        $(function () {

            $("#table").html("");
            if (condType == null || condType == undefined)
                condType = 0; //默认为方向条件.

            //组合PK.
            var dirMyPK = flowNo + "_" + nodeID + "_" + toNodeID;
            //alert(dirMyPK + "a");
            dir = new Entity("BP.WF.Template.Direction", dirMyPK);
            //alert(cond.CondExpModel);

            //设置radion 选择的值。
            $("input:radio[value=" + dir.CondExpModel + "]").attr('checked', 'true');

            //  $("input:radio[value='" + cond.CondExpModel + "']").attr('checked', 'true');

            //查询出来所有的条件方向条件.
            var conds = new Entities("BP.WF.Template.Conds");
            conds.Retrieve("FK_Node", nodeID, "ToNodeID", toNodeID, "CondType", 2, "Idx");

            var toNode = new Entity("BP.WF.Node", toNodeID);
            html = "<table class='table table-striped table-bordered table-hover table-condensed' style='width:98%;'>";

            html += "<caption><img src='../../Img/Event.png' />到达节点[<font color=green>" + toNode.NodeID + " " + toNode.Name + "</font>]的方向条件</caption>";
            html += "<br>";
            html += "<tr>";
            html += "<th>序</th>";
            html += "<th>类型</th>";
            html += "<th>表达式</th>";
            html += "<th>移动</th>";
            html += "<th>删除</th>";
            html += "</tr>";
            //循环生成表格.
            var idx = 1;
            for (var i = 0; i < conds.length; i++) {

                var cond = conds[i];

                //是混合运算就过滤
                if (dir.CondExpModel != 2 && cond.DataFrom == 100) {
                    continue;
                }


                html += "<tr >";
                html += "<td class=Idx>" + idx + "</td>";
                html += "<td>" + ShowType(cond.DataFrom) + "</td>"; //类型
                html += "<td>" + cond.AttrKey + cond.FK_Operator + cond.OperatorValue + "</td>";//表达式 "  " " +  + " " + en.OperatorValue;
                html += "<td>";
                html += " - <a class='btn btn-default btn-sm' href=\"javascript:Up('" + cond.MyPK + "')\"><img src='../../Img/Btn/Up.gif' border=0 />上移</a>";
                html += " - <a class='btn btn-default btn-sm' href=\"javascript:Down('" + cond.MyPK + "')\"><img src='../../Img/Btn/Up.gif' border=0 />下移</a>";
                html += "<td>";
                html += "<a  href=\"javascript:DeleteIt('" + cond.MyPK + "')\"><img src='../../Img/Btn/Delete.gif' border=0 />删除</a>";
                html += "</tr>";

                idx++;
            }
            html += "</table>";
            $("#table").html(html);


            //新建运算符按钮的显示和隐藏
            $("#condBtn").hide();

            if (dir.CondExpModel == 2) {

                $("#condBtn").show();

                var data = conds.DoMethodReturnString("DoCheck");
                //alert(data);
               // $("#checkInfo").html(data);
            }

        });

        function ShowType(DataFrom) {
            var res = "";
            switch (DataFrom) {
                case 0: res = "表单字段";
                    break;
                case 1: res = "独立表单";
                    break;
                case 2: res = "按岗位";
                    break;
                case 3: res = "按部门";
                    break;
                case 4: res = "按SQL";
                    break;
                case 5: res = "按SQL模板";
                    break;
                case 6: res = "按参数";
                    break;
                case 7: res = "按URL";
                    break;
                case 100: res = "运算符";
                    break;
            }
            return res;
        }
        

        //执行删除..
        function DeleteIt(mypk) {
            if (window.confirm('您确定要删除吗？') == false)
                return;
            var en = new Entity("BP.WF.Template.Cond");
            en.SetPKVal(mypk);
            en.Delete();
            window.location.href = window.location.href;
            return;
        }
        function Up(mypk) {
            var en = new Entity("BP.WF.Template.Cond");
            en.SetPKVal(mypk);
            en.Retrieve();
            var data = en.DoMethodReturnString("DoUpDirCond");
            window.location.href = window.location.href;
            return;
        }
        function Down(mypk) {
            var en = new Entity("BP.WF.Template.Cond");
            en.SetPKVal(mypk);
            en.Retrieve();
            var data = en.DoMethodReturnString("DoDownDirCond");
            window.location.href = window.location.href;
            return;
        }

        /*隐藏与显示.*/
        function ShowHidden(ctrlID) {

            var ctrl = document.getElementById(ctrlID);

            ctrl.style.display = 'block';

            document.onmouseup = function () {

                ctrl.style.display = "none";
            }
        }

        function NewCond(type) {

            var url = window.location.href;
            url = url.replace('DirList.htm', type + '.htm');
            var inputs = document.getElementsByName("CondExpModel");
            var model;
            for (var i = 0; i < inputs.length; i++) {
                input = inputs[i];
                if (input.checked) {
                    model = input.value;
                    break;
                }
            }
            url += "&CondOrAnd=" + model

            window.location.href = url;
        }
        //添加运算符
        function AddCond(condExp) {

            var en = new Entity("BP.WF.Template.Cond");
            //生成一个随机数添加到运算符的主键中
            var radomNum = parseInt(Math.random() * 1000) + 1;
            en.SetPKVal(flowNo + "_" + nodeID + "_" + radomNum);
            en.CondType = 2;
            en.DataFrom = 100; //运算符.
            en.FK_Flow = flowNo;
            en.FK_Node = nodeID;
            en.FK_Operator = condExp;
            en.ToNodeID = toNodeID;
            en.FK_Operator = condExp;
            en.CondOrAnd = 2; //带运算符的是混合模式
            en.Insert();

            window.location.href = window.location.href;
        }
        //选择模式
        function SelectModel(model) {

            //组合PK.
            var dirMyPK = flowNo + "_" + nodeID + "_" + toNodeID;
            //alert(dirMyPK + "a");
            cond = new Entity("BP.WF.Template.Direction", dirMyPK);
            cond.CondExpModel = model;
            cond.Update();

            window.location.href = window.location.href;
            //LoadPage(model);
        }
    </script>

</head>
<body>

    <div style="right:30px; position:absolute; z-index:100; ">
        
        运算模式：
        <label><input type="radio" value="0" id="CondExpModel0" name="CondExpModel" onclick="SelectModel(0)" />Or模式</label>
        <label><input type="radio" value="1" id="CondExpModel1" name="CondExpModel" onclick="SelectModel(1)" />And模式</label>
        <label><input type="radio" value="2" id="CondExpModel2" name="CondExpModel" onclick="SelectModel(2)" />混合模式</label>
        <br>
        <input type="button" value="+新建条件" onclick="ShowHidden('state')" />
        <div id="state" style="position:absolute; z-index:10;background-color:white; border:1px outset black; display: none; color: Gray; right:115px; ">
            <ul>
                <li><a href="javascript:NewCond('CondByFrm');">按表单条件计算</a> </li>
                <li><a href="javascript:NewCond('StandAloneFrm');">按已选择的独立表单条件计算</a> </li>
                <li><a href="javascript:NewCond('CondStation');">按指定操作员的岗位条件</a></li>
                <li><a href="javascript:NewCond('CondDept');">按指定操作员的部门条件</a> </li>
                <li><a href="javascript:NewCond('CondBySQL');">按SQL条件计算</a> </li>
                <li><a href="javascript:NewCond('CondBySQLTemplate');">按SQL模版条件计算</a> </li>
                <li><a href="javascript:NewCond('CondByPara');">按开发者参数计算</a> </li>
                <li><a href="javascript:NewCond('CondByUrl');">按Url条件计算</a> </li>
            </ul>
        </div>

        <input id="condBtn" type="button" value="+新建运算符" onclick="ShowHidden('state1')" />
        <div id="state1" style="position:absolute; z-index:10;background-color:white; border:1px outset black; display: none; color: Gray;right:80px;">
            <ul>
                <li><a href="javascript:AddCond('(');"> ( 左括号 &nbsp;&nbsp;&nbsp;&nbsp; </a> </li>
                <li><a href="javascript:AddCond(')');"> ) 右括号&nbsp;&nbsp;&nbsp;&nbsp;</a> </li>
                <li><a href="javascript:AddCond('AND');"> AND 并且&nbsp;&nbsp;&nbsp;&nbsp;</a> </li>
                <li><a href="javascript:AddCond('OR');"> OR 或者&nbsp;&nbsp;&nbsp;&nbsp;</a> </li>
            </ul>
        </div>
        <!--<input type="button" value="什么是条件？" onclick="javascript:Help()" />-->
    </div>


    <div style="position:relative;" id="table">
    </div>


    <div id="checkInfo"></div>

</body>
</html>