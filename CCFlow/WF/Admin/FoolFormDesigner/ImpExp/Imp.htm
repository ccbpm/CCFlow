<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <!--<link  href="./../Style/Table0.css" rel="stylesheet" type="text/css" />-->

    <link href="../../../Scripts/easyUI15/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    
    <style type="text/css">
        .style1
        {
            width: 105px;
        }
        #Text4
        {
            width: 447px;
        }
        #TB_Addr
        {
            width: 450px;
        }

        .panel-body-noborder {
        text-align:center;
        }

        #ulNodeFrmImp {
            list-style: none;
            padding: 0px;
        }

        #ulNodeFrmImp li{
        width:100%;
        padding:0px;
        }
    </style>

    <title>表单导入</title>

    <script language="JavaScript" src="../../../Comm/JScript.js" type="text/javascript" ></script>
    <script type="text/javascript" src="../../../Scripts/bootstrap/js/jquery.min.js"></script>
    <script src="../../../Scripts/easyUI15/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../../../Scripts/QueryString.js" type="text/javascript"></script>

    <!-- 引用通用的js文件. -->
    <script type="text/javascript" src="../../../Comm/Gener.js"></script>
    <script type="text/javascript" src="../../../Scripts/config.js"></script>
    <script type="text/javascript" language="javascript" >

        console.log(window.parent);

        //页面启动函数.
        var frmID = GetQueryString("FK_MapData");
        var flowNo = GetQueryString("FK_Flow");
        var nodeID = GetQueryString("FK_Node");

        $(function () {

            if (flowNo == null) {
                //如果当前不是节点表单 就隐藏节点表单导入
                // $('#divUlNodeFrmImp').hide();
            }

            $("#Msg").html("<img src=../../../Img/loading.gif />&nbsp;正在加载,请稍后......");

            /*
            *  首先要把初始化控件的代码写入到这里,不然会导致界面的批量赋值失败.
            */

            $.ajax({
                type: 'post',
                async: true,
                url: Handler + "?DoType=Imp_Init&FK_MapData=" + frmID + "&FK_Node=" + nodeID + "&FK_Flow=" + flowNo + "&m=" + Math.random(),
                dataType: 'html',
                success: function (db) {

                    if (db.indexOf("err@") > -1) {
                        alert(db);
                        return;
                    }

                    db = JSON.parse(db);

                    //02.节点表单.
                    var nodes = db["WF_Node"];
                    var ulHtml = '';
                    for (var i = 0; i < nodes.length; i++) {
                        var node = nodes[i];

                        if (node.NodeID == nodeID)
                            continue;
                        ulHtml += '<li><input id="nd' + node.NodeID + '" type="radio" name="node" class="btn btn-default" data-nodeid=' + node.NodeID + '><label for="nd' + node.NodeID + '">ID:' + node.NodeID + ' - ' + node.Name + '<label/></li>'
                    }

                    $('#ulNodeFrmImp').html(ulHtml);

                    //03.表单库
                    var treedata = db["Sys_FormTree"],
                        rootdata = $.grep(treedata, function (item) {
                            return item.PARENTNO == "0";
                        })[0];

                    //构建树节点数据
                    var root = {};
                    root.text = rootdata.NAME;
                    root.state = "open";
                    root.children = [];
                    $.grep(treedata, function (item) {
                        //选出一级节点
                        return item.PARENTNO == "1";
                    }).forEach(function (folder) {
                        //构建node开始
                        var node = {};
                        node.text = folder.NAME;
                        node.state = "closed";
                        node.children = [];
                        $.grep(db["Sys_MapData"], function (map) {
                            //选出当前节点的二级节点
                            return 'ND' + map.FK_FormTree == folder.Column1;

                        }).forEach(function (frm) {
                            node.children.push({
                                text: frm.Name,
                                id:frm.No
                            });
                        });
                        //构建node结束
                        root.children.push(node);
                    });

                    $('#ulLib').tree({
                        data: [root],
                        onSelect: function (node) {
                            if (node.children == undefined) {
                                btnFrmLib.disabled= "";
                                selFrmNode.value = node.id;
                            }else{
                                btnFrmLib.disabled= "disabled";                            
                            }
                        } 
                    });
                }
            });

            //加载完成.
            $("#Msg").html("");
        });
    </script>

    <script type="text/javascript" >
        function addTab(title, url) {
            if ($('#tt').tabs('exists', title)) {
                $('#tt').tabs('select', title);
            } else {
                var content = '<iframe scrolling="auto" frameborder="0"  src="' + url + '" style="width:100%;height:100%;"></iframe>';
                $('#tt').tabs('add', {
                    title: title,
                    content: content,
                    closable: true
                });
            }
        }

        //从一个节点导入.
        function CopyFromNodeFrm() {
            var nodeId = $('#ulNodeFrmImp input:checked').data().nodeid;
            $.ajax({
                type: 'post',
                async: true,
                url: Handler + "?DoType=Imp_CopyFrm&FK_MapData=" + frmID + "&FromMapData=ND" + nodeId + "&" + $('#formCC').serialize() + "&m=" + Math.random(),
                dataType: 'html',
                success: function (data) {

                    if (data.indexOf('err@') == 0) {
                        alert(data);
                        return;
                    }

                    alert(data + '\t\n 如果父页面不能刷新，请关闭当前表单设计器重新打开.');
                    window.parent.location.href = window.parent.location.href;

                }
            });
        }


        function SaveImpFromLocalXML() {

            var formData = new FormData();
            var name = $("input").val();
            formData.append("file", $("#localXmlFile")[0].files[0]);
            formData.append("name", name);
            $.ajax({
                url: Handler + "?DoType=Imp_LoadFrmTempleteFromLocalFile&FK_MapData=" + frmID + "&FK_Node=" + GetQueryString("FK_Node") + "&FK_Flow=" + flowNo + "&m=" + Math.random(),
                type: 'POST',
                data: formData,
                // 告诉jQuery不要去处理发送的数据
                processData: false,
                // 告诉jQuery不要去设置Content-Type请求头
                contentType: false,
                beforeSend: function () {

                },
                success: function (data) {

                    if (data.indexOf('err@')==0) {
                        alert(data);
                        return;
                    }

                    alert(data +'\t\n 如果父页面不能刷新，请关闭当前表单设计器重新打开.');
                    window.parent.location.href = window.parent.location.href;
                },
                error: function (data) {
                    alert("系统错误:" + data);
                    return;
                }
            });
        }

        function SaveImpFromLib() {

            var nodeId = selFrmNode.value;
            $.ajax({
                type: 'post',
                async: true,
                url: Handler + "?DoType=Imp_CopyFrm&FK_MapData=" + frmID + "&FromMapData=" + nodeId + "&" + $('#formCC').serialize() + "&m=" + Math.random(),
                dataType: 'html',
                success: function (data) {

                    if (data.indexOf('err@') == 0) {
                        alert(data);
                        return;
                    }

                    alert(data + '\t\n 如果父页面不能刷新，请关闭当前表单设计器重新打开.');
                    window.parent.location.href = window.parent.location.href;

                }
            });
        }
    </script>
</head>
<body>
    <form id="formCC" method="post" enctype="multipart/form-data">
    <div id="Msg"> </div>
    <div id="tt" class="easyui-tabs" style="width:100%;height:auto;padding:0px;">
        <div title="从本机导入" style="">
            <div style="text-align:left;padding:15px;">

            <fieldset>
            <legend>选择表单模板文件(*.xml),然后按确定按钮 </legend>

            <ul>
            <li>选择的模版文件必须是本机导出的，格式为 .xml 的文件. </li>
            </ul>
                 <label style="padding-left:8px;"></label><br /><br />
                <input type="file" id="localXmlFile" name="localXmlFile" />
                 <input type="button" value="模板导入" onclick="SaveImpFromLocalXML()" />
            </fieldset>

            </div>

            </div>
        <div title="从节点表单导入" id="divUlNodeFrmImp" style="padding:15px; text-align:left ">
            <fieldset>
                <legend>请选择一个节点表单</legend>
                
                <!-- 节点表单列表 -->
                <ul id="ulNodeFrmImp"></ul>
                <hr />

                <input type="checkbox" checked="checked" id="ckClear" name="IsClear" disabled="true" /> <label for="ckClear">是否清除现在已有的元素</label>
                <input type="checkbox" checked="checked" id="ckReadOnly" name="IsSetReadonly" /><label for="ckReadOnly">是否只读</label>
                <input type="button" value="执行从节点表单导入22" onclick="CopyFromNodeFrm()" id="copyFromFrmNodeSave" />
            </fieldset>
        </div>

        <div title="从表单库导入" id="divUlFrmTreeImp" style="padding:15px; text-align:left">        
          <ul id="ulLib" style="height:auto;"></ul>
          <input type="hidden" value="" id="selFrmNode" name="selFrmNode" />
          <input type="button" value="表单库导入" id="btnFrmLib" onclick="SaveImpFromLib()" style="margin:25px;" disabled="disabled"/>
        </div>
s
        <div title="从外部数据源导入" style="padding:15px; text-align:left">

          <fieldset>
        <legend>在施工中，敬请期待.</legend>
        <ul>
        <li> 1，选择表单库的一个表单。 </li>
        <li> 2，执行表单的导入。 </li>
        </ul>
        </fieldset>

        <!--    <label style="padding-left:8px;">操作提示：制定内外部数据源中的一个已经设计好的表，把字段信息导入该表单中</label><br /><br />
            <input type="button" class="btn btn-default" value="进入导入数据表字段向导" />-->
        </div>
    </div>
</form>
    <!--<ul id="myTab" class="nav nav-tabs">
        <li class="active">
            <a href="#localImp" data-toggle="tab">从本机导入</a>
        </li>
        <li><a href="#nodeFrmImp" data-toggle="tab">从节点表单导入</a></li>
        <li><a href="#frmClassImp" data-toggle="tab">从表单库导入</a></li>
        <li><a href="#outDataSourceImp" data-toggle="tab">从外部数据源导入</a></li>
    </ul>
    <div id="" class="tab-content">
        <!--从本机导入-->
        <!--<div class="tab-pane fade in active" id="localImp">
            <input type="button" class="btn btn-default" value="进入templete.ccflow.org执行导入" />
        </div>-->
        <!--从节点表单导入-->
        <!--<div class="tab-pane fade in" id="nodeFrmImp">
            选择表单模板文件(*.xml),然后按确定按钮
            <input type="file" />
        </div>-->
        <!--从表单库导入-->
        <!--<div class="tab-pane fade in" id="frmClassImp">
            <ul class="nav nav-pills nav-stacked">
                <li role="presentation"><a href="#">Step1 节点1</a></li>
                <li role="presentation" class="active"><a href="#">Step2 节点2</a></li>
                <li role="presentation"><a href="#">Step3 节点3</a></li>
            </ul>
        </div>-->
        <!--从外部数据源导入-->
        <!--<div class="tab-pane fade in" id="outDataSourceImp">
            <label>操作提示：制定内外部数据源中的一个已经设计好的表，把字段信息导入该表单中</label>
            <input type="button" class="btn btn-default"value="进入导入数据表字段向导"/>
        </div>
    </div>-->
</body>
</html>
 