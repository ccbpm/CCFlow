<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>设置查询条件</title>
    <link href="../../../Scripts/easyUI145/themes/icon.css" rel="stylesheet" type="text/css" />
    <link href="../../../Scripts/easyUI145/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../../../../DataUser/Style/ccbpm.css" rel="stylesheet" type="text/css" />
    <script src="../../../Scripts/easyUI145/jquery.min.js" type="text/javascript"></script>
    <script src="../../../Scripts/easyUI145/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../../../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../../../Scripts/config.js" type="text/javascript"></script>
    <script src="../../../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../../../Comm/Gener.js" type="text/javascript"></script>
    <script src="DDLBar.js" type="text/javascript"></script>
    <script src="../../EnumLab.js"></script>
    <script src="../../../Admin/Admin.js"></script>

    <script language="javascript" type="text/javascript">

        var frmID = GetQueryString("FrmID");

        //页面启动函数.
        $(function () {

            $("#Msg").html("<img src=../../../Img/loading.gif />&nbsp;正在加载,请稍后......");

            InitBar("SearchCond");

            InitPage();

            $("#Msg").html("");

        });

        function InitPage() {

            var mapAttrs = new Entities("BP.Sys.MapAttrs");
            mapAttrs.Retrieve("FK_MapData", frmID,"GroupID,Idx");

            var mapData = new Entity("BP.Sys.MapData", frmID);

            var isSearchKey = mapData.GetPara("IsSearchKey") == "1" ? true : false;
            document.getElementById("CB_Key_0").checked = isSearchKey;

            document.getElementById("CB_Key_1").checked = isSearchKey == true ? false : true;

            var StringSearchKeys = mapData.GetPara("StringSearchKeys");
            var RptSearchKeys = mapData.GetPara("RptSearchKeys");
            var DTSearchWay = mapData.GetPara("DTSearchWay");
            var DTSearchKey = mapData.GetPara("DTSearchKey");

            //绑定外键字段.
            var dateMapAttrs = [];
            var count = 0;

            var htmlFKeys = "<table>";
            htmlFKeys += "<tr>";
            htmlFKeys += "<th>字段</th>";
            htmlFKeys += "<th>展示方式</th>";
            htmlFKeys += "<th>填充</th>";
            htmlFKeys += "<th>级联关系</th>";
            htmlFKeys += "</tr>";

            for (var i = 0, length = mapAttrs.length; i < length; i++) {

                var attr = mapAttrs[i];
                if (attr.MyDataType == 6 || attr.MyDataType == 7) {
                    dateMapAttrs.push(attr);
                    continue;
                }

                if (attr.UIVisible == 0) {
                    continue;
                }
                //文本字段
                if (attr.MyDataType == 1 && attr.UIContralType == 0) {
                    count++;
                    flag = false;
                    if (StringSearchKeys) {
                        flag = (StringSearchKeys.indexOf("*" + attr.KeyOfEn + ",") != -1);
                    }

                    $("#StringKeys").append("<input type='checkbox' " + (flag ? "checked = 'checked'" : "") + " id='" + attr.KeyOfEn + "'  data-name='" + attr.Name + "'/><label for='" + attr.KeyOfEn + "' >" + attr.Name + "(" + attr.KeyOfEn + ")</label>&nbsp;&nbsp;&nbsp;");
                    if (count == 3) {
                        $("#StringKeys").append("<br/>");
                        count = 0;
                    }
                    continue;
                }
                if (attr.UIBindKey == "") {
                    continue;
                }

                flag = false;
                if (RptSearchKeys) {
                    flag = (RptSearchKeys.indexOf("*" + attr.KeyOfEn + "*") != -1);
                }

                htmlFKeys += "<tr>";
                htmlFKeys += "<td>";
                htmlFKeys += "   <input type='checkbox' " + (flag ? "checked = 'checked'" : "") + " id='" + attr.KeyOfEn + "' /><label for='" + attr.KeyOfEn + "' >" + attr.Name + "(" + attr.KeyOfEn + ")</label>";
                htmlFKeys += "</td>";

                htmlFKeys += "<td>";
                htmlFKeys += "<select id=''>";
                htmlFKeys += "<option value=0>下拉框展示</option>";
                htmlFKeys += "<option value=1>平铺展示</option>";
                htmlFKeys += "</select>";
                htmlFKeys += "</td>";

                htmlFKeys += "<td>";
                htmlFKeys += "<a href=\"javascript:ActiveDDLFull('" + attr.KeyOfEn + "');\" >数据权限</a>";
                htmlFKeys += "</td>";

                htmlFKeys += "<td>";
                htmlFKeys += "<a href=\"javascript:ActiveDDL('" + attr.KeyOfEn + "');\" >级联关系</a>";

                htmlFKeys += "</td>";

                htmlFKeys += "</tr>";

                //   $("#FKeys").append("<input type='checkbox' " + (flag ? "checked = 'checked'" : "") + " id='" + attr.KeyOfEn + "' /><label for='" + attr.KeyOfEn + "' >" + attr.Name + "(" + attr.KeyOfEn + ")</label></br>");
            }
            $("#FKeys").html(htmlFKeys); //("<input type='checkbox' " + (flag ? "checked = 'checked'" : "") + " id='" + attr.KeyOfEn + "' /><label for='" + attr.KeyOfEn + "' >" + attr.Name + "(" + attr.KeyOfEn + ")</label></br>");


            $("#DDL_DTSearchWay").val(DTSearchWay);

            //绑定日期下拉框.
            if (dateMapAttrs != null) {
                GenerBindDDL("DDL_DTSearchKey", dateMapAttrs, "KeyOfEn", "Name", DTSearchKey);
            }
            var hidenField = mapData.GetPara("HidenField");
            while (hidenField && hidenField.indexOf("[%]") != -1)
                hidenField = hidenField.replace("[%]", "%");
            $("#TB_HidenField").val(hidenField);
            var DTShowWay = mapData.GetPara("DTShowWay");
            DTShowWay = DTShowWay == null || DTShowWay == undefined || DTShowWay == "" ? 0 : DTShowWay;
            $("#DDL_DTShowWay").val(DTShowWay);
        }

        function ActiveDDL(key) {
            var url = "./SearchCond/ActiveDDL.htm?FK_MapData=" + GetQueryString("FrmID") + "&KeyOfEn=" + key;
            window.open(url);
        }
        function ActiveDDLFull(key) {
            var url = "./SearchCond/ActiveDDLFull.htm?FK_MapData=" + GetQueryString("FrmID") + "&KeyOfEn=" + key;
            window.open(url);
        }

        function Save() {

            var mapData = new Entity("BP.Sys.MapData", frmID);
            var IsSearchKey = document.getElementById("CB_Key_0").checked ? 1 : 0;
            mapData.SetPara("IsSearchKey", IsSearchKey);

            mapData.SetPara("DTSearchWay", document.getElementById("DDL_DTSearchWay").value);
            mapData.SetPara("DTSearchKey", document.getElementById("DDL_DTSearchKey").value);
            mapData.SetPara("DTSearchLabel", $("#DDL_DTSearchKey").find("option:selected").text());
            var hidenField = $("#TB_HidenField").val();

            hidenField = hidenField.replace(/%/g, '[%]');
            mapData.SetPara("HidenField", hidenField);

            var fields = "";
            var oChecks = document.getElementById("FKeys").getElementsByTagName("input");
            for (var i = 0, len = oChecks.length; i < len; i++) {
                var item = oChecks[i];
                if (item.checked) {
                    fields += "*" + item.id;
                }
            }

            if (fields == "") {
                mapData.SetPara("RptSearchKeys", "");
            } else {
                mapData.SetPara("RptSearchKeys", fields + "*");
            }

            fields = "";
            oChecks = document.getElementById("StringKeys").getElementsByTagName("input");
            for (var i = 0, len = oChecks.length; i < len; i++) {
                var item = oChecks[i];
                if (item.checked) {
                    fields += "*" + item.id + "," + item.getAttribute("data-name");
                }
            }

            if (fields == "") {
                mapData.SetPara("StringSearchKeys", "");
            } else {
                mapData.SetPara("StringSearchKeys", fields + "*");
            }
            mapData.SetPara("DTShowWay", $("#DDL_DTShowWay").val());
            mapData.Update();
            window.location.href = window.location.href;
        }

        function changeStringKeysState(val) {
            if (val == 0) {
                $("#StringKeys input[type=checkbox]").attr("disabled", 'disabled');
                $("#StringKeys input[type=checkbox]").removeAttr("checked");
            }
            if (val == 1) {
                $("#StringKeys input[type=checkbox]").removeAttr("disabled");
            }
        }
    </script>
    <base target="_self" />
</head>
<body>
    <form id="cc">
        <div id="bar">
        </div>
        <fieldset>

            <legend>
                <label><input type="radio" name="CB_Key" id="CB_Key_0" value="0" onchange="changeStringKeysState(this.value)" />是否增加关键字查询</label>
            </legend>
            <ul>
                <li> 关键字查询是接受用户输入一个关键字，在整个报表的显示列中使用like查询(外键、枚举、数值类型的除外)</li>
                <li> 关键字搜索提示, 默认为:请输入关键字... </li>
                <li>
                    <input id="TB_Alert" name="TB_Alert" type="text" value="" placeholder="例如：请输入电话、地址等关键字..." style="width:300px;" />
                </li>
            </ul>

            <legend>
                <label><input type="radio" name="CB_Key" id="CB_Key_1" value="1" onchange="changeStringKeysState(this.value)" />是否增加特定字段的查询</label>
            </legend>

            <ul>
                <li>选择特定字段，在报表中根据 like 模糊查询 </li>
            </ul>

            <div id="StringKeys" style="margin-left:15px"> </div>

            <legend>  外键与枚举 </legend>

            <div id="FKeys"></div>

            <legend>  时间段的查询</legend>

            <table>
                <tr>
                    <td> 选择方式</td>
                    <td>
                        <select name="DDL_DTSearchWay" id="DDL_DTSearchWay">
                            <option selected="selected" value="0">不启用</option>
                            <option value="1">按日期</option>
                            <option value="2">按日期时间</option>
                        </select>
                    </td>
                    <td> 字段</td>
                    <td>
                        <select name="DDL_DTSearchKey" id="DDL_DTSearchKey">
                        </select>
                    </td>

                    <td> 显示方式</td>
                    <td>
                        <select name="DDL_DTShowWay" id="DDL_DTShowWay">
                            <option selected="selected" value="0">字段方式（日期从，到）</option>
                            <option value="1">日期Tab页（月份、季度、年度）</option>
                            <option value="2">日期Tab页（月份、季度、年度、自定义）(未解析)</option>
                        </select>
                    </td>
                </tr>
            </table>

            <legend>  增加隐藏查询条件</legend>

            <ul>
                <li> 单个条件：<font color="green"> WFState=1</font>  多个条件：<font color="green"> WFState=1 AND Starter=@WebUser.No</font></li>
                <li> 支持@+表达式变量.</li>
            </ul>

            <input id="TB_HidenField" name="TB_HidenField" type="text" value="" placeholder="例如: WFState=1 AND Starter=@WebUser.No " style="width:98%" />


            <legend>帮助  </legend>

            <img src="SearchCond.png" class="HelpImg" />
        </fieldset>

    </form>
</body>
</html>
