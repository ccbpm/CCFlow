<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>SQL模式</title>


    <link rel="stylesheet" href="../../../../Scripts/CodeMirror/doc/docs.css" />
    <link rel="stylesheet" href="../../../../Scripts/CodeMirror/lib/codemirror.css" />
    <link rel="stylesheet" href="../../../../Scripts/CodeMirror/theme/eclipse.css" />
    <link rel="stylesheet" href="../../../../Scripts/CodeMirror/theme/elegant.css" />
    <link rel="stylesheet" href="../../../../Scripts/CodeMirror/theme/erlang-dark.css" />
    <link rel="stylesheet" href="../../../../Scripts/CodeMirror/theme/idea.css" />
    <script src="../../../../Scripts/CodeMirror/lib/codemirror.js"></script>
    <script src="../../../../Scripts/CodeMirror/mode/javascript/javascript.js" type="text/javascript"></script>
    <script src="../../../../Scripts/CodeMirror/addon/selection/active-line.js" type="text/javascript"></script>
    <script src="../../../../Scripts/CodeMirror/addon/edit/matchbrackets.js" type="text/javascript"></script>

    <link href="../../../../Scripts/easyUI145/themes/icon.css" rel="stylesheet" type="text/css" />
    <link href="../../../../Scripts/easyUI145/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../../../../../DataUser/Style/ccbpm.css" rel="stylesheet" type="text/css" />
    <script src="../../../../Scripts/easyUI145/jquery.min.js" type="text/javascript"></script>
    <script src="../../../../Scripts/easyUI145/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../../../../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../../../../Scripts/config.js" type="text/javascript"></script>
    <script src="../../../../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../../../../Comm/Gener.js" type="text/javascript"></script>
    <script src="DDLBar.js" type="text/javascript"></script>

    <link href="../../../../Style/skin/adminfont/iconfont.css" rel="stylesheet" />
    <link href="../../../../Style/skin/css/Default.css" rel="stylesheet" />

    <script type="text/javascript">

     
        function Esc() {
            if (event.keyCode == 27)
                window.close();
            return true;
        }

        window.addEventListener("keydown", function (e) {
            //可以判断是不是mac，如果是mac,ctrl变为花键
            //event.preventDefault() 方法阻止元素发生默认的行为。
            if (e.keyCode == 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
                e.preventDefault();
                Save();
                // Process event...
                //document.getElementById("test").innerHTML = "ctrl+s成功";
            }
        }, false);

        function Save() {

            //设置sql模式.
            en.MethodDocTypeOfFunc = 0;

            var txt = editor.getValue();
            if (docsLast != null && docsLast != txt) {
                // if (window.confirm('您需要保存吗？') == true) {

                //返回上一次的设置.
                document.getElementById("RB_MethodDocTypeOfFunc_" + currFuncType).checked = true;
                Save(); //执行保存.
                document.getElementById("RB_MethodDocTypeOfFunc_" + funcType).checked = true;
                //}
            }

            //设置当前的状态.
            currFuncType = funcType;

            //根据选择获取变化内容.
            var handler = new HttpHandler("BP.CCBill.WF_CCBill_Admin");
            handler.AddPara("TypeOfFunc", funcType);
            handler.AddPara("No", en.No);
            var data = handler.DoMethodReturnString("MethodDoc_GetScript");

            editor.setValue(data);
            docsLast = data; //记录最后的值，用于判断是否更改.
        }
        //页面启动函数.
        var en = null;
        var docsLast = null; //最后的code内容，用于判断是否发生了变化？
        var currFuncType = 0;
        var funcstr = "";
        $(function () {

            InitBar(0); //SQL模式.

            var no = GetQueryString("No");
            en = new Entity("BP.CCBill.Template.MethodFunc", no);

          //  GenerBindEnumKey("DDL_WhatAreYouTodo", "WhatAreYouTodo", en.WhatAreYouTodo);

            //给控件赋值.
            //GenerFullAllCtrlsVal(en);

            //设置内容.
            var handler = new HttpHandler("BP.CCBill.WF_CCBill_Admin");
            handler.AddPara("TypeOfFunc", 0);
            handler.AddPara("No", en.No);
            var data = handler.DoMethodReturnString("MethodDoc_GetScript");
            editor.setValue(data);

            //生成参数内容.
            var attrs = new Entities("BP.Sys.MapAttrs", "FK_MapData", no);
            var html = "<font color=yellow ><b>//自定义方法名:" + en.Name + ",共有:" + attrs.length + "参数;&nbsp;";

            for (var i = 0; i < attrs.length; i++) {
                var attr = attrs[i];
                html += "" + attr.Name + "," + attr.KeyOfEn + ";&nbsp;";
            }

            html += "</b></font>";

            html += "<br><font color=yellow ><b> function </b></font> <font color=red ><b>" + en.MethodID + "</b></font> <font color=yellow ><b>(</b></font>";
            funcstr = "function " + en.MethodID + "(";
            for (var i = 0; i < attrs.length; i++) {
                var attr = attrs[i];
                if (i == attrs.length - 1) {
                    html += "<font color=PINK ><b>&nbsp;" + attr.KeyOfEn + "</b></font>";
                    funcstr += attr.KeyOfEn;
                } else {
                    html += "<font color=PINK ><b>&nbsp;" + attr.KeyOfEn + "</b></font><font color=yellow ><b>,</b></font>";
                    funcstr += attr.KeyOfEn + ",";
                }
            }

            html += "<font color=yellow ><b>)</b></font>&nbsp;<font color=yellow font-size='12px'><b>{</b></font>";
            funcstr += "){";
            $("#paras").html(html);


            //输出实体的其他信息，方便用户更改.
            var attrs = new Entities("BP.Sys.MapAttrs", "FK_MapData", en.FrmID);

            var mapData = new Entity("BP.Sys.MapData", en.FrmID);

            html = "<table style='width:100%;'>";
            html += "<caption>表单:" + mapData.Name + ",表单ID:" + mapData.No + ",表:" + mapData.PTable + "</caption>";
            html += "<tr>";
            html += "<th>#</th>";
            html += "<th>字段</th>";
            html += "<th>字段名</th>";
            html += "<th>类型</th>";
            html += "</tr>";

            for (var i = 0; i < attrs.length; i++) {
                var attr = attrs[i];
                html += "<tr>";
                html += "<td>" + (i + 1) + "</td>";
                html += "<td>" + attr.KeyOfEn + "</td>";
                html += "<td>" + attr.Name + "</td>";
                html += "<td>" + attr.MyDataType + "</td>";
                html += "</tr>";
            }
            html += "</table>";

            html += "UPDATE " + mapData.PTable + " SET xxx=xx,XXX=11 WHERE OID=@OID";

            $("#FrmDocs").html(html);

        });
 
        function Save() {

            //执行选择类型的保存.
            var selectFuncType = 0; 

            var handler = new HttpHandler("BP.CCBill.WF_CCBill_Admin");
            handler.AddUrlData();
            var doc = editor.getValue();
            doc = doc.replace(/-/g, "/$");
            doc = doc.replace(/[+]/g, "/#");

            handler.AddPara("doc", doc); //不知道是否可以存储.
            handler.AddPara("TypeOfFunc", 0);
            handler.AddPara("funcstr", funcstr + doc + " \r\n }");//拼上function部分

            var data = handler.DoMethodReturnString("MethodDoc_SaveScript");

            alert(data);


            window.location.href = window.location.href;
        }
        function ToMethodParas() {
            window.location.href = "MethodParas.htm?No=" + GetQueryString("No");
        }

        var editor = CodeMirror.fromTextArea(document.getElementById("tb_doc"), {
            lineNumbers: true,
            styleActiveLine: true,
            matchBrackets: true,
            theme: "erlang-dark"
        });

        var input = document.getElementById("select");
        function selectTheme() {
            var theme = input.options[input.selectedIndex].textContent;
            editor.setOption("theme", theme);
            location.hash = "#" + theme;
        }
    </script>
</head>
<body>
    <div id="bar">
    </div>

    <div id="paras">
    </div>

    <textarea id="tb_doc" style="width: 90%; height: 80%;" rows="40"> </textarea>


    <div id="h_title" style="color: Gray; display: none">
        <div id="FrmDocs">
        </div>
    </div>

    <fieldset>
        <legend id="help"></legend>
        <ul>
            <li> 定义：自动启动工作流程，一个流程的开始节点的填写与发起是在特定规则的设置下自动发起的流程。</li>
            <li> 解释：通常模式下的流程启动是手工的启动，就是用户从一个发起列表，点击流程名字，就启动了该流程。但是有的时候，是系统自动发起该流程。</li>

            <li>应用场景</li>
            <li> 1 周例会流程，用户希望每个周都要启动例会通知流程这个启动是让系统自动发起而非人工发起。</li>

        </ul>
    </fieldset>

    <script type="text/javascript">

        var editor = CodeMirror.fromTextArea(document.getElementById("tb_doc"), {
            lineNumbers: true,
            styleActiveLine: true,
            matchBrackets: true,
            theme: "erlang-dark"
        });


        var input = document.getElementById("select");
        function selectTheme() {
            var theme = input.options[input.selectedIndex].textContent;
            editor.setOption("theme", theme);
            location.hash = "#" + theme;
        }

        /*
        var choice = (location.hash && location.hash.slice(1)) ||
        (document.location.search &&
        decodeURIComponent(document.location.search.slice(1)));
        if (choice) {
        input.value = choice;
        editor.setOption("theme", choice);
        }
        CodeMirror.on(window, "hashchange", function() {
        var theme = location.hash.slice(1);
        if (theme) { input.value = theme; selectTheme(); }
        });*/
    </script>

</body>
</html>
