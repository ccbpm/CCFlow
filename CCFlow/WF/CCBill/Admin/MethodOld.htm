<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>方法推送 </title>
    <link href="../../../DataUser/Style/ccbpm.css" rel="stylesheet" type="text/css" />
    <link href="../../Style/skin/adminfont/iconfont.css" rel="stylesheet" />
    <link href="../../Comm/fonts/font-icons.min.css" rel="Stylesheet" />
    <script type="text/javascript" src="../../Scripts/bootstrap/js/jquery.min.js"></script>
    <script src="../../Scripts/QueryString.js" type="text/javascript"></script>
    <script type="text/javascript" src="../../Scripts/config.js"></script>
    <script type="text/javascript" src="../../Comm/Gener.js"></script>
    <script src="../../Scripts/PinYin.js" type="text/javascript"></script>
    <script src="Method.js"></script>
    <base target="_self" />
    <script type="text/javascript" language="javascript">
        var frmID = GetQueryString("FrmID");
        //页面启动函数.
        $(function () {

            var ens = new Entities("BP.CCBill.Template.Methods");
            ens.Retrieve("FrmID", frmID, "Idx");

            for (var i = 0; i < ens.length; i++) {

                var en = ens[i];
                var newRow = "";
                newRow = "<tr ><td class=Idx>" + (i + 1) + "</td>";
                newRow += "<td>" + en.MethodID + "</td>";

                if (en.Icon === '')
                    en.Icon = "icon-user";

                newRow += "<td><a href=\"javascript:Open('" + en.MyPK + "','" + en.MethodModel + "');\"' ><i class='" + en.Icon + "' ></i>" + en.Name + "</a></td>";

                newRow += "<td>" + en.MethodModelText + "</td>"; //模式..
                newRow += "<td>" + en.RefMethodTypeText + "</td>"; //打开方式.

                newRow += "<td><img src='../../Img/Btn/Up.gif' onclick=\"Up('" + en.MyPK + "')\" alt='上移' />&nbsp;-&nbsp;<img src='../../Img/Btn/Down.gif' onclick=\"Down('" + en.MyPK + "')\" alt='下移' /> </td>";
                newRow += "<td>";

                if (en.RefMethodType != 2) {
                    newRow += " <a href=\"javascript:Paras('" + en.MyPK + "')\">参数</a> - ";
                    newRow += " <a href=\"javascript:Docs('" + en.MyPK + "')\">执行内容</a> - ";
                }

                newRow += " <a href=\"javascript:Delete('" + en.MyPK + "')\"><img src='../../Img/Btn/Delete.gif' border=0 />删除</a>";
                newRow += "</td>";
                newRow += "</tr>";
                $("#Table1 tr:last").after(newRow);
            }
        });

        function Paras(mypk) {
            url = "MethodParas.htm?No=" + mypk;
            WinOpenFull(url);
        }
        function Docs(mypk) {
            url = "MethodDoc.htm?No=" + mypk;
            WinOpenFull(url);
        }
        //打开.
        function Open(mypk, type) {

            var url = "";// "../../Comm/EnOnly.htm?EnName=BP.CCBill.Template.MethodLink&MyPK=" + mypk;

            //方法，带有参数
            if (type == 1 || type == 2)
                url = "../../Comm/En.htm?EnName=BP.CCBill.Template.MethodFunc&MyPK=" + mypk;

            //超链接.
            if (type == 0)
                url = "../../Comm/EnOnly.htm?EnName=BP.CCBill.Template.MethodLink&MyPK=" + mypk;

            //启动流程.
            if (type == 3)
                url = "../../Comm/En.htm?EnName=BP.CCBill.Template.MethodFlow&MyPK=" + mypk;

            WinOpenFull(url);
        }
        function Up(no) {

            var emp = new Entity("BP.CCBill.Template.Method", no);
            var data = emp.DoMethodReturnString("DoUp");
            window.location.href = window.location.href;
        }
        function Down(no) {

            var emp = new Entity("BP.CCBill.Template.Method", no);
            var data = emp.DoMethodReturnString("DoDown");
            window.location.href = window.location.href;
        }
        //删除.
        function Delete(myPK) {
            if (window.confirm('您确定要删除吗？') == false)
                return;
            var en = new Entity("BP.CCBill.Template.Method");
            en.MyPK = myPK;
            en.Delete();
            window.location.href = window.location.href;
        }
        //创建一个参数连接.
        function CreateMethodLink() {
            var name = window.prompt('请输入方法中文名称', "我的连接");
            if (name == null || name == undefined)
                return;

            var pinYin = ParsePinYin(name, true, null);

            var id = window.prompt('方法ID', pinYin);
            if (name == null || name == undefined)
                return;

            var en = new Entity("BP.CCBill.Template.Method");
            en.FrmID = GetQueryString("FrmID");
            en.MethodID = id;
            en.Name = name;
            en.MethodModel = 0;
            en.RefMethodType = 1;
            en.SetPKVal(en.FrmID + "_" + en.MethodID);
            if (en.IsExits() == true) {
                alert('该方法名已经存在，请重新创建');
                return;
            }
            en.Insert();

            var url = "../../Comm/EnOnly.htm?EnName=BP.CCBill.Template.MethodLink&MyPK=" + en.MyPK;
            WinOpenFull(url);
            //window.location.href = window.location.href;
        }

        //创建一个参数连接.
        function CreateFunc() {

            var name = window.prompt('请输入方法中文名称', "注销学籍");
            if (name == null || name == undefined)
                return;

            var pinYin = ParsePinYin(name, true, null);

            var id = window.prompt('方法ID', pinYin);
            if (name == null || name == undefined)
                return;

            var en = new Entity("BP.CCBill.Template.Method");
            en.FrmID = GetQueryString("FrmID");
            en.MethodID = id;
            en.Name = name;
            en.MethodModel = 1;
            en.RefMethodType = 1;
            en.SetPKVal(en.FrmID + "_" + en.MethodID);
            if (en.IsExits() == true) {
                alert('该方法名已经存在，请重新创建');
                return;
            }
            en.Insert();

            var url = "../../Comm/En.htm?EnName=BP.CCBill.Template.MethodFunc&MyPK=" + en.MyPK;
            WinOpenFull(url);
            //window.location.href = window.location.href;
        }

        //创建发起流程.
        function CreateFlow() {

            var webUser = new WebUser();

            var name = window.prompt('请输入流程名称', "调班申请流程");
            if (name == null || name == undefined)
                return;

            var html = "操作提示:";
            html += "<ul>";
            html += "<li><img src='../../Img/loading.gif'/>正在创建流程请稍后..</li>";
            html += "<li>系统会自动创建一个名字为[" + name + "]的流程，在当前表单的目录下..</li>";
            html += "<li>该流程的表单字段，是从当前实体表单中复制过去的，您可以删除不需要的字段。</li>";
            html += "</ul>";
            $("#Msg").html(html);


            //求出来该表单的所在的modeNo.
            var md = new Entity("BP.Sys.MapData", frmID);

            // var module = new Entity("BP.GPM.Menu2020.Module",)
            // var modelNo = "Dict_WoDeShiTi";

            //开始创建极简的流程.
            var handler = new HttpHandler("BP.WF.HttpHandler.WF_Admin_CCBPMDesigner_FlowDevModel");
            handler.AddPara("SortNo", md.FK_FormTree); //该实体的类别编号与，流程的类别编号一致.
            handler.AddPara("FlowName", name);
            // handler.AddPara("FlowDevModel", FlowDevModel.JiJian);
            handler.AddPara("FlowDevModel", 1); //设置为极简模式.
            // handler.AddPara("FrmUrl", newFlowInfo.FrmUrl);
            //handler.AddPara("FrmID", newFlowInfo.FrmID);
            var data = handler.DoMethodReturnString("FlowDevModel_Save");

            //var webUser = new WebUser();
            // var url = "../Designer.htm?FK_Flow=" + data + "&OrgNo=" + webUser.OrgNo + "&SID=" + webUser.SID + "&UserNo=" + webUser.No + "&From=Ver2021";
            //  var url = "";
            // window.location.href = url;
            //var pinYin = ParsePinYin(name, true, null);
            //var id = window.prompt('方法ID', pinYin);
            //if (name == null || name == undefined)
            //    return;

            $("#Msg").html("正在执行创建方法.");
            var en = new Entity("BP.CCBill.Template.Method");
            en.FrmID = GetQueryString("FrmID");
            en.MethodID = data; // 就是流程编号.
            en.Name = name;

            en.MethodModel = 3;//发起流程.
            en.RefMethodType = 1;
            en.RefMethodWinOpenModel = 1; //新窗口打开.
            en.SetPKVal(en.FrmID + "_" + en.MethodID);
            if (en.IsExits() == true) {
                alert('该方法名已经存在，请重新创建');
                return;
            }
            en.Insert();
            alert("已经创建成功，请到流程设计器中设计流程.");

            //  var url = "../../Comm/En.htm?EnName=BP.CCBill.Template.MethodFunc&MyPK=" + en.MyPK;
            //  WinOpenFull(url);
            window.location.href = window.location.href;
        }


        function MethodDtl(eventType) {

            var url = 'MethodDtl.htm?FrmID=' + GetQueryString('FrmID');
            url += '&FK_Flow=' + GetQueryString('FK_Flow');
            url += '&FK_Event=' + eventType;
            url += '&tk=' + Math.random();

            window.location.href = url;
        }
        function Help() {
            var url = "http://doc.ccbpm.cn";
            window.open(url);
        }
        function CreateMethod() {

            var url = './CreateFunc/1.Func.htm?FrmID=' + GetQueryString('FrmID');
            window.location.href = url;
        }

    </script>
</head>
<body onkeypress="Esc();">
    <table id="Table1" style="width: 100%">
        <caption>
            方法
        </caption>
        <tr>
            <th>
                序
            </th>
            <th>
                ID
            </th>
            <th>
                名称
            </th>
            <th>
                类型
            </th>
            <th>
                打开方式
            </th>
            <th>
                显示顺序
            </th>
            <th>
                操作
            </th>
        </tr>
    </table>
    <fieldset style="border: 0px;">

        <input type="button" value="新建方法Adv" onclick="CreateMethod()" />

        <!--<input type="button" value="帮助" onclick="Help()" />
        <input type="button" value="+新建方法" id="Btn_Save" onclick="ShowHidden('state')" />&nbsp;&nbsp;-->
        <!--<div id="state" style="display: none; color: Gray">
            <ul>
                <li><a href="javascript:CreateMethodLink();">创建连接</a> </li>-->
        <!--<li><a href="javascript:CreateMethodLink('3');">超链接在新窗口打开方法</a> </li>-->
        <!--<li><a href="javascript:CreateFunc();">执行功能方法</a> </li>

        <li><a href="javascript:CreateFlow();">执行：发起资料变更类流程</a> </li>
        <li><a href="javascript:CreateFlow();">执行：新建实体流程</a> </li>
        <li><a href="javascript:CreateFlow();">执行：其他业务流程</a> </li>-->
        <!--<li><a href="javascript:CreateFunc();">有参数的方法</a> </li>-->
        <!--</ul>
        </div>-->
    </fieldset>
    <div id="Msg"></div>
</body>
</html>
