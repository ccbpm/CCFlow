<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script language="JavaScript" src="/WF/Comm/JScript.js" type="text/javascript" ></script>
    <script type="text/javascript" src="/WF/Scripts/bootstrap/js/jquery.min.js"></script>
    <script type="text/javascript" src="/WF/Scripts/bootstrap/js/bootstrap.min.js"></script>
    <script src="/WF/Scripts/QueryString.js" type="text/javascript"></script>
    <script src="/WF/Scripts/config.js" type="text/javascript"></script>
     <base target="_self" /> 
    <link href="/WF/Comm/Style/Table0.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="/WF/Scripts/easyUI15/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="/WF/Scripts/easyUI15/themes/icon.css">
    <script type="text/javascript" src="/WF/Scripts/easyUI15/jquery.min.js"></script>
	<script type="text/javascript" src="/WF/Scripts/easyUI15/jquery.easyui.min.js"></script>
    <script language="javascript" type="text/javascript" >
        /* ESC Key Down */
        function Esc() {
            if (event.keyCode == 27)
                window.close();
            return true;
        }

        //页面启动函数.
        $(function () {

            $("#Msg").html("正在加载,请稍后......");

            InitPage();

            $("#Msg").html("");
        });

        //初始化数据.
        function InitPage() {

            var ensName = GetQueryString("EnsName");

            var refPKVal = GetQueryString("RefPKVal");
            if (refPKVal == null) {
                alert('错误没有找到关联的主键.');
                return;
            }

            var fid = GetQueryString("FID");
            if (fid == null)
                fid = '0';
            var fk_node = GetQueryString("FK_Node");

            //如何获得全部的参数？ &FK_Node=120&FK_Flow=222 放入到url里面去？

            //初始化表格.
            $.ajax({
                type: 'post',
                async: true,
                url: Handler + "?DoType=Dtl_Init&FK_Node=" + fk_node + "&EnsName=" + ensName + "&RefPKVal=" + refPKVal + "&FID=" + fid + "&m=" + Math.random(),
                dataType: 'html',
                success: function (data) {

                    // 检查是否有错误.
                    if (data.indexOf('err@') == 0) {
                        $("#Msg").html(data);
                        return;
                    }
                    //$("#Msg").html(data);


                    //解析.
                    data = JSON.parse(data);

                    //主表数据，用于变量替换.
                    var mainTable = data["MainTable"]; //主表数据.

                    //从表信息.
                    var sys_MapDtl = data["Sys_MapDtl"]; //从表描述.
                    var sys_mapAttr = data["Sys_MapAttr"]; //从表字段.
                    var sys_mapExtDtl = data["Sys_MapExt"]; //扩展信息.
                    var dbDtl = data["DBDtl"]; //从表数据.

                    //解析数据组装datagrid表
                    //列名称数组
                    var cols = new Array();
                    for (var i = 0; i < sys_mapAttr.length; i++) {
                        var clsJson = gridTitle(sys_mapAttr[i],data); //
                        cols.push(clsJson);
                    }
                    //设置表格信息
                    $('#dg').datagrid({
                        //url: '../Test/GetDataFormSql.ashx',
                        //width: 400,
                        title: sys_MapDtl[0].Name
                    });
                    //更新列名称
                    $('#dg').datagrid({
                        columns: [cols]
                    });


                }
            });
        }
     </script>
</head>
<body>

<table id="dg" class="easyui-datagrid" title="Row Editing in DataGrid" style="width:700px;height:auto"
			data-options="
				iconCls: 'icon-edit',
                rownumbers: true,
				singleSelect: true,
				toolbar: '#tb',
				url: 'datagrid_data1.json',
				method: 'get',
				onClickRow: onClickRow
			">
		<thead>
		</thead>
</table>

	<div id="tb" style="height:auto">
		<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="append()">新增行</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit()">删除行</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="accept()">保存行</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true" onclick="reject()">撤销行</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true" onclick="getChanges()">获取改变行</a>
	</div>
	
	<script type="text/javascript">
	    var editIndex = undefined;
	    function endEditing() {
	        if (editIndex == undefined) { return true }
	        if ($('#dg').datagrid('validateRow', editIndex)) {
	            var ed = $('#dg').datagrid('getEditor', { index: editIndex, field: 'productid' });
	            var productname = $(ed.target).combobox('getText');
	            $('#dg').datagrid('getRows')[editIndex]['productname'] = productname;
	            $('#dg').datagrid('endEdit', editIndex);
	            editIndex = undefined;
	            return true;
	        } else {
	            return false;
	        }
	    }
	    function onClickRow(index) {
	        if (editIndex != index) {
	            if (endEditing()) {
	                $('#dg').datagrid('selectRow', index)
							.datagrid('beginEdit', index);
	                editIndex = index;
	            } else {
	                $('#dg').datagrid('selectRow', editIndex);
	            }
	        }
	    }
	    function append() {
	        if (endEditing()) {
	            $('#dg').datagrid('appendRow', { status: 'P' });
	            editIndex = $('#dg').datagrid('getRows').length - 1;
	            $('#dg').datagrid('selectRow', editIndex)
						.datagrid('beginEdit', editIndex);
	        }
	    }
	    function removeit() {
	        if (editIndex == undefined) { return }
	        $('#dg').datagrid('cancelEdit', editIndex)
					.datagrid('deleteRow', editIndex);
	        editIndex = undefined;
	    }
	    function accept() {
	        if (endEditing()) {
	            $('#dg').datagrid('acceptChanges');
	        }
	    }
	    function reject() {
	        $('#dg').datagrid('rejectChanges');
	        editIndex = undefined;
	    }
	    function getChanges() {
	        var rows = $('#dg').datagrid('getChanges');
	        alert(rows.length + ' rows are changed!');
	    }

	    //动态拼接表
	    function gridTitle(obj, datax) {
	        
	        var hid = false; //1
	        if (obj.UIIsEnable == 0) {
	            hid = true;
            }
	        if (obj.UIIsEnable==1) {//可编辑UIIsEnable : 0
	            //根据数据类型设定组件类型
	            if (obj.UIContralType == 0) {//文本
	                if (obj.MyDataType == 1) {//string
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'text', options: {} }, hidden: hid};
	                } else if (obj.MyDataType == 2) {//int
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'numberbox', options: {} }, hidden: hid };
	                } else if (obj.MyDataType == 3) {//float
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'numberbox', options: {} }, hidden: hid };
	                } else if (obj.MyDataType == 4) {//AppBoolean
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'text', options: {} }, hidden: hid };
	                } else if (obj.MyDataType == 5) {//AppDouble
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'numberbox', options: {} }, hidden: hid };
	                } else if (obj.MyDataType == 6) {//AppDate
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'datebox', options: {} }, hidden: hid };
	                } else if (obj.MyDataType == 7) {//AppDateTime
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'datetimebox', options: {} }, hidden: hid };
	                } else if (obj.MyDataType == 8) {//AppMoney
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'numberbox', options: {} }, hidden: hid };
	                } else if (obj.MyDataType == 9) {//率百分比
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'numberbox', options: {} }, hidden: hid };
	                } else {
	                    return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'text', options: {} }, hidden: hid }; 
                    }
	            } else if (obj.UIContralType == 1) {//下拉框UIBindKey
	                return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'combobox', options: { valueField: 'No', textField: 'Name', data: datax[obj.UIBindKey]} }, hidden: hid };
	            } else if (obj.UIContralType == 2) {//选择框
	                return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'checkbox', options: { valueField: 'No', textField: 'Name', data: datax[obj.UIBindKey]} }, hidden: hid };
	            } else if (obj.UIContralType == 3) {//单选
	                return { field: obj.KeyOfEn, title: obj.Name, width: 80, editor: { type: 'checkbox', options: { on: '1', off: '0'} }, hidden: hid };
	            }
            }
	    return { field: obj.KeyOfEn, title: obj.Name, width: 80, hidden: hid };  
        }
	</script>
<div id="Msg"></div>
</body>
</html>
