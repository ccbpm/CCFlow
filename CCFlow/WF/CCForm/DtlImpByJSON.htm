<html>
<head>
    <title>驰骋工作流</title>
    <link href="../Scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="../Scripts/bootstrap/js/jquery.min.js"></script>
    <script src="../Scripts/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <link href="../Scripts/bootstrap/bootstrap-paginator/css/bootstrapv3.css" rel="stylesheet"
        type="text/css" />
    <script src="../Scripts/bootstrap/bootstrap-paginator/js/bootstrap-paginator.js"
        type="text/javascript"></script>
    <script src="../Scripts/QueryString.js" type="text/javascript"></script>
    <!-- 引用通用的js文件. -->
    <script type="text/javascript" src="../Scripts/config.js"></script>
    <script type="text/javascript" src="../Comm/Gener.js"></script>
    <style type="text/css">
        .keyWordInput
        {
            border-top-right-radius: 5px;
            border-top-left-radius: 5px;
            border-bottom-right-radius: 5px;
            border-bottom-left-radius: 5px;
            height: 30px;
        }
        .menuGroup
        {
            float: left;
        }
        .menuGroup a
        {
            margin-left:10px;
        }
        .menuGroupSelected
        {
            color: Blue; /* 文字颜色 */
            font-weight: bold;
            text-decoration: none;
            padding-bottom:5px;
            border-bottom: 3px solid Blue;
        }
    </style>
    <script type="text/javascript" language="javascript">
        var result = null;
        //页面启动函数.
        $(function () {
            var href = window.location.href;
            var urlParam = href.substring(href.indexOf('?') + 1, href.length);

            ResetHtml();
            //获得当前用户信息.
            var currUser = new WebUser();
            var no = currUser.No;

            //实体参数.
            var ensName = GetQueryString("EnsName");
            var mapExt = new Entity("BP.Sys.MapExt");
            mapExt.MyPK = "DtlImpByJSON_" + ensName;
            var i = mapExt.RetrieveFromDBSources();
            if (i == 0) {
                alert("没有配置导入数据相关参数。");
                return;
            }
            if (mapExt.Tag1 == "" || mapExt.Tag2 == "" || mapExt.Tag3 == "") {
                alert("参数配置错误，请联系管理员。");
                return;
            }
            //分组标签
            InitGroupLabel(mapExt);

            $('.menuGroup a').each(function () {
                var aLabel = $(this);
                aLabel.click(function () {
                    $('.menuGroup a').each(function () {
                        $(this).removeClass("menuGroupSelected");
                    });
                    $(this).toggleClass("menuGroupSelected");
                });
            });
        });

        //重置标签
        function ResetHtml() {
            $("#groupDiv").html("");
        }

        //初始化标签
        function InitGroupLabel(mapExt) {
            var url = mapExt.Tag2;
            var ifcData = DBAccess.RunUrlReturnJSON(url);
            $("#groupDiv").html("");
            if (ifcData && ifcData.length > 0) {
                var data = ifcData[0];
                var oKeys = [];
                for (var key in data) {
                    oKeys.push(key);
                }

                if (oKeys.length < 2) {
                    alert("返回数据格式有问题，列的数量小于2。");
                    return;
                }

                var noKey = oKeys[0];
                var nameKey = oKeys[1];

                $("#groupDiv").append("<a class='menuGroupSelected' href='javascript:void(0);'>全部</a>");
                $.each(ifcData, function (i, dataObj) {
                    var no = dataObj[noKey];
                    var name = dataObj[nameKey];
                    $("#groupDiv").append("<a id='" + no + "' href='javascript:void(0);'>" + name + "</a>");
                });
            } else {
                $("#groupDiv").append("<a class='menuGroupSelected' href='javascript:void(0);'>全部</a>");
            }
        }

        //ajax获取后台数据
        function initTable() {
            var tbody = "";
            $.ajax({
                type: 'POST',
                dataType: "json",
                async: false,
                url: "table.jsp", //请求的action路径页面
                data: { "flag": true },
                error: function () {//请求失败处理函数 
                    alert('请求失败');
                },
                success: function (data) { //请求成功后处理函数。 
                    tbody = "<tr class='success'><th>设备标识号</td><th  align='center'>设备类别</td><th  align='center'>参数编码</td><th  align='center'>失效模式编码</td><th  align='center'>数据来源</td></tr>";
                    $.each(data.list, function (i, n) {
                        var trs = "";
                        trs += "<tr><td align='center'>" + n.sbbsh + "</td><td align='center'>" + n.sblb + "</td><td align='center'>" + n.csbm + "</td><td align='center'>" + n.sxcode + "</td><td align='center'>" + n.sjly + "</td></tr>";
                        tbody += trs;
                    });
                    $("#testTable").html(tbody);
                    var pageCount = data.pageCount; //取到pageCount的值
                    var currentPage = data.CurrentPage; //得到currentPage

                    var options = {
                        bootstrapMajorVersion: 3, //版本
                        currentPage: currentPage, //当前页数
                        totalPages: pageCount, //总页数
                        numberOfPages: 5,
                        itemTexts: function (type, page, current) {
                            switch (type) {
                                case "first":
                                    return "首页";
                                case "prev":
                                    return "上一页";
                                case "next":
                                    return "下一页";
                                case "last":
                                    return "末页";
                                case "page":
                                    return page;
                            }
                        }, //点击事件，用于通过Ajax来刷新整个list列表
                        onPageClicked: function (event, originalEvent, type, page) {
                            $.ajax({
                                url: "table.jsp",
                                type: "Post",
                                dataType: "json",
                                data: "page=" + page,
                                success: function (data) {
                                    tbody1 = "<tr class='success'><th>设备标识号</td><th  align='center'>设备类别</td><th  align='center'>参数编码</td><th  align='center'>失效模式编码</td><th  align='center'>数据来源</td></tr>";
                                    $.each(data.list, function (i, n) {
                                        var trs = "";
                                        trs += "<tr><td align='center'>" + n.sbbsh + "</td><td align='center'>" + n.sblb + "</td><td align='center'>" + n.csbm + "</td><td align='center'>" + n.sxcode + "</td><td align='center'>" + n.sjly + "</td></tr>";
                                        tbody1 += trs;
                                    });
                                    $("#testTable").html(tbody1);
                                }
                            });
                        }
                    };
                    $('#example').bootstrapPaginator(options);
                }
            });
        }

        function Search() {
            var key = document.getElementById("TB_Key").value;
            if (key == null || key == undefined || key == '') {
                alert('请输入关键字');
                return;
            }
            var url = Handler + "?DoType=DtlOpt_Search&Key=" + key + "&FK_MapDtl=" + GetQueryString("FK_MapDtl") + "&RefPKVal=" + GetQueryString("RefPKVal") + "&m=" + Math.random();

            $.ajax({
                type: 'post',
                async: true,
                url: url,
                dataType: 'html',
                success: function (data) {

                    if (data.indexOf('err@') == 0) {
                        alert(data);
                        return;
                    }
                    result = JSON.parse(data);
                    BindTable();
                }
            });
        }

        function Add(isReturnToDtl) {

            var vals = '';
            $.each($(":checkbox"), function () {
                if (this.checked == true)
                    vals += this.id.replace('CB_', '') + ",";
            });

            //获得pks. 
            alert(vals);

            var href = window.location.href;
            var urlParam = href.substring(href.indexOf('?') + 1, href.length);
            var url = Handler + "?DoType=DtlOpt_Add&PKs=" + vals + "&" + urlParam + "&m=" + Math.random();

            $.ajax({
                type: 'post',
                async: true,
                url: url,
                dataType: 'html',
                success: function (data) {

                    if (data.indexOf('err@') == 0) {
                        alert(data);
                        return;
                    }

                    alert(data);
                    if (isReturnToDtl == false)
                        return;
                }
            });
        }

        function CheckAll() {
            var checked = document.getElementById('CB_CheckAll').checked;
            $.each($(":checkbox"), function () {
                this.checked = checked;
            });
        }

        //取消，关闭弹出层
        function DalogModelCose() {
            if (window.parent && window.parent.CloseBootstrapDialog) {
                window.parent.CloseBootstrapDialog("取消");
            }
        }
    </script>
</head>
<body>
    <form id="cc">
    <table style="border: 0px; width: 99%;">
        <tr>
            <td>
                <div id="searchDiv" style='text-align: left;'>
                    <input type="text" id="TB_Key" value="" class="keyWordInput" style="width: 60%;" placeholder="输入付款人、金额进行搜索" onchange="Search()" />
                </div>
            </td>
        </tr>
        <tr id="groupTr">
            <td style="height: 60px; text-align: left;">
                <div id="groupDiv" class="menuGroup">
                    <a href="javascript:void(0);">全部</a> 
                    <a class="menuGroupSelected" href="javascript:void(0);">携程商旅</a> 
                    <a href="javascript:void(0);">滴滴出行</a>
                </div>
            </td>
        </tr>
        <tr>
            <td style="border: 1px #FF8000 solid;">
                <div>
                    <div>
                        <table class="table table-striped" id='jsonDataTable'></table>
                    </div>
                    <div style="text-align: left;">
                        <ul id="examplePagetions"></ul>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td style="float:right;">
                <div style="margin-top:10px; margin-right:10px;">
                    <input type="button" class="btn" onclick="DalogModelCose()" value="取消" />
                    <input type="button" class="btn btn-danger" value="确定" />
                </div>
            </td>
        </tr>
    </table>
    </form>
</body>
</html>
