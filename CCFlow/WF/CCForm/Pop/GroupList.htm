<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>分组平铺</title>
     <script language="JavaScript" src="../../Comm/JScript.js" type="text/javascript" ></script>
    <script type="text/javascript" src="../../Scripts/bootstrap/js/jquery.min.js"></script>
    <script src="../../Scripts/QueryString.js" type="text/javascript"></script>
    <!-- 引用通用的js文件. -->
    <script type="text/javascript" src="../../Scripts/config.js"></script>
    <script type="text/javascript" src="../../Comm/Gener.js"></script>
    <link href="../../../DataUser/Style/ccbpm.css" rel="Stylesheet" />


    <script type="text/javascript">

        var selectedEles = null;
        var mapExt = null;

        $(function () {

            $("#Msg").html("正在加载,请稍后......");

            var mypk = GetQueryString("FK_MapExt");
            mapExt = new Entity("BP.Sys.MapExt", mypk);

            var srcOfGroup = mapExt.Tag1; //分组.
            var srcOfEntitis = mapExt.Tag2; //实体.

            var groups = DBAccess.RunSQLReturnTable(srcOfGroup); //分组.
            var entities = DBAccess.RunSQLReturnTable(srcOfEntitis); //数据源.

            var html = "<table style='width:100%;' >";

            var isRB = true;
            if (mapExt.GetPara('SelectType') == 1)
                isRB = false;

            //获得已经选择的集合.
            selectedEles = new Entities("BP.Sys.FrmEleDBs");
            selectedEles.Retrieve("FK_MapData", mapExt.FK_MapExt, "EleID", mapExt.AttrOfOper, "RefPKVal", GetQueryString("PKVal"));

            // alert(eleDBs.length);

            for (var i = 0; i < groups.length; i++) {
                var group = groups[i];

                html += "<tr>";
                html += "<th colspan=3>";

                if (isRB == true)
                    html += "" + group.Name;
                else
                    html += "<input type='checkbox'  id='CB_Group_" + group.No + "'  /><label for='CB_Group_" + group.No + "'>" + group.Name + "</label>";

                html += "</th>";
                html += "</tr>";


                var myNum = -1;
                for (var idx = 0; idx < entities.length; idx++) {

                    en = entities[idx];

                    var myidx = 0;
                    var oOfEn;
                    for (var obj in en) {
                        if (myidx == 2) {
                            oOfEn = obj;
                            break;
                        }
                        myidx++;
                    }

                    myidx = 0;
                    var oOfGroup;
                    for (var obj in en) {
                        if (myidx == 0) {
                            oOfGroup = obj;
                            break;
                        }
                        myidx++;
                    }

                    if (en[oOfEn] != group[oOfGroup])
                        continue;

                    var isHave = false;
                    for (var iEle = 0; iEle < selectedEles.length; iEle++) {
                        var ele = selectedEles[i];
                        if (ele.RefPKVal == en.No) {
                            isHave = true;
                            break;
                        }
                    }

                    var lab = en.Name;
                    if (isHave)
                        lab = "<font color=green>" + en.Name + "</font>";

                    myNum++;
                    if (myNum == 0)
                        html += "<TR>";

                    if (isRB == true)
                        html += "<td><input type='radio' name='RB' id='RB_" + en.No + "' value='"+en.No+"'/><label for='RB_" + en.No + "'>" + lab + "</label></td>";
                    else
                        html += "<td><input type='checkbox' name='"+group.No+"' id='CB_" + en.No + "' value='"+en.No+"' /><label for='CB_" + en.No + "'>" + lab + "</label></td>";

                    if (myNum == 2) {
                        html += "</tr>";
                        myNum = -1;
                    }
                }

                if (idx == 1) {
                    html += "<td colspan=2></td>";
                    html += "</tr>";
                }

                if (idx == 2) {
                    html += "<td></td>";
                    html += "</tr>";
                }

            }
            html += "</table>";

            $("#Msg").html("");
            $("#Msg").html(html);
        });

        //保存.
        function Save() {

           //获得存储的值.
            var selectVals = [];
        
            //获得选择的数据.
            var selectType = mapExt.GetPara("SelectType");
            if (selectType == "0") {  //单选.
                selectVals.push( $("input[name='RB']:checked").val());
            } else {

                var cbs = $("input[type='checkbox']:checked");

                cbs.each(function () {
                    selectVals.push(this.value);
                });
            }
            alert(selectVals.join(','));


            //删除变量中没有的数据,已经取消掉的.  selectedEles 数据.

            //插入新选择的数据.

            //获得已经选择的集合.
              // var eleDBs = new Entities("BP.Sys.FrmEleDBs");
              // eleDBs.Retrieve("FK_MapData", mapExt.FK_MapExt, "EleID", mapExt.AttrOfOper, "RefPKVal", GetQueryString("PKVal"));

            //组成返回的字符串.

            //执行返回,并关闭窗口.
        }

    </script>
</head>
<body>
 
 <table id="Table1" >
  
 </table>

 <input type=button id="Btn_Save" onclick="Save();"  value="Save"/>
 <div id="Msg"> </div>

</body>
</html>
