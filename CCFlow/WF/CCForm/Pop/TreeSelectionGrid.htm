<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script language="JavaScript" src="../../Comm/JScript.js" type="text/javascript" ></script>
		<script type="text/javascript" src="../../Scripts/QueryString.js"></script>
		<script type="text/javascript" src="../../Scripts/config.js"></script>

        <script src="../../Scripts/jquery-1.11.0.min.js" type="text/javascript"></script>

        <script src="../../Scripts/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <link href="../../Scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />

        <link href="../../Scripts/bootstrap/css/font-awesome.css" rel="stylesheet" type="text/css" />

        <script src="../../Scripts/bootstrap/bootstrap-table/src/bootstrap-table.js" type="text/javascript"></script>
        <link href="../../Scripts/bootstrap/bootstrap-table/src/bootstrap-table.css" rel="stylesheet" type="text/css" />
        <script src="../../Scripts/bootstrap/bootstrap-table/src/locale/bootstrap-table-zh-CN.js" type="text/javascript"></script>

        <script src="../../Scripts/bootstrap/bootstrap-treeview/src/js/bootstrap-treeview.js" type="text/javascript"></script>
        <link href="../../Scripts/bootstrap/bootstrap-treeview/src/css/bootstrap-treeview.css" rel="stylesheet" type="text/css" />

		<style type="text/css">
			.row-margin-top {
				margin-top: 20px;
			}
		</style>

		<script type="text/javascript">
			function loadViewGrid(json) {
				if ($.isArray(json)) {
					$('#viewGrid').bootstrapTable("load", json);
				}
			}
			function addSelectedData(globalSelectedRows, selectedRows) {
				if (!$.isArray(globalSelectedRows) || !$.isArray(selectedRows)) {
					return;
				}
				$.each(selectedRows, function (i, o) {
					var sel = $.grep(globalSelectedRows, function (obj) {
						return obj.No == o.No;
					});
					if (sel.length == 0) {
						globalSelectedRows.push(o);
					}
				});
			}
			function removeSelectedData(globalSelectedRows, selectedRows) {
				if (!$.isArray(globalSelectedRows) || !$.isArray(selectedRows)) {
					return;
				}
				$.each(selectedRows, function (i, o) {
					for (var index = 0; index < globalSelectedRows.length; index++) {
						if (o.No == globalSelectedRows[index].No) {
							globalSelectedRows.splice(index, 1);
							break;
						}
					}
				});
			}
			function loadSelectGrid(url, id, selectedRows) {
				url = url.replace("@Key", id);
				$.ajax({
					type: 'post',
					async: true,
					url: url + "&m=" + Math.random(),
					dataType: 'html',
					success: function (data) {
						if (data.indexOf("err@") != -1) {
							alert(data);
							return;
						}
						var json = JSON.parse(data);
						if ($.isArray(selectedRows)) {
							$.each(json, function (i, o) {
								var sel = $.grep(selectedRows, function (obj) {
									return o.No == obj.No;
								});
								if (sel.length > 0) {
									o.checked = true;
								}
							});
						}
						$('#selectGrid').bootstrapTable("load", json);
					}
				});
			}
			function findChildren(jsonArray, parentNo) {
				var appendToTree = function (treeToAppend, child) {
					$.each(treeToAppend, function (i, o) {
						if (o.id == child.ParentNo) {
							o.nodes.push({
								"id" : child.No,
								"text" : child.Name,
								"nodes" : []
							});
						} else {
							appendToTree(o.nodes, child);
						}
					});
				};
				var jsonTree = [];
				if ($.isArray(jsonArray) && typeof parentNo !== "undefined") {
					$.each(jsonArray, function (i, o) {
						if (o.ParentNo == parentNo) {
							jsonTree.push({
								"id" : o.No,
								"text" : o.Name,
								"nodes" : []
							});
						} else {
							appendToTree(jsonTree, o);
						}
					});
				}
				function _(treeArray) {
					$.each(treeArray, function (i, o) {
						if ($.isArray(o.nodes)) {
							if (o.nodes.length == 0) {
								o.nodes = undefined;
							} else {
								_(o.nodes);
							}
						}
					});
				}
				_(jsonTree);
				return jsonTree;
			}
			function loadTree(treeUrl, treeClickUrl, global) {
				$.ajax({
					type: 'post',
					async: true,
					url: treeUrl + "&m=" + Math.random(),
					dataType: 'html',
					success: function (data) {
						if (data.indexOf("err@") != -1) {
							alert(data);
							return;
						}
						var rootNo = GetQueryString("rootNo");
						var jsonTree = findChildren(JSON.parse(data), rootNo);
						
						$('#tree').treeview({
							data : jsonTree,         // 数据源
							showCheckbox: false,   //是否显示复选框
							highlightSelected: true,    //是否高亮选中
							//nodeIcon: 'glyphicon glyphicon-user',    //节点上的图标
							nodeIcon: 'glyphicon',
							emptyIcon: '',    //没有子节点的节点图标
							multiSelect: false,    //多选
							onNodeChecked: function (event, data) {
								//alert(data.nodeId);
							},
							onNodeSelected: function (event, data) {
								loadSelectGrid(treeClickUrl, data.nodeId, global.selectedRows);
							}
						});
					}
				});
			}
			$(function () {
				var title = GetQueryString("title");
				$("#title").text(unescape(title));
				var tip = GetQueryString("tip");
				$("#userNo").attr("placeholder", unescape(tip));
				//
				var global = window;
				global.selectedRows = [];
				var treeClickUrl = GetQueryString("treeClickUrl");
				if (typeof treeClickUrl === "string") {
					treeClickUrl = unescape(treeClickUrl);
				}
				// tree
				var treeUrl = GetQueryString("treeUrl");
				if (treeUrl) {
					loadTree(unescape(treeUrl), treeClickUrl, global);
				}
				// grid1
				$('#selectGrid').bootstrapTable({
					striped: true,
					cache: false,
					sortOrder: "asc",
					strictSearch: true,
					minimumCountColumns: 2,
					clickToSelect: true,
					sortable: false,
					cardView: false,
					detailView: false,
					height: $(document).height() / 3,
					uniqueId: "No",
					columns: [{
						checkbox : true,
						formatter : function (value, row, index) {
							if (row.checked) {
								return {
									"checked" : true
								};
							}
						}
					}, {
						field: 'No',
						title: '员工号'
					}, {
						field: 'Name',
						title: '姓名'
					}],
					"onCheck" : function (row, element) {
						addSelectedData(global.selectedRows, [ row ]);
						loadViewGrid(global.selectedRows);
					},
					"onUncheck" : function (row, element) {
						removeSelectedData(global.selectedRows, [ row ]);
						loadViewGrid(global.selectedRows);
					},
					"onCheckAll" : function (rows) {
						addSelectedData(global.selectedRows, rows);
						loadViewGrid(global.selectedRows);
					},
					"onUncheckAll" : function (rows) {
						removeSelectedData(global.selectedRows, rows);
						loadViewGrid(global.selectedRows);
					}
				});
				// grid2
				$('#viewGrid').bootstrapTable({
					striped: true,
					cache: false,
					sortOrder: "asc",
					strictSearch: true,
					minimumCountColumns: 2,
					clickToSelect: true,
					sortable: false,
					cardView: false,
					detailView: false,
					height: $(document).height() / 3,
					uniqueId: "No",
					columns: [{
						field: 'No',
						title: '员工号'
					}, {
						field: 'Name',
						title: '姓名'
					}]
				});
			});
		</script>
	<head>
	<body>
        <div class="container-fluid">
	        <div class="row">
		        <div class="col-md-12">
			        <h3 class="text-center" id="title"></h3>
					<div class="row">
						<div class="col-md-1 col-sm-1"></div>
						<div class="col-md-10 col-sm-10">
							<div class="pull-center search">
								<input class="form-control" type="text" placeholder="" id="userNo" onchange="">
							</div>
						</div>
						<div class="col-md-1 col-sm-1"></div>
					</div>
		        </div>
	        </div>
	        <div class="row row-margin-top">
		        <div class="col-md-4 col-sm-4">
                    <div id="tree"></div>
		        </div>
		        <div class="col-md-8 col-sm-8">
					<div class="row">
						<div class="col-md-12">
							<table id="selectGrid"></table>
						</div>
					</div>
					<div class="row row-margin-top">
						<div class="col-md-12">
							<table id="viewGrid"></table>
						</div>
					</div>
		        </div>
	        </div>
        </div>
	</body>
</html>