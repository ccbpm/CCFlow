<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>部门选择器</title>
    <link href="../../Scripts/easyUI15/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../../Scripts/easyUI15/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../../Scripts/easyUI15/jquery.min.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/easyloader.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.parser.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.draggable.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.resizable.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.progressbar.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.panel.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.linkbutton.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.window.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.dialog.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.messager.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.tooltip.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.validatebox.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.tree.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.pagination.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.datagrid.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/plugins/jquery.textbox.js" type="text/javascript"></script>
    <script src="../../Scripts/easyUI15/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../../Scripts/config.js" type="text/javascript"></script>
    <script src="../Gener.js" type="text/javascript"></script>
    <script type="text/javascript">
        var ensName = GetQueryString("EnsName");
        var enName = GetQueryString("EnName");
        var attrKey = GetQueryString("AttrKey");
        var nodeid = GetQueryString("NodeID");
        var deptsubs = new Array(); //部门人员
        var nodedepts = new Array(); //节点绑定人员
        var currdepts = new Array(); //记录当前表格中绑定的人员列表集合
        var PAGESIZE = 10;  //默认每页显示条数
        var partidx = 0;
        var partcount = 0;
        var savedatas = new Array();

        $(function () {
            $("#treeDepts").tree({
                checkbox: true,
                formatter: function (node) {
                    if (!node.attributes) {
                        return node.text;
                    }

                    var root = $("#treeDepts").tree("getRoot");
                    var rootselect = '';

                    if (node.attributes.TType == "CDEPT") {
//                        if (root.id == node.id) {
//                            if (IndexOfArray(nodedepts, "No", node.attributes.No) == -1) {
//                                rootselect = "&nbsp;<a href='javascript:void(0)' onclick='CheckRootNode(this, true)'>[选择]</a>";
//                            }
//                            else {
//                                rootselect = "&nbsp;<a href='javascript:void(0)' onclick='CheckRootNode(this, false)'>[取消]</a>";
//                            }

//                            return node.text + rootselect;
//                        }

                        return node.text;
                    }

                    var link = "<a href='javascript:void(0)' onclick='GetSubDepts(\"" + root.attributes.No + "\",\"" + node.attributes.No + "\")'>" + node.text + "</a>";

                    if (root.id == node.id) {
//                        if (IndexOfArray(nodedepts, "No", node.attributes.No) == -1) {
//                            rootselect = "&nbsp;<a href='javascript:void(0)' onclick='CheckRootNode(this, true)'>[选择]</a>";
//                        }
//                        else {
//                            rootselect = "&nbsp;<a href='javascript:void(0)' onclick='CheckRootNode(this, false)'>[取消]</a>";
//                        }

                        return link + rootselect;
                    }
                    else {
                        return link;
                    }
                },
                onExpand: function (node) {
                    if (node.attributes && node.attributes.TType == "CDEPT") {  //只处理DEPT类型                    
                        return;
                    }

                    var root = $("#treeDepts").tree("getRoot");

                    GetSubDepts(root.attributes.No, node.attributes.No);
                },
                onCascadeCheck: function (node, checked) {
                    if (!node.attributes || node.attributes.TType != "DEPT") {
                        return;
                    }

                    CheckNode(node, checked);
                },
                onCheck: function (node, checked) {
                    if (typeof node.checked == typeof checked || !node.attributes || node.attributes.TType != "DEPT") {
                        return;
                    }
                    alert(node.attributes.Name + "_" + node.checked + "_" + checked);
                },
                checkbox: function (node) {
                    if (node.attributes && node.attributes.TType == "PDEPT") {
                        return false;
                    }

                    if (node.text == "loading..." || node.children.length == 0) {
                        return false;
                    }

                    return true;
                }
            });

            $("#sDepts").datagrid({
                pagination: true,
                pageNumber: 0,
                pageSize: PAGESIZE,
                pageList: [10, 20, 30, 40, 50]
            });

            $("#kw").textbox({
                onChange: function (newValue, oldValue) {
                    FilterDepts(newValue);
                }
            });

            Init();
        });

        function Init() {
            //获取组织结构根结点
            var param = {
                DoType: "Dot2DotTreeDeptEmpModel_GetStructureTreeRoot",
                parentrootid: "0"
            };

            Handler_AjaxQueryData(param, function (data, scope) {
                if (data.indexOf("err@") != -1) {
                    alert(data);
                    return;
                }

                var treeData = eval('(' + data + ')');
                $("#treeDepts").tree("loadData", treeData.InnerData);

                //获取当前节点绑定的人员
                GetNodeDepts();
            }, this);
        }

        function GetSubDepts(rootid, parentid) {
            var param = {
                DoType: "Dot2DotTreeDeptModel_GetSubDepts",
                rootid: rootid,
                parentid: parentid,
                nodeid: nodeid
            };

            var node = $("#treeDepts").tree("find", "DEPT_" + parentid);

            if (node.state == "closed") {
                $("#treeDepts").tree("expand", node.target);
            }

            var children = $("#treeDepts").tree("getChildren", node.target);
            if (children[0].text != "loading...") {
                $("#treeDepts").tree("insert", {
                    before: children[0].target,
                    data: {
                        text: "loading..."
                    }
                });
            }

            Handler_AjaxQueryData(param, function (data, scope) {
                if (data.indexOf("err@") != -1) {
                    alert(data);
                    return;
                }

                var redata = eval('(' + data + ')');
                deptsubs = redata.InnerData.Depts;

                //更新部门人员中的选中状态
                var idx = -1;

                $.each(deptsubs, function () {
                    idx = IndexOfArray(nodedepts, "No", this.No);

                    if (this.Checked) {
                        if (idx == -1) {
                            this.Checked = false;
                            SetDeptChecked(redata.InnerData.TreeData[0], this.No, false);
                        }
                    }
                    else {
                        if (idx != -1) {
                            this.Checked = true;
                            SetDeptChecked(redata.InnerData.TreeData[0], this.No, true);
                        }
                    }
                });

                $("#treeDepts").tree("loadData", redata.InnerData.TreeData);
            }, this);
        }

        function GetNodeDepts() {
            var param = {
                DoType: "Dot2DotTreeDeptModel_GetNodeDepts",
                nodeid: nodeid
            };

            $("#save").linkbutton("disable");

            Handler_AjaxQueryData(param, function (data, scope) {
                if (data.indexOf("err@") != -1) {
                    alert(data);
                    return;
                }

                var redata = eval('(' + data + ')');
                nodedepts = redata.InnerData;
                $("#save").linkbutton("enable");
                ShowSelectedDepts();
            }, this);
        }

        function ShowSelectedDepts() {
            LoadDeptsInDataGrid(nodedepts, 1, $("#sDepts").datagrid("options").pageSize);
        }

        function CheckRootNode(link, checked) {
            var root = $("#treeDepts").tree("getRoot");

            CheckNode(root, checked);
            ShowSelectedDepts();            

            $(link).text(checked ? "[取消]" : "[选择]");
            $(link).attr("onclick", checked ? "CheckRootNode(this, false)" : "CheckRootNode(this, true)");
        }

        function CheckNode(node, checked) {
            var deptname = '';
            var parent = $("#treeDepts").tree("getParent", $("div[id='" + node.domId + "']")[0]);

            if (parent != null) {
                deptname = parent.attributes.Name;
            }

            var currdept = {
                No: node.attributes.No,
                Name: node.attributes.Name,
                DeptNo: node.attributes.ParentNo,
                DeptName: deptname,
                Checked: checked,
                Code: node.attributes.Code
            };
            //选中，判断是否已经存在绑定列表中
            if (checked) {  //选中
                if (IndexOfArray(nodedepts, "No", currdept.No) == -1) {
                    nodedepts.push(currdept);
                }

                for (index in deptsubs) {
                    if (deptsubs[index].No == currdept.No) {
                        deptsubs[index].Checked = true;
                    }
                }
            }
            else {  //取消选中
                var idx = IndexOfArray(nodedepts, "No", currdept.No);

                if (idx != -1) {
                    nodedepts.splice(idx, 1);
                }

                for (index in deptsubs) {
                    if (deptsubs[index].No == currdept.No) {
                        deptsubs[index].Checked = false;
                    }
                }
            }
        }

        function SetDeptChecked(node, deptNo, checked) {
            if (!node.attributes) {
                return;
            }

            if (node.attributes.TType == "DEPT" && node.attributes.No == deptNo) {
                node.checked = checked;
            }
            else {
                if (node.children) {
                    $.each(node.children, function () {
                        SetDeptChecked(this, deptNo, checked);
                    });
                }
            }
        }

        function FilterDepts(key) {
            var pageSize = $("#sDepts").datagrid("options").pageSize;

            if (!key || key.length == 0) {
                LoadDeptsInDataGrid(nodedepts, 1, pageSize);
                return;
            }

            var filterdepts = new Array();   //检索结果人员集合

            key = key.toLowerCase();

            $.each(nodedepts, function () {
                if (this.Code.indexOf(key) != -1 || this.Name.indexOf(key) != -1 || this.DeptName.indexOf(key) != -1) {
                    filterdepts.push(this);
                }
            });

            LoadDeptsInDataGrid(filterdepts, 1, pageSize);
        }

        function LoadDeptsInDataGrid(depts, pageNum, pageSize) {
            currdepts = depts;

            $("#sDepts").datagrid({
                pageSize: pageSize,
                pageNumber: pageNum
            });

            $("#sDepts").datagrid("loadData", GetPagedDepts(currdepts, pageSize, pageNum));

            var pager = $("#sDepts").datagrid("getPager");

            pager.pagination({
                showRefresh: false,
                total: currdepts.length,
                pageSize: pageSize,
                pageNumber: pageNum,
                onSelectPage: function (pageNum, pageSize) {
                    LoadDeptsInDataGrid(currdepts, pageNum, pageSize);
                }
            });
        }

        function IndexOfArray(array, field, value) {
            for (var i = 0; i < array.length; i++) {
                if (array[i][field] == value) {
                    return i;
                }
            }

            return -1;
        }

        function DeleteSelectedDepts(deleteall) {
            var sdepts = new Array();
            var opts = $("#sDepts").datagrid("options");

            if (!deleteall) {
                var idx;
                var node;

                sdepts = $("#sDepts").datagrid("getChecked");

                $.each(sdepts, function () {
                    idx = IndexOfArray(nodedepts, "No", this.No);

                    if (idx != -1) {
                        nodedepts.splice(idx, 1);
                    }

                    //删除树中勾选项
                    node = $("#treeDepts").tree("find", "DEPT_" + this.No);

                    if (node) {
                        $("#treeDepts").tree("uncheck", node.target);
                    }
                });
                //todo:如果是检索结果下删除选中行后，剩下的结果应当仍然显示检索结果集下的，待处理
                LoadDeptsInDataGrid(nodedepts, opts.pageNumber, opts.pageSize);
                return;
            }

            $.messager.confirm("提示", "您确定要删除所有已经选择的部门吗？", function (r) {
                if (r) {
                    nodedepts.splice(0, nodedepts.length);

                    if ($("#sDepts").datagrid("getData").total > 0) {
                        LoadDeptsInDataGrid(nodedepts, 1, opts.pageSize);
                    }

                    //删除树中勾选项
                    $.each(deptsubs, function () {
                        node = $("#treeDepts").tree("find", "DEPT_" + this.No);

                        if (node && node.checked) {
                            $("#treeDepts").tree("uncheck", node.target);
                        }
                    });
                }
            });
        }

        function Save() {
            var param = {
                DoType: "Dot2DotTreeDeptModel_SaveNodeDepts",
                data: '|',
                nodeid: nodeid
            };

            $("#save").linkbutton("disable");

            //组织数据
            var i = 1;

            $.each(nodedepts, function () {
                param.data += this.No + "|";

                //500个分一段保存
                if (i % 500 == 0) {
                    savedatas.push(param.data);
                    param.data = '|';
                }

                i++;
            });

            if (param.data.length > 1) {
                savedatas.push(param.data);
            }
            else {
                param.data = savedatas.shift();

                Handler_AjaxQueryData(param, function (data, scope) {
                    $("#save").linkbutton("enable");

                    if (data.indexOf("err@") != -1) {
                        alert(data);
                        return;
                    }

                    var redata = eval('(' + data + ')');
                    alert(redata.Msg);
                    ShowSelectedDepts();
                }, this);
                return;
            }

            partidx = 1;
            partcount = savedatas.length;
            param.partno = partidx + "/" + partcount;
            param.data = savedatas.shift();

            SavePart(param);
        }

        function SavePart(param) {
            Handler_AjaxQueryData(param, function (data, scope) {
                if (data.indexOf("err@") != -1) {
                    alert(data);
                    alert("保存过程中出现错误，已经保存部分数据，请手动刷新本页面，重新设置！");
                    $("#save").linkbutton("enable");
                    return;
                }

                var redata = eval('(' + data + ')');

                if (redata.InnerData.lastpart) {
                    alert(redata.Msg);
                    $("#save").linkbutton("enable");
                    partidx = 0;
                    partcount = 0;
                    ShowSelectedDepts();
                    return;
                }

                partidx++;

                if (savedatas.length > 0) {
                    param.partno = partidx + "/" + partcount;
                    param.data = savedatas.shift();
                    SavePart(param);
                }

            }, this);
        }

        function GetPagedDepts(depts, pagesize, pageidx) {
            var start = pagesize * (pageidx - 1);
            var end = pagesize * pageidx;

            if (depts.length - 1 < start) {
                start = depts.length - 1;
            }

            if (depts.length - 1 < end) {
                end = depts.length;
            }

            return { total: depts.length, rows: depts.slice(start, end) };
        }
    </script>
</head>
<body class="easyui-layout">
    <div data-options="region:'north'" style="width: 100%; height: 40px; padding: 5px;
        line-height: 30px;">
        <a id="save" href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save'"
            onclick="Save()">保存</a> <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-delete'"
                onclick="DeleteSelectedDepts(true)">清空选择</a> &nbsp;&nbsp;&nbsp;&nbsp;
    </div>
    <div data-options="region:'west',title:'选择部门'" style="width: 40%; padding: 5px;">
        <ul id="treeDepts" class="easyui-tree">
        </ul>
    </div>
    <div data-options="region:'center',title:'已选部门'" style="width: 60%; padding: 5px;">
        <table id="sDepts" class="easyui-datagrid" data-options="fit:true,fitColumns:true,singleSelect:false,rownumbers:true,
        toolbar:'#tb'">
            <thead>
                <tr>
                    <th data-options="field:'Checked',checkbox:true">
                        选
                    </th>
                    <th data-options="field:'No',width:80">
                        编号
                    </th>
                    <th data-options="field:'Name',width:80">
                        部门
                    </th>
                    <th data-options="field:'DeptName',width:140">
                        上级部门
                    </th>
                </tr>
            </thead>
        </table>
    </div>
    <div id="tb" style="line-height: 30px;">
        &nbsp; <a href="javascript:void(0)" onclick="ShowSelectedDepts()" class="easyui-linkbutton"
            data-options="iconCls:'icon-table'">显示已选部门</a> &nbsp;
        <input id="kw" class="easyui-textbox" onkeyup="" style="width: 80px" />
        <a href="javascript:void(0)" onclick="FilterDepts($('#kw').textbox('getValue'))"
            class="easyui-linkbutton" data-options="iconCls:'icon-search'">检索</a> &nbsp;<a href="javascript:void(0)"
                onclick="DeleteSelectedDepts(false)" class="easyui-linkbutton" data-options="iconCls:'icon-delete'">删除</a>
    </div>
</body>
</html>
