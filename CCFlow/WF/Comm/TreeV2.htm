<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>驰骋工作流</title>
    <!-- 引用通用的js文件. -->
    <script src="../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../Scripts/config.js" type="text/javascript"></script>
    <script src="../Scripts/bootstrap/js/jquery.min.js" type="text/javascript"></script>
    <script src="Gener.js" type="text/javascript"></script>
    <link href="../Scripts/EasyUI/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../Scripts/EasyUI/themes/default/tree.css" rel="stylesheet" type="text/css" />
    <link href="../Scripts/EasyUI/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script src="../Scripts/EasyUI/jquery.easyui.min.js" type="text/javascript"></script>
    <script type="text/javascript" language="javascript" >

        //定义公共个变量.
        //var webUser = new WebUser();

        //页面启动函数.
        $(function () {

//            if (webUser.No == undefined) {
//                alert('登录信息丢失，请重新登录。');
//                return;
//            }

            var ensName = GetQueryString("EnsName");

            if (ensName == null || ensName == undefined) {
                $("#Msg").html("必要的参数EnsName没有传入.");
                return;
            }

            $("#Msg").html("<img src=../Img/loading.gif />&nbsp;正在加载,请稍后......");

            //加载菜单树  绑定数据.
            LoadBindTree();

            $("#Msg").html("");
        });

       //加载菜单树  绑定数据.
       function LoadBindTree() {

           //创建处理器.
           var handler = new HttpHandler("BP.WF.HttpHandler.WF_Comm");
           handler.AddUrlData();  //增加参数.
           var treeJson = handler.DoMethodReturnString("Tree_Init"); //获得map基本信息.

           //绑定树结构.
           var pushData = eval('(' + treeJson + ')');
           //加载类别树
           $("#enTree").tree({
               data: pushData,
               iconCls: 'tree-folder',
               collapsed: true,
               lines: true
           });
           $("#enTree").bind('contextmenu', function (e) {
               e.preventDefault();
               $('#treeMM').menu('show', {
                   left: e.pageX,
                   top: e.pageY
               });
           });
       }

       //创建同级节点.DoMyCreateSameLevelNode
       function DoMyCreateSameLevelNode(no) {
           var node = $('#enTree').tree('getSelected');
           if (node) {
               var handler = new HttpHandler("BP.WF.HttpHandler.WF_Comm");
               handler.AddPara("nodeNo", node.id);
               var data = handler.DoMethodReturnString("DoMyCreateSameLevelNode");
               var pushData = eval('(' + data + ')');
               var parentNode = $('#enTree').tree('getParent', node.target);
               $('#enTree').tree('append', {
                    parent: (parentNode ? parentNode.target : null),
                    data:[{
                        id:pushData.No,
                        text:pushData.Name,
                        iconCls: 'tree_folder'
                    }]
               });
           }else {
               $.messager.alert('提示', '请选择节点!', 'info');
           }
       }

       //创建下级节点.
       function DoMyCreateSubNode(no) {
           var node = $('#enTree').tree('getSelected');
           if (node) {
               var handler = new HttpHandler("BP.WF.HttpHandler.WF_Comm");
               handler.AddPara("nodeNo", node.id);
               var data = handler.DoMethodReturnString("DoMyCreateSubNode");
               var pushData = eval('(' + data + ')');
               $('#enTree').tree('append', {
                   aprent: (node ? node.target : null),
                   data: [{
                       id: pushData.No,
                       text: pushData.Name,
                       iconCls: 'tree_folder'
                   }]
               });
           } else {
               $.messager.alert('提示', '请选择节点!', 'info');
           }
       }

       //修改
       function Edit(no) {
           var node = $('#enTree').tree('getSelected');
           if (node) {
               var handler = new HttpHandler("BP.WF.HttpHandler.WF_Comm");
               handler.AddPara("nodeNo", node.id);

               var url = "En.htm?EnName=" + GetEnName() + "&No=" + node.id;

               WinOpen(url, "编辑", "height=900, width=800, top=0, left=0, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");
               
               
               var data = handler.DoMethodReturnString("DoMyCreateSubNode");
               if (data != "") {
                   $('#enTree').tree('update', { target: node.target, text: data });
               }
           } else {
               $.messager.alert('提示', '请选择节点!', 'info');
           }
           

       }
        
       //删除
       function Del(no, name) {
           var node = $('#enTree').tree('getSelected');
           if (confirm('您确认要删除[ ' + node.text + ' ]吗？') == false)
               return;
           
           if (node) {
               //删除
               var handler = new HttpHandler("BP.WF.HttpHandler.WF_Comm");
               handler.AddPara("nodeNo", node.id);
               var data = handler.DoMethodReturnString("Del");
               if (data.indexOf('err@') == 0) {
                   alert(data);
                   return;
               }

               $('#enTree').tree('remove', node.target);
               alert(data);
           } else {
               $.messager.alert('提示', '请选择节点。', 'info');
           }
       }

       // 执行节点移动. 上移
       function DoUp() {
           var node = $('#enTree').tree('getSelected');
           if (node) {
               var handler = new HttpHandler("BP.WF.HttpHandler.WF_Comm");
               handler.AddPara("nodeNo", node.id);
               var data = handler.DoMethodReturnString("DoUp");
               LoadBindTree();
               $('#enTree').tree('expandAll');
           } else {
               $.messager.alert('提示', '请选择节点。', 'info');
           }
       }

       // 执行节点移动. 下移
       function DoDown() {
           var node = $('#enTree').tree('getSelected');
           if (node) {
               var handler = new HttpHandler("BP.WF.HttpHandler.WF_Comm");
               handler.AddPara("nodeNo", node.id);
               var data = handler.DoMethodReturnString("DoDown");
               LoadBindTree();
               $('#enTree').tree('expandAll');
           } else {
               $.messager.alert('提示', '请选择节点。', 'info');
           }
       }

       
       //获得enName.
       function GetEnName() {

           var ensName = GetQueryString("EnsName");
           return ensName.substring(0, ensName.length - 1);
       }
    </script>
</head>
<body  >
<form id="cc">
    <div data-options="region:'center'"style="overflow: hidden;">
        <div style="padding: 0px; background: #fafafa; width: 100%;">
            <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-new'" onclick="DoMyCreateSameLevelNode();">新建同级</a> 
            <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-new'" onclick="DoMyCreateSubNode();">新建下级</a> 
            <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-edit'" onclick="Edit();">修改</a> 
            <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-cancel'" onclick="Del();">删除</a> 
            <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-up'" onclick="DoUp();">上移</a> 
            <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-down'" onclick="DoDown();">下移</a>
        </div>
        <ul id="enTree" class="easyui-tree-line" data-options="animate:false,dnd:false"  style="width:400px;">
        </ul>
        
     </div>

<br />

</form>

</body>
</html>
