<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script type="text/javascript" src="Scripts/bootstrap/js/jquery.min.js"></script>
    <script src="Comm/JScript.js" type="text/javascript"></script>
    <script src="Comm/JS/TBHelpDiv.js" type="text/javascript"></script>
    <script src="CCForm/MapExt.js" type="text/javascript"></script>
    <script src="../DataUser/JSLibData/MyFlowPublic.js" type="text/javascript"></script>
    <script src="Style/Frm/jquery.idTabs.min.js" type="text/javascript"></script>
    <script src="Comm/JS/Calendar/WdatePicker.js" type="text/javascript"></script>
    <script type="text/javascript" src="Scripts/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="Scripts/bootstrap/js/jquery.cokie.min.js"></script>
    <script type="text/javascript" src="Scripts/Cookie.js"></script>
    <script type="text/javascript" src="Scripts/MyFlow.js"></script>
    <script type="text/javascript" language="javascript" src="../DataUser/PrintTools/LodopFuncs.js"></script>
    <script type="text/javascript" language="javascript" src="Scripts/MyFlow.js"></script>
    <script type="text/javascript" src="Scripts/QueryString.js"></script>
    <script type="text/javascript" src="MyFlow.js"></script>
    <link href="Comm/JS/Calendar/skin/WdatePicker.css" rel="stylesheet" type="text/css" />
    <link href="Scripts/bootstrap/css/bootstrap.css" rel="Stylesheet" />
    <link href="../DataUser/Style/MyFlow.css" rel="Stylesheet" />
    <link href="../DataUser/Style/Table0.css" rel="Stylesheet" />
    <link href="../DataUser/Style/WFWinOpen.css" rel="Stylesheet" />
    <link href="../DataUser/Style/WinOpenEUI.css" rel="Stylesheet" />


    <script src="Scripts/jBox/jquery.jBox-2.3.min.js" type="text/javascript"></script>
    <link href="Scripts/jBox/Skins/Blue/jbox.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        body {
            padding: 0px;
            margin: 0px;
        }
    </style>

    <!--杨玉慧-->
    <script type="text/javascript">
        //FK_Flow=005&UserNo=zhwj&DoWhat=StartClassic&=&IsMobile=&FK_Node=501
        var pageData = {};
        var globalVarList={};

        $(function () {
            initPageParam(); //初始化参数
            initBar(); //工具栏.
            //InitFormTest();
            GenerWorkNode(); //表单数据.
        });

        function InitFormTest() {

            var CCFormHtml = '';
            var groupObj = {};//KEY VALUE mapAttrData.Sys_GroupField[0].OID
            var workNodeData = JSON.parse(jsonStr);
            //解析分组
            var groupFileds = workNodeData.Sys_GroupField;

            for (var i = 0; i < groupFileds.length; i++) {
                var groupFiled = groupFileds[i];
                var groupHtml = '<div class="col-md-12" style="clear:both;">' + groupFiled.Lab + '</div>';
                /*根据控件类型解析分组*/
                switch (groupFiled.CtrlType) {
                    case "Frame":// 框架 类型.
                        continue;
                    case "Dtl"://增加从表.
                        continue;
                    case "Ath"://增加附件.
                        continue;
                    case "FWC"://审核组件.
                        continue;
                    case "SubFlow"://子流程..
                        continue;
                    case "Track"://轨迹图..
                        continue;
                    case "Thread"://子线程..
                        continue;
                    case "FTC": //流转自定义.
                        continue;
                    default:
                        break;
                }


                //其它的就是字段分组
                //过滤属于本分组的字段
                var mapAttrData = $.grep(workNodeData.Sys_MapAttr, function (value) {
                    return value.GroupID == groupFiled.OID;
                    //return value.LGType == 1 || value.LGType == 2;
                });


                //开始解析表单字段
                for (var j = 0; j < mapAttrData.length; j++) {
                    var mapAttr = mapAttrData[j];
                    if (mapAttr.UIVisible) {//是否显示

                        //添加 label
                        //如果是整行的需要添加  style='clear:both'

                        var str = '';
                        var defValue = ConvertDefVal(workNodeData, mapAttr.DefVal, mapAttr.KeyOfEn);
                        for (var o in mapAttr) {
                            str += o + ":" + mapAttr[o];
                        }

                        var eleHtml = '';
                        var isInOneRow = false;//是否占一整行
                        var islabelIsInEle = false;//



                        if (mapAttr.UIIsInput == 1) {//必填
                            eleHtml += '<span style="color:red">*</span>';
                        }

                        eleHtml += '</label></div>';

                        //添加文本框 ，日期控件等
                        //AppString   
                        if (mapAttr.MyDataType == "1" && mapAttr.LGType != "2") {//不是外键
                            if (mapAttr.ColSpan == 2 || mapAttr.ColSpan == 1 || mapAttr.ColSpan == 3) {//占有1-2  3列的文本框
                                var mdCol = 2;
                                var smCol = 4;
                                switch (mapAttr.ColSpan) {
                                    case 1:
                                        mdCol = 2;
                                        smCol = 4;
                                        break;
                                    case 2:
                                        mdCol = 4;
                                        smCol = 8;
                                        break;
                                    case 3:
                                        mdCol = 11;
                                        smCol = 10;
                                        isInOneRow = true;
                                        break;
                                }
                                if (mapAttr.UIContralType == "1") {//DDL 下拉列表框
                                    eleHtml += '<div class="col-lg-' + mdCol + ' col-md-' + mdCol + ' col-sm-' + smCol + '">' +
                                        "<select name='DDL_" + mapAttr.KeyOfEn + "' value='" + ConvertDefVal(workNodeData,mapAttr.DefVal,mapAttr.KeyOfEn) + "' " + (mapAttr.UIIsEnable ? '' : 'disabled="disabled"') + ">" + InitDDLOperation(workNodeData, mapAttr,defValue) + "</operation>";
                                    eleHtml += '</div>';
                                } else {//文本区域
                                    if (mapAttr.UIHeight == 23) {
                                        eleHtml += '<div class="col-lg-' + mdCol + ' col-md-' + mdCol + ' col-sm-' + smCol + '">' +
                                            "<input name=TB_'" + mapAttr.KeyOfEn + "' type='text' value='" + defValue + "' " + (mapAttr.UIIsEnable ? '' : ' disabled="disabled"') + "/>"
                                            + '</div>';
                                    }
                                    else {//大于23就是多行
                                        if (mapAttr.ColSpan == 1 || mapAttr.ColSpan == 2) {
                                            mdCol = 4;
                                            smCol = 12;
                                        }
                                        islabelIsInEle = true;
                                        eleHtml += '<div class="col-lg-' + mdCol + ' col-md-' + mdCol + ' col-sm-' + smCol + '">'
                                            + "<label>" + mapAttr.Name + "</label>"
                                            +
                                            "<textarea style='height:"+mapAttr.UIHeight+"px;' name=TB_'" + mapAttr.KeyOfEn + "' type='text' value='" + defValue + "'" + (mapAttr.UIIsEnable ? '' : ' disabled="disabled"') + "/>"
                                            + '</div>';

                                    }
                                }
                            } else if (mapAttr.ColSpan == "4" || (mapAttr.ColSpan == "3" && mapAttr.UIHeight > 23)) {//大文本区域  且占一整行
                                isInOneRow = true;
                                eleHtml += '<div class="col-lg-11 col-md-11 col-sm-10">' +
                                    "<textarea name='TB_" + mapAttr.KeyOfEn + "'" + (mapAttr.UIIsEnable ? '' : ' disabled="disabled"') + ">" + defValue + "</textarea>"
                                    + '</div>';
                            }
                        } //AppDate
                        else if (mapAttr.MyDataType == 6) {//AppDate
                            var enableAttr = '';
                            if (mapAttr.UIIsEnable == 1) {
                                enableAttr = 'onfocus="WdatePicker("' + ")" + '";';
                            } else {
                                enableAttr = "disabled='disabled'";
                            }
                            eleHtml += '<div class="col-lg-2 col-md-2 col-sm-4 col-xs-8">' + "<input type='text' class='TBcalendar'" + enableAttr + " name='TB_" + mapAttr.KeyOfEn + "'/>" + defValue + "</div>";
                        }
                        else if (mapAttr.MyDataType == 7) {// AppDateTime = 7
                            var enableAttr = '';
                            if (mapAttr.UIIsEnable == 1) {
                                enableAttr = 'onfocus="WdatePicker({dateFmt:' + "'yyyy-MM-dd HH:mm'})" + '";';
                            } else {
                                enableAttr = "disabled='disabled'";
                            }
                            eleHtml += '<div class="col-lg-2 col-md-2 col-sm-4 col-xs-8">' + "<input type='text' class='TBcalendar'" + enableAttr + " name='TB_" + mapAttr.KeyOfEn + "' value='" + defValue + "'/>" + "</div>";
                        }
                        else if (mapAttr.MyDataType == 4) {// AppBoolean = 7
                            var colMd = 2;
                            var colsm = 4;
                            if (mapAttr.ColSpan == 4 || mapAttr.ColSpan == 3) {
                                colMd = 4;
                                colsm = 8;
                            }

                            if (mapAttr.UIIsEnable == 1) {
                                enableAttr = "onfocus='WdatePicker({dateFmt:'yyyy-MM-dd HH:mm'});'";
                            } else {
                                enableAttr = "disabled='disabled'";
                            }
                            //CHECKBOX 默认值
                            eleHtml += '<div class="col-lg-' + colMd + ' col-md-' + colMd + ' col-sm-' + colsm + '">' + "<input " + (defValue == 1 ? "checked='checked'" : "") + " type='checkbox' name='CB_" + mapAttr.KeyOfEn + "' " + checkedStr + "/>" + "</div>";
                        }

                        if (mapAttr.MyDataType == 2 && mapAttr.LGType == 1) { //AppInt Enum
                            var colMd = 2;
                            var colsm = 4;
                            if (mapAttr.ColSpan == 4 || mapAttr.ColSpan == 3) {
                                colMd = 11;
                                colsm = 10;
                            }
                            if (mapAttr.UIContralType == 1) {//DDL
                                eleHtml += '<div class="col-lg-' + colMd + ' col-md-' + mdCol + ' col-sm-' + colsm + '">' +
                                        "<select name='DDL_" + mapAttr.KeyOfEn + "' " + (mapAttr.UIIsEnable ? '' : 'disabled="disabled"') + ">" + InitDDLOperation(workNodeData, mapAttr,defValue) + "</select>";
                                + '</div>';
                                eleHtml += "</div>";
                            }

                            if (mapAttr.UIContralType == 3) {//RadioBtn
                                var operations = '';
                                eleHtml += '<div class="col-md-2 col-sm-4 col-lg-2">';
                                if (mapAttr.ColSpan == 1) {
                                    var enums = workNodeData.Sys_Enum;
                                    enums = $.grep(enums, function (value) {
                                        return value.EnumKey == mapAttr.UIBindKey;
                                    });

                                    var rbShowModel = 0;//RBShowModel=0时横着显示RBShowModel=1时竖着显示
                                    var showModelindex = mapAttr.AtPara.indexOf('@RBShowModel=');
                                    if (showModelindex >= 0) {//@RBShowModel=0
                                        rbShowModel = mapAttr.AtPara.substring('@RBShowModel='.length, '@RBShowModel='.length + 1);
                                    }
                                    $.each(enums, function (i, obj) {
                                        operations += "<input type='radio' " + (obj.IntKey == defValue ? " checked='checked' " : "") + "  name='RB_" + mapAttr.KeyOfEn + "' value='" + obj.IntKey + "'>" + obj.Lab + "</input>" + (rbShowModel == "1" ? "</br>" : '');
                                    });
                                }
                                eleHtml += operations;
                                eleHtml += "</div>";
                            }

                            if (mapAttr.ColSpan == 3) {
                                var operations = '';
                                isInOneRow = true; 
                                eleHtml += '<div class="col-md-11 col-sm-10 col-lg-11">';
                                if (mapAttr.ColSpan == 1) {
                                    //外键类型
                                    var enums = workNodeData.Sys_Enum;
                                    enums = $.grep(enums, function (value) {
                                        return value.EnumKey == mapAttr.UIBindKey;
                                    });

                                    var rbShowModel = 0;//RBShowModel=0时横着显示RBShowModel=1时竖着显示
                                    var showModelindex = mapAttr.AtPara.indexOf('@RBShowModel=');
                                    if (showModelindex >= 0) {//@RBShowModel=0
                                        rbShowModel = mapAttr.AtPara.substring('@RBShowModel='.length, '@RBShowModel='.length + 1);
                                    }
                                    $.each(enums, function (i, obj) {
                                        operations += "<input type='radio'" + (obj.IntKey == defValue ? " checked='checked' " : "") + "  name='RB_" + mapAttr.KeyOfEn + "' id='" + "RB_" + mapAttr.KeyOfEn + "_" + obj.IntKey + "' value='" + obj.IntKey + "'>" + obj.Lab + "</input>" + (rbShowModel == "1" ? "</br>" : '');
                                    });
                                }
                                eleHtml += operations;
                                eleHtml += "</div>";
                            }
                        }
                        // AppDouble  AppFloat AppInt .
                        if (mapAttr.MyDataType == 5 ||
                        mapAttr.MyDataType == 3 ||
                        (mapAttr.MyDataType == 2 && mapAttr.LGType != 1)
                    ) {
                            var enableAttr = '';
                            if (mapAttr.UIIsEnable == 1) {

                            } else {
                                enableAttr = "disabled='disabled'";
                            }
                            eleHtml += '<div class="col-lg-2 col-md-2 col-sm-4 col-xs-8">' + "<input value='" + defValue + "' type='text'" + enableAttr + " name='TB_" + mapAttr.KeyOfEn + "'/>" + "</div>";
                        }
                        //AppMoney  AppRate
                        if (mapAttr.MyDataType == 8) {
                            var enableAttr = '';
                            if (mapAttr.UIIsEnable == 1) {

                            } else {
                                enableAttr = "disabled='disabled'";
                            }
                            eleHtml += '<div class="col-lg-2 col-md-2 col-sm-4 col-xs-8">' + "<input value='" + defValue + "' type='text'" + enableAttr + " name='TB_" + mapAttr.KeyOfEn + "'/>" + "</div>";
                        }

                        if (mapAttr.LGType == 2) {
                            var mdCol = 2;
                            var smCol = 4;
                            if (mapAttr.ColSpan == 4 || mapAttr.ColSpan == 3) {
                                mdCol = 4;
                                smCol = 8;
                            }

                            eleHtml += '<div class="col-lg-' + mdCol + ' col-md-' + mdCol + ' col-sm-' + smCol + '">' +
                                        "<select name='DDL_" + mapAttr.KeyOfEn + "' value='" + defValue + "'" + (mapAttr.UIIsEnable ? '' : 'disabled="disabled"') + ">" + InitDDLOperation(workNodeData, mapAttr) + "</select>";

                            eleHtml += '</div>';
                        }

                        if (!islabelIsInEle) {
                            eleHtml = '<div data-tag=' + str + ' class="col-lg-1 col-md-1 col-sm-2 col-xs-4" ' + (isInOneRow ? "style='clear:left;'" : "") + '><label>' + mapAttr.Name + eleHtml;
                        }
                        groupHtml += eleHtml;
                    }
                }

                CCFormHtml += groupHtml;
            }
            //解析字段


            $('#CCForm').html(CCFormHtml);
        }

        //初始化下拉列表框的OPERATION
        function InitDDLOperation(workNodeData, mapAttr,defVal) {
            var operations = '';
            //外键类型
            if (mapAttr.LGType == 2 && workNodeData[mapAttr.UIBindKey] != undefined) {
                $.each(workNodeData[mapAttr.UIBindKey], function (i, obj) {
                    operations += "<option " + (obj.IntKey == defVal ? " selected='selected' " : "") + " value='" + obj.No + "'>" + obj.Name + "</option>";
                });
            } else {
                var enums = workNodeData.Sys_Enum;
                enums = $.grep(enums, function (value) {
                    return value.EnumKey == mapAttr.UIBindKey;
                });


                $.each(enums, function (i, obj) {
                    operations += "<option " + (obj.IntKey == defVal ? " selected='selected' " : "") + " value='" + obj.IntKey + "'>" + obj.Lab + "</option>";
                });

            }
            return operations;
        }


        //将全局变量 和节点数据值 转换成表单默认值进行填充
        function ConvertDefVal(workNodeData, defVal, keyOfEn) {
            var result = defVal;
            //应用的是系统变量
            if (result.indexOf('@') == 0) {
                for (var ele in workNodeData.MainTable[0]) {
                    if (result == '@' + ele) {
                        return workNodeData.MainTable[0][ele];
                    }
                }
            }
                //上一节点表单遗留
            else {
                for (var ele in workNodeData.MainTable[0]) {
                    if (keyOfEn == ele) {
                        return workNodeData.MainTable[0][ele];
                    }
                }
            }
            return result;
        }
        //表单数据.
        function GenerWorkNode() {

            $.ajax({
                type: 'post',
                async: true,
                data: pageData,
                url: "MyFlow.ashx?Method=GenerWorkNode&m=" + Math.random(),
                dataType: 'html',
                success: function (data) {
                    alert(data)
                    jsonStr = data;
                    alert(data)
                    InitFormTest();
                    alert(data);
                }
            });
        }

        //发送
        function Send() {
            var formss = $('#divCCForm').serialize();
            var textareas = $('textarea').serialize();
            var selects = $('select').serialize();

            var dataArr = [];
            if (pageData != undefined) {
                var pageDataArr = [];
                for (var data in pageData) {
                    pageDataArr.push(data + '=' + pageData[data]);
                }
                dataArr.push(pageDataArr.join('&'));
            }
            if (formss != '')
                dataArr.push(formss);
            if (textareas != '')
                dataArr.push(textareas);
            if (selects != '')
                dataArr.push(selects);

            var formData = dataArr.join('&');

            $.ajax({
                type: 'post',
                async: true,
                data: formData,
                url: "MyFlow.ashx?Method=Send",
                dataType: 'html',
                success: function (data) {
                }
            });
        }
    </script>
</head>
<body>
    <!--标题-->
    <div id="header" style="height:50px;font-size:20px; background:#213b5d;color:white;padding:10px;">
        <span style="">处理人处理</span>
    </div>
    <!--上半部分表单-->
    <div id="topContentDiv" class="row">
        <div id="contentDiv">
            <form id="divCCForm" action="MyFlow.ashx?method=login" method="post">
                <!--LODOP_OB 先放着 不知道具体是什么-->
                <div>
                    <object id="LODOP_OB" classid="clsid:2105C259-1E0C-4534-8141-A753534CB4CA" width="0" height="0">
                        <embed id="LODOP_EM" type="application/x-print-lodop" width="0" height="0" pluginspage="/DataUser/PrintTools/install_lodop32.exe" />
                    </object>
                </div>
                <!--头部功能按钮 发送、移交-->
                <div class="topBar" id="topBar">
                    <!-- <uc3:ToolBar ID="ToolBar1" runat="server" />-->
                </div>
                <!--flowInfo-->
                <div class="flowInfo" id="flowInfo">
                    <!--<uc1:Pub ID="Pub1" runat="server" />-->
                </div>
                <!--Message-->
                <div class="Message" id='Message'>
                    <!--<uc1:Pub ID="FlowMsg" runat="server" />-->
                </div>
                <!--childThread-->
                <div class="childThread" id='childThread'>
                    <!--<uc1:Pub ID="Pub3" runat="server" />-->
                </div>
                <!--主表单--><!--<uc2:UCEn ID="UCEn1" runat="server" />-->
                <div id="CCForm">
                    <div class="col-lg-1  col-md-1 col-sm-2">
                        <label>事件标题</label>
                    </div>
                    <div class="col-md-2">
                        <input type="text" placeholder="事件标题" name="TXB_Title" value=""/>
                    </div>
                    <div class="col-lg-1  col-md-1 col-sm-2"><label>事件标题</label></div>
                    <div class="col-md-2">
                        <input type="text" placeholder="事件标题" name="BillNo" value=""/>
                    </div>
                    <div class="col-md-2">
                        <textarea placeholder="事件详述" name="detail" value=""></textarea>
                    </div>
                    <div class="col-md-2">
                        <textarea placeholder="事件详述" name="detail1" value=""></textarea>
                    </div>
                    <div class="col-md-2">
                        <select name="select">
                            <option value="1">1</option>
                            <option value="2">1</option>
                            <option value="3">1</option>
                            <option value="4">1</option>
                            <option value="5">1</option>
                        </select>
                        <select name="select1">
                            <option value="1">1</option>
                            <option value="2">1</option>
                            <option value="3">1</option>
                            <option value="4">1</option>
                            <option value="5">1</option>
                        </select>
                        <select name="select2">
                            <option value="1">1</option>
                            <option value="2">1</option>
                            <option value="3">1</option>
                            <option value="4">1</option>
                            <option value="5">1</option>
                        </select>
                    </div>
                </div>
                <!--Pub2 -->
                <div class="pub2Class" id="pub2Class">
                    <!-- <uc1:Pub ID="Pub2" runat="server" />-->
                </div>
                <!--底部功能按钮 发送、移交-->
                <div id="bottomToolBar" style="display: block;" class="Bar">
                </div>
            </form>
        </div>
    </div>

    <!-- /.modal  模态框-->
    <div class="modal fade" id="myModal">
        <div class="modal-dialog" style="width:100%;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Modal title</h4>
                </div>
                <div class="modal-body">
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
</body>
</html>
