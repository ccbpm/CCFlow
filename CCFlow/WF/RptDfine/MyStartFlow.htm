<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <title>绑定列表</title>
    <link href="../Comm/Style/Table0.css" rel="stylesheet" type="text/css" />
    <link href="../Scripts/easyUI145/themes/icon.css" rel="stylesheet" type="text/css" />
    <link href="../Scripts/easyUI145/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/easyUI145/jquery.min.js" type="text/javascript"></script>
    <script src="../Scripts/easyUI145/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../Scripts/easyUI145/locale/easyui-lang-zh_CN.js"></script>
    <script src="../Scripts/QueryString.js" type="text/javascript"></script>
    <script src="../Scripts/config.js" type="text/javascript"></script>
    <script language="JavaScript" src="../Comm/JScript.js" type="text/javascript"></script>
    <script src="../Scripts/CommonUnite.js" type="text/javascript"></script>
    <script src="../Scripts/EasyUIUtility.js" type="text/javascript"></script>
    <script src="../Comm/Gener.js" type="text/jscript"></script>
    <style type="text/css">
        .conditions{
            line-height:35px;
        }

        .conditions input[type='text']{
            line-height:30px;
        }

        .conditions.hide {
            display: none;
        }

        .conditions .con-span {
            display: inline-block;
            width: 70px;
        }
    </style>
    <script type="text/javascript">
        var sinfo;
        var FilterCtrls = new Array();
        var rptNo = GetQueryString("RptNo");
        var fk_flow = GetQueryString("FK_Flow");
        var md;
        var buttons = $.extend([], $.fn.datebox.defaults.buttons);
        var refidx = 0;

        buttons.splice(1, 0, {
            text: '清空',
            handler: function (target) {
                $(target).datebox('clear');
                $(target).datebox('hidePanel');
            }
        });

        $(function () {
            var param = {
                DoType: "MyStartFlow_Init",
                RptNo: rptNo,
                FK_Flow: fk_flow,
                PageSize: $("#dg").datagrid("options").PageSize
            };

            Handler_AjaxQueryData(param, function (data) {

                if (data.indexOf("err@") != -1) {
                    $.messager.alert("错误", data, "icon-error");
                    return;
                }

                var d = sinfo = eval("(" + data + ")");
                md = d.Sys_MapData[0];

                if (md.RptIsSearchKey) {
                    $("#tb_main").prepend('<span class="con-span">关键字: </span><input type="text" id="tb_key" style="width:166px;" />');
                    $("#tb_key").textbox().textbox("setText", md.T_SearchKey);
                }

                if (md.RptDTSearchWay != 0) {
                    $("#btn_search").before('<span class="con-span">' + md.T_DateLabel + '从: </span><input type="text" id="tb_dtFrom" style="width:166px;" />');
                    $("#tb_dtFrom").after('<span class="con-span">到: </span><input type="text" id="tb_dtTo" style="width:166px;" />');

                    if (md.RptDTSearchWay == 1) {
                        $("#tb_dtFrom").datebox({ buttons: buttons }).datebox("setValue", md.T_DTFrom);
                        $("#tb_dtTo").datebox({ buttons: buttons }).datebox("setValue", md.T_DTTo);
                    }
                    else {
                        $("#tb_dtFrom").datetimebox({ buttons: buttons }).datetimebox("setValue", md.T_DTFrom);
                        $("#tb_dtTo").datetimebox({ buttons: buttons }).datetimebox("setValue", md.T_DTTo);
                    }
                }

                $("#btn_search").css("visibility", "visible");
                $("#btn_reset").css("visibility", "visible");

                $("#btn_search").after('&nbsp;&nbsp;<a href="javascript:void(0)" iconCls="icon-excel" id="btn_export">导出</a>');
                $("#btn_export").linkbutton();

                if (d.FilterCtrls.length > 0) {
                    $("#tb_main").append('<a href="javascript:void(0)" class="more" iconCls="icon-more" id="btn_more">更多</a>');
                    $("#btn_more").linkbutton();

                    $(".more").click(function () {
                        $(this).closest(".conditions").siblings().toggleClass("hide");
                        $("#dg").datagrid("resize");
                    });

                    //filters
                    var ctrl;
                    var fcId;
                    $.each(d.FilterCtrls, function (idx, c) {
                        ctrl = '<span class="con-span">' + c.Name + ': </span>';

                        switch (c.Type) {
                            case "date":
                                fcId = "D_" + c.ID;
                                ctrl += '<input type="text" id="' + fcId + '" style="width:166px;" />';
                                $("#filters").append(ctrl);
                                $("#" + fcId).datebox({ buttons: buttons }).datebox("setValue", c.DefaultValue);
                                FilterCtrls.push({ type: c.Type, id: fcId });
                                break;
                            case "datetime":
                                fcId = "DT_" + c.ID;
                                ctrl += '<input type="text" id="' + fcId + '" style="width:166px;" />';
                                $("#filters").append(ctrl);
                                $("#" + fcId).datetimebox().datetimebox("setValue", c.DefaultValue);
                                FilterCtrls.push({ type: c.Type, id: fcId });
                                break;
                            case "text":
                                fcId = "TB_" + c.ID;
                                ctrl += '<input type="text" id="' + fcId + '" style="width:166px;" />';
                                $("#filters").append(ctrl);
                                $("#" + fcId).textbox({
                                    icons: [{
                                        iconCls: 'icon-clear',
                                        handler: function (e) {
                                            $(e.data.target).textbox('clear');
                                        }
                                    }]
                                }).textbox("setText", c.DefaultValue);
                                FilterCtrls.push({ type: c.Type, id: fcId });
                                break;
                            case "combo":
                                fcId = "DDL_" + c.ID;
                                ctrl += '<select id="' + fcId + '" style="width:166px;">';

                                $.each(d[c.ID.toUpperCase()], function (idx1, item) {
                                    ctrl += '<option value="' + item[c.ValueField.toUpperCase()] + '">' + item[c.TEXTFIELD.toUpperCase()] + '</option>';
                                });

                                ctrl += '</select>';
                                $("#filters").append(ctrl);
                                $("#" + fcId).combobox({
                                    multiple: true,
                                    onSelect: function (d) {
                                        var cmb = $(this);
                                        var vals = cmb.combobox('getValues');

                                        if (d.value == "all") {
                                            $.each(vals, function (idx2, val) {
                                                if (val == "all") {
                                                    return true;
                                                }

                                                cmb.combobox("unselect", val);
                                            });
                                        }
                                        else {
                                            cmb.combobox("unselect", "all");
                                        }
                                    }
                                });

                                if (c.DefaultValue) {
                                    if (c.DefaultValue.indexOf('..') != -1) {
                                        var vals = [];
                                        $.each(d[c.ID.toUpperCase()], function (idx1, item) {
                                            if (c.DefaultValue.indexOf('.' + item[c.ValueField.toUpperCase()] + '.') != -1) {
                                                vals.push(item[c.ValueField.toUpperCase()]);
                                            }
                                        });

                                        $("#" + fcId).combobox("setValues", vals);
                                    }
                                    else {
                                        $("#" + fcId).combobox("setValue", c.DefaultValue);
                                    }
                                }

                                FilterCtrls.push({ type: c.Type, id: fcId });
                                break;
                            case "combotree":
                                fcId = "DDL_" + c.ID;
                                ctrl += '<select id="' + fcId + '" style="width:166px;"></select>';
                                $("#filters").append(ctrl);
                                $("#" + fcId).combotree({
                                    checkbox: true,
                                    multiple: true,
                                    data: d[c.ID.toUpperCase()]
                                });

                                if (c.DefaultValue) {
                                    if (c.DefaultValue.indexOf('..') != -1) {
                                        var vals = [];
                                        $.each(d[c.ID.toUpperCase()], function (idx1, item) {
                                            if (c.DefaultValue.indexOf('.' + item[c.ValueField.toUpperCase()] + '.') != -1) {
                                                vals.push(item[c.ValueField.toUpperCase()]);
                                            }
                                        });

                                        $("#" + fcId).combotree("setValues", vals);
                                    }
                                    else {
                                        $("#" + fcId).combotree("setValue", c.DefaultValue);
                                    }
                                }

                                FilterCtrls.push({ type: c.Type, id: fcId });
                                break;
                            case "checkbox":
                                fcId = "CB_" + c.ID;
                                ctrl += '<input id="' + fcId + '" type="checkbox" />';
                                $("#filters").append(ctrl);
                                $("#" + fcId)[0].checked = c.DefaultValue;
                                FilterCtrls.push({ type: c.Type, id: fcId });
                                break;
                            default:
                                break;
                        }
                    });
                }

                //形成数据
                var cols = [];

                //增加列
                $.each(d.SYS_MAPATTR, function (idx, c) {
                    cols.push({
                        title: c.NAME,
                        field: c.NO.toUpperCase(),
                        width: c.WIDTH
                    });
                });

                $("#dg").datagrid({ columns: [cols], resizable: true });
                LoadData(d.MainData, md.T_total, $("#dg").datagrid("options").PageSize, 1);

                //btn events
                $("#btn_search").linkbutton({
                    onClick: function () {
                        Search($("#dg").datagrid("options").PageSize, 1);
                    }
                });
            }, this);
        });

        function Edit(rowIndex, rowData) {
            var url = "/WF/Comm/En.htm?EnsName=" + ensName + "&" + sinfo.PKField + "=" + rowData[sinfo.PKField] + "&inlayer=1&t=" + Math.random();
            OpenDialogAndCloseRefresh(url, "编辑", sinfo.Config.WinCardW, sinfo.Config.WinCardH, "icon-edit");
        }

        function Search(PageSize, PageIdx) {
            var key = "";
            var mvals = "";
            var vals = "";
            var val;
            var dtFrom = "";
            var dtTo = "";

            if ($("#tb_key").length > 0) {
                key = $("#tb_key").textbox("getText");
            }

            if ($("#tb_dtFrom").length > 0) {
                dtFrom = $("#tb_dtFrom").textbox("getText");
                dtTo = $("#tb_dtTo").textbox("getText");
            }

            $.each(FilterCtrls, function () {
                switch (this.Type) {
                    case "date":
                        val = $("#" + this.id).datebox("getValue");

                        if (val.length > 0) {
                            vals += "@" + this.id + "=" + val;
                        }
                        break;
                    case "datetime":
                        val = $("#" + this.id).datetimebox("getValue");

                        if (val.length > 0) {
                            vals += "@" + this.id + "=" + val;
                        }
                        break;
                    case "text":
                        val = $("#" + this.id).textbox("getText");

                        if (val.length > 0) {
                            vals += "@" + this.id + "=" + val;
                        }
                        break;
                    case "combo":
                    case "combotree":
                        val = $("#" + this.id).combobox("getValues");

                        if (val.length > 1) {
                            mvals += "@" + this.id.substr("DDL_".length) + "=" + JoinMVals(val);
                            vals += "@" + this.id + "=mvals";
                        }

                        if (val.length == 1) {
                            vals += "@" + this.id + "=" + val[0];
                        }
                        break;
                    case "checkbox":
                        val = $("#" + this.id)[0].checked ? 1 : 0;
                        vals += "@" + this.id + "=" + val;
                        break;
                }
            });

            var param = {
                DoType: "MyStartFlow_Search",
                FK_Flow: fk_flow,
                RptNo: rptNo,
                key: key,
                dtFrom: dtFrom,
                dtTo: dtTo,
                mvals: mvals,
                vals: vals,
                PageSize: PageSize,
                PageIdx: PageIdx
            };

            Handler_AjaxQueryData(param, function (data) {
                if (data.indexOf("err@") != -1) {
                    $.messager.alert("错误", data, "icon-error");
                    return;
                }

                var d = eval("(" + data + ")");

                LoadData(d.MainData, d.Sys_MapData[0].T_total, PageSize, PageIdx);
            }, this);
        }

        function LoadData(data, total, PageSize, PageIdx) {
            $("#dg").datagrid({
                PageSize: PageSize,
                pageNumber: PageIdx
            });

            $("#dg").datagrid("loadData", data);

            var pager = $("#dg").datagrid("getPager");

            pager.pagination({
                showRefresh: false,
                total: total,
                PageSize: PageSize,
                pageNumber: PageIdx,
                onSelectPage: function (pageNum, PageSize) {
                    Search(PageSize, pageNum);
                }
            });
        }

        function JoinMVals(mvals) {
            var j = "";

            $.each(mvals, function () {
                j += "." + this + ".";
            });

            return j;
        }

        function Reset() {
            if (md.RptIsSearchKey) {
                $("#tb_key").textbox("clear");
            }

            if (md.RptDTSearchWay != 0) {
                $("#tb_dtFrom").datebox("clear");
                $("#tb_dtTo").datebox("clear");
            }

            $.each(FilterCtrls, function () {
                switch (this.Type) {
                    case "date":
                        $("#" + this.id).datebox("clear");
                        break;
                    case "datetime":
                        $("#" + this.id).datetimebox("clear");
                        break;
                    case "text":
                        $("#" + this.id).textbox("clear");
                        break;
                    case "combo":
                    case "combotree":
                        $("#" + this.id).combobox("setValue", "all");
                        break;
                    case "checkbox":
                        $("#" + this.id)[0].checked = false;
                        break;
                }
            });
        }

        function closeDlg() {
            $("#eudlg").dialog("close");
        }
    </script>
</head>
<body class="easyui-layout">
    <div data-options="region:'center',border:false">
        <table class="easyui-datagrid" id="dg" title=" " data-options="PageSize:15,pageList:[15,30,50,100],toolbar:'#tb',fit:true,pagination:true,rownumbers:true"></table>
    </div>
    <div id="tb" style="padding: 0 15px;">
        <div class="conditions" id="tb_main">
            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-search" data-options="selected:true"
               id="btn_search" style="visibility: hidden">查询</a> <a href="javascript:void(0)" class="easyui-linkbutton"
                                                                    iconcls="icon-reload" id="btn_reset" style="visibility: hidden" onclick="Reset()">重置</a>
        </div>
        <div class="conditions hide" id="filters">
        </div>
    </div>
    <!--<div id="Msg">
    </div>-->
</body>
</html>
