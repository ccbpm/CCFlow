<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>待办</title>
    <script language="JavaScript" src="/WF/Comm/JScript.js" type="text/javascript" ></script>
    <script type="text/javascript" src="/WF/Scripts/bootstrap/js/jquery.min.js"></script>
    <script type="text/javascript" src="/WF/Scripts/bootstrap/js/bootstrap.min.js"></script>
    <script src="/WF/Scripts/QueryString.js" type="text/javascript"></script>
    <script src="/WF/Scripts/config.js" type="text/javascript"></script>
     <base target="_self" /> 
    <link href="../DataUser/Style/Table0.css" rel="stylesheet" type="text/css" />
     <style type="text/css">    
        a
        {
            color:#0066CC;
            text-decoration:none;
        }
        a:hover
        {
            color:#0084C5;
            text-decoration:underline;
        }
    </style>
    <script type="text/javascript">
        var NS4 = (document.layers);
        var IE4 = (document.all);
        var win = window;
        var n = 0;
        function findInPage(str) {

            alert(document.getElementById('string1'));
            str = document.getElementById('string1').value;
            //    alert(str);
            var txt, i, found;
            if (str == "")
                return false;
            if (NS4) {
                if (!win.find(str))
                    while (win.find(str, false, true))
                        n++;
                else
                    n++;
                if (n == 0)
                    alert("对不起！没有你要找的内容。");
            }
            if (IE4) {
                txt = win.document.body.createTextRange();
                for (i = 0; i <= n && (found = txt.findText(str)) != false; i++) {
                    txt.moveStart("character", 1);
                    txt.moveEnd("textedit");
                }
                if (found) {
                    txt.moveStart("character", -1);
                    txt.findText(str);
                    txt.select();
                    txt.scrollIntoView();
                    n++;
                }
                else {
                    if (n > 0) {
                        n = 0;
                        findInPage(str);
                    }
                    else
                        alert("对不起！没有你要找的内容。");
                }
            }
            return false;
        }

        function SetImg(appPath, id) {
            document.getElementById(id).src = appPath + 'WF/Img/Mail_Read.png';
        }

        function GroupBarClick(appPath, rowIdx) {
            var alt = document.getElementById('Img' + rowIdx).alert;
            var sta = 'block';
            if (alt == 'Max') {
                sta = 'block';
                alt = 'Min';
            } else {
                sta = 'none';
                alt = 'Max';
            }
            document.getElementById('Img' + rowIdx).src = appPath + 'WF/Img/' + alt + '.gif';
            document.getElementById('Img' + rowIdx).alert = alt;
            var i = 0
            for (i = 0; i <= 5000; i++) {
                if (document.getElementById(rowIdx + '_' + i) == null)
                    continue;

                if (sta == 'block') {
                    document.getElementById(rowIdx + '_' + i).style.display = '';
                } else {
                    document.getElementById(rowIdx + '_' + i).style.display = sta;
                }

            }
        }
        function WinOpenIt(url) {
            //窗口最大化e
            var scrWidth = screen.availWidth;
            var scrHeight = screen.availHeight;
            var self = window.open(url, '_blank', "resizable=1,scrollbars=yes");
            self.moveTo(0, 0);
            self.resizeTo(scrWidth, scrHeight);
            self.focus();
            // var newWindow = window.open(url, '_blank', 'height=600,width=850,top=50,left=50,toolbar=no,menubar=no,scrollbars=yes, resizable=yes,location=no, status=no');
            // newWindow.focus();
            return;
        }
    </script>
    

    <style type="text/css">
        table
        {
            font: 12px 宋体, Arial, Verdana;
        }
        .TRSum
        {
            font: 12px 宋体, Arial, Verdana;
        }
        .centerTitle th
        {
            text-align: center;
        }
        .Idx
        {
            font-size: 16px;
            font-family: Vijaya;
        }
    </style>
    <script language="javascript" type="text/javascript" >
        /* ESC Key Down */
        function Esc() {
            if (event.keyCode == 27)
                window.close();
            return true;
        }

        //页面启动函数.
        $(function () {

            $("#Msg").html("正在加载,请稍后......");

            InitPage();

            $("#Msg").html("");
        });

        //初始化数据.
        function InitPage() {

            var fk_node = GetQueryString("FK_Node");

            //初始化表格.
            $.ajax({
                type: 'post',
                async: true,
                url: Handler + "?DoType=Todolist_Init&FK_Node=" + fk_node + "&m=" + Math.random(),
                dataType: 'html',
                success: function (data) {

                    data = JSON.parse(data);

                    var timeKey = "ss";
                    //获取当前时间
                    var cdt = getNowFormatDate();
                    //增加处理.
                    for (var i = 0; i < data.length; i++) {

                        var newRow = "";
                        var title = data[i].Title;
                        var isRead = data[i].IsRead;
                        var flowNo = data[i].FK_Flow;
                        var flowName = data[i].FlowName;
                        var nodeName = data[i].NodeName;
                        var starterName = data[i].StarterName;
                        var pri = data[i].PRI;
                        var nodeID = data[i].FK_Node;
                        var fid = data[i].FID;
                        var workID = data[i].WorkID;
                        var paras = data[i].Paras;

                        newRow += "<tr > <td>" + (i + 1) + "</td>"; //序号
                        newRow += "<td><img class=Icon src='Img/PRI/" + pri + ".png' class=Icon /></td>"; //优先级
                        var url = "";
                        if (isRead == 0) {
                            url = "<a href=\"javascript:WinOpenIt('MyFlow.aspx?FK_Flow=" + flowNo + "&FK_Node=" + nodeID + "&FID=" + fid + "&WorkID=" + workID + "&IsRead=0&T=" + timeKey + "&Paras=" + paras + "');\" ><img class=Icon align='middle'  src='Img/Mail_UnRead.png' />" + title + "</a>";
                        } else {
                            url = "<a href=\"javascript:WinOpenIt('MyFlow.aspx?FK_Flow=" + flowNo + "&FK_Node=" + nodeID + "&FID=" + fid + "&WorkID=" + workID + "&IsRead=0&T=" + timeKey + "&Paras=" + paras + "');\" ><img class=Icon align='middle'  src='Img/Mail_Read.png' />" + title + "</a>";
                        }

                        newRow += "<td>" + url + "</td>"; //标题
                        newRow += "<td>" + flowName + "</td>"; //流程类别
                        newRow += "<td>" + nodeName + "</td>"; //节点名称
                        newRow += "<td>" + starterName + "</td>"; //发起人


                        newRow += "<td>" + data[i].RDT + "</td>"; //发起时间
                        newRow += "<td>" + data[i].ADT + "</td>"; //接受时间
                        newRow += "<td>" + data[i].SDT + "</td>"; //应完成时间
                        //判断流程是否逾期
                        if (cdt > data[i].SDT) {
                            newRow += "<td><img src='/WF/Img/TolistSta/2.png' class='Icon'/><font color=red>逾期</font></td>";
                        }
                        else {
                            newRow += "<td><img src='/WF/Img/TolistSta/0.png' class='Icon'/><font color=green>正常</font></td>";
                        }
                        //备注
                        newRow += "<td width='200'><div style='width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;' title='" + data[i].FlowNote + "'>" + data[i].FlowNote + "</div></td>";
                        newRow += "</tr>";

                        $("#Table1 tr:last").after(newRow);

                    }
                    $.ajax({
                        type: 'post',
                        async: false,
                        url: Handler + "?DoType=IsAuthorize&m=" + Math.random(),
                        dataType: 'html',
                        success: function (msg) {
                            if (msg.indexOf('err') == 0) {
//                                alert('没有授权!');
                            }
                            else {
                                $("#Table1").after("<div style='float:right;' ><a href=\"AutoTodolist.htm\" >查看授权人的待办工作</a></div>");
                            }
                        }
                    });
                    
                }
            });
        }
        //获取当前时间
        function getNowFormatDate() {
            var date = new Date();
            var seperator1 = "-";
            var seperator2 = ":";
            var month = date.getMonth() + 1;
            var strDate = date.getDate();
            if (month >= 1 && month <= 9) {
                month = "0" + month;
            }
            if (strDate >= 0 && strDate <= 9) {
                strDate = "0" + strDate;
            }
            //当前时间=年份-月份-日 小时：分钟
            var cdt = date.getFullYear() + seperator1 + month + seperator1 + strDate
            + " " + date.getHours() + seperator2 + date.getMinutes();

            return cdt;
        }
     </script>
</head>
<body onkeypress="Esc()" >
<table   id="Table1" width='100%'  cellspacing='0' cellpadding='0' align="left">
<caption ><div class='CaptionMsg' >待办</div></caption>
<tr class='centerTitle'>
<th>序</th>
<th>优先级</th>
<th>标题</th>
<th>流程</th>
<th>节点</th>
<th>发起人</th>
<th>发起日期</th>
<th>接受日期</th>
<th>应完成日期</th>
<th>状态</th>
<th>备注</th>
</tr>


</table>

<div id="Msg"></div>

</body>
</html>
