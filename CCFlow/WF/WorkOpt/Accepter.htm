<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>接受人选择器</title>
    <link href="../Scripts/bootstrap/css/bootstrap.css" rel="stylesheet" />
    <link href="../Scripts/bootstrap/css/components-rounded.css" rel="stylesheet" />
    <link href="../Scripts/bootstrap/css/font-awesome.css" rel="stylesheet" />
    <link href="../Scripts/bootstrap/css/themes/default/style.min.css" rel="stylesheet" />

    <script type="text/javascript" src="Scripts/bootstrap/js/jquery.min.js"></script>
    <script type="text/javascript" src="../Scripts/bootstrap/js/jquery.min.js"></script>
    <script type="text/javascript" src="../Scripts/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../Scripts/bootstrap/js/commonYangYH.js"></script>
    <script src="../Scripts/QueryString2016.js" type="text/javascript"></script>
    <script src="../Scripts/bootstrap/js/jquery.cokie.min.js"></script>
    <script type="text/javascript" src="../Scripts/config.js"></script>

    <!--
       杨玉慧.

    1. 初始化的标记是 ?DoType=AccepterInit&FK_Node=xxxx&ToNode=0&WorkID=xxxxx.  参数: WorkID
       返回的是 节点列表 Nodes, 部门列表 Depts, 人员列表 Emps

    2, 用户选择一个节点，标记是 DoType=AccepterSave&FK_Node=xxx&WorkID=xxx&ToNode=xxxx&SelectEmps=zhangsan,lisi.
       返回的是: 保存结果.

    -->
    <style type="text/css">
        * {
            list-style: none;
        }

        body .table tbody tr td {
            line-height: 18px;
        }

        .portlet-body, body, .portlet-title {
            background: #f4f9ff !important;
            border-bottom: 0px;
        }

        .customthr tr:nth-child(2n) {
            background: #d4e6fe;
        }

        .customthr tr:nth-child(2n+1) {
            background: #f4f9ff;
        }

        .customthr thead tr {
            background: #d4e6fe !important;
        }

        .btn {
            background: #2884fa !important;
            border-radius: 20px !important;
            color: white !important;
            padding: 4px 17px !important;
        }

        input[type=text], select {
            border-radius: 15px !important;
            border: #2884fa 1px solid !important;
            margin: 8px 0px !important;
            line-height: 25px;
            padding-left: 6px;
        }

        #btnSearch {
            height: 30px;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            margin-bottom: 0;
            font-size: 14px;
            background: #2884fa !important;
            color: #fff;
        }

        #txbSearchVal {
            font-size: 14px;
        }
        /*#poptable {
                display: none;
            }*/
        #test {
        }

        .form_tree {
            background: #f4f9ff;
        }

            .form_tree #orgTxt {
                border-radius: 15px 0px 0px 15px !important;
                margin: 0px !important;
                /*border:#2884fa 1px solid;*/
            }

            .form_tree .input-group-addon {
                border-radius: 0px 15px 15px 0px !important;
                /*broder:#2884fa 1px solid;*/
            }

        #groupTable #dt ul {
            /*background: #f4f9ff;*/
            font-weight: normal;
            background: #d4e6fe;
        }

        #groupTable #dt > li {
            /*background: #d4e6fe;*/
            font-weight: bold;
            background: #f4f9ff;
        }
    </style>
    <script type="text/javascript">
        $(function () {
            dtTable();
            $("#groupTable").height($(window).height() - 80 + "px");
        });
        //配置数据
        var firstLoad = true;
        var toNode;
        var pageUrlParam = { fk_node: GetQueryString("FK_Node"), WorkID: GetQueryString("WorkID"), FK_Flow: GetQueryString("FK_Flow") };
        function dtTable() {
            if (firstLoad) {
                toNode = 0;
            } else {
                toNode = $("#searchS1 option:selected").attr("val");
            }
            $.ajax({
                type: 'post',
                async: true,
                url: Handler + "?DoType=AccepterInit&FK_Node=" + pageUrlParam.fk_node + '&WorkID=' +
                    pageUrlParam.WorkID + '&m=' + Math.random(),
                dataType: 'html',
                data: {ToNode:toNode},
                success: function(data) {
                    if (data != null && data != undefined) {
                        var selDataArr = JSON.parse(data).Nodes;
                        var dtgArr = JSON.parse(data).Depts;
                        var dteArr = JSON.parse(data).Emps;
                        if (firstLoad == true) {
                            firstLoad = false;
                            var html = '';
                            $.each(selDataArr,function(i, obje) {
                                    html += '<option val="' + obje.No + '">' + obje.Name + '</option>';
                            });
                            $("#searchS1").html("");
                            $("#searchS1").html(html);
                            $("#searchS1 option:nth(0)").attr("selected", "selected");
                        }
                        $('#groupTable').css('display', 'block');
                        window.fkName = '';
                        if (dteArr != undefined && dteArr.length > 0) {
                            for (var pro in dteArr[0]) {
                                if (pro.toLowerCase() != "no" && pro.toLowerCase() != "name") {
                                    fkName = pro;
                                    break;
                                }
                            }
                        }
                        var ultdg = '';
                        var ultde = '';
                        var ultdes = '';
                        var s = "";
                        $.each(dtgArr,function(i, obje) {
                                for (var k = 0; k < dteArr.length; k++) {
                                    if (obje.No == dteArr[k][fkName]) {
                                        ultde +=
                                            "<li data-data='true' style='float:left;margin-right:10px;' class='lim'><input type='checkbox' style='margin: 5px 5px;'/>" + dteArr[k].Name + "</li>";
                                    }
                                }
                                var groupFileds = $.grep(dteArr, function (value) {
                                    return $('[name="' + value.FK_Dept + '"]').length == 0;
                                });
                                $.each(groupFileds, function(j, objj) {
                                    ultdes += "<li data-data='true' style='float:left;margin-right:10px;' class='lim'><input type='checkbox' style='margin: 5px 5px;'/>" + objj.Name + "</li>";
                            });
                                s = "<li class='lif'><input type='checkbox' class='ulm_head' style='margin: 5px 0px;'/>其他<ul style='overflow:hidden;margin:10px 5px 10px 0px;'>" +
                                    ultdes + "</ul></li>";
                              ultdg += "<li data-data='true' class='lif' name='" + obje.No + "'><input type='checkbox' class='ulm_head' style='margin: 5px 0px;'/>" + obje.Name + "<ul style='overflow:hidden;margin:10px 5px 10px 0px;'>" +
                                    ultde + "</ul></li>" + s;
                                ultde = "";
                            });
                        $("#groupTable #dt").html(ultdg);
                        $(".ulm_head").click(function() {
                                if (this.checked) {
                                    $(this).parent("li").children("ul").find("input").prop("checked", "checked");
                                } else {
                                    $(this).parent("li").children("ul").children("li").children("input").removeAttr("checked", "checked");
                                }
                            });
                        //实体绑定
                        $.each(dteArr,function(k, obj) {
                                var lifs = $("#groupTable #dt .lif");
                                for (var i = 0; i < lifs.length; i++) {
                                    if ($(lifs[i]).attr("name") == obj[fkName]) {
                                        var limData = $(lifs[i]).find(".lim");
                                        for (var m = 0; m < limData.length; m++) {
                                            var lim = limData[m];
                                            if ($(lim).text() == obj.Name &&$(lim) != undefined &&$(lim).data != undefined && $(lim).data() != undefined && $(lim).data().data == true) {
                                                $(lim).data().data = obj;
                                                break;
                                            }
                                        }
                                    }
                                }
                        });
                    }

                }
            });
        }
        function sedmsg() {
            var checked = $('input:checked');
            var selectedIdArrm = [];
            for (var i = 0; i < checked.parent(".lim").length; i++) {
                selectedIdArrm.push($(checked.parent(".lim")[i]).data().data.No);
            }
            return selectedIdArrm.join(';');
        }

        //确定【选择接收人并发送】
        function SendNode() {
            //AccepterSave&FK_Node=xxx&WorkID=xxx&ToNode=xxxx&SelectEmps=zhangsan,lisi
            var empNos = sedmsg();
            toNode = $("#searchS1 option:selected").attr("val");
            $.ajax({
                type: 'post',
                async: true,
                data: { "FK_Flow": pageUrlParam.FK_Flow, "WorkID": pageUrlParam.WorkID,ToNode:toNode, FK_Node:pageUrlParam.fk_node},
                url: Handler + "?DoType=AccepterSave&m=" + Math.random() + "&SelectEmps=" + empNos,
                dataType: 'html',
                success: function (data) {
                    if (window.parent != null && window.parent.returnWorkWindowClose != null) {
                        window.parent.returnWorkWindowClose(data);
                    } else {
                        $('body').append($('<div>' + data + '</div>'));
                        $('#btnOk').attr('disabled', true);
                    }
                }
            });
        }

        //取消【选择接收人并发送】
        function Close() {
            if (window.parent != null && window.parent.returnWorkWindowClose != null) {
                window.parent.returnWorkWindowClose("取消");
            } else {
                $('body').append($('<div>' + "已取消操作" + '</div>'));
            }
        }

        </script>
</head>
<body>
    <div id="searchS">
        <div style="float: left;">请选择要到达到的节点:</div>
        <div style="float: left;">
            <select id="searchS1" onclick="dtTable()" style="width: 100%;"></select>
        </div>
</div>
<div id="groupTable" style="display: none; overflow-y: auto;">
    <ul id="dt" data-data="true"></ul>
</div>
<div style="float: right;">
    <button id="btnOk" class="btn btn-info" onclick="SendNode()">发送</button>
    <button id="btnCancel" class ="btn btn-info" onclick="Close()">取消</button>
</div>
</body>
</html>
