<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>下一步接受人员列表</title>
    <!--
    1, 退回界面。
    2，需要 FK_Flow, FK_Node,WorkID, FID.
    3, 调用方法 ReturnWork.htm?FK_Flow=001&FK_Node=103&WorkID=232&FID=23
    -->
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <link href="../Scripts/bootstrap/css/bootstrap.css" rel="stylesheet" />
    <link href="../Scripts/bootstrap/css/components-rounded.css" rel="stylesheet" />
    <link href="../Scripts/bootstrap/css/font-awesome.css" rel="stylesheet" />
    <link href="../Scripts/bootstrap/css/themes/default/style.min.css" rel="stylesheet" />

    <script type="text/javascript" src="../Scripts/QueryString.js"></script>
    <script type="text/javascript" src="../Scripts/bootstrap/js/jquery.min.js"></script>
    <script type="text/javascript" src="../Scripts/bootstrap/js/jquery.cokie.min.js"></script>
    <script type="text/javascript" src="../Scripts/QueryString2016.js"></script>
    <script type="text/javascript" src="../Scripts/bootstrap/js/bootstrap.min.js"></script>

    <link href="../../DataUser/Style/ccbpm.css" rel="Stylesheet" />
    <!-- 导入配置文件. -->
    <script type="text/javascript" src="../Scripts/config.js"></script>
    <style type="text/css">
        body {
            background: transparent;
        }
            body div {
                text-align: left;
            }
        #Message {
            width: 100%;
        }
    </style>
    <script type="text/javascript">
        var param = {};
        $(function () {

            //初始化页面移交页面
            param = {
                FK_Node: GetQueryString('FK_Node'),
                WorkID: GetQueryString('WorkID'),
                FID: GetQueryString('FID'),
                Message: GetQueryString('Info'),
                FK_Flow: GetQueryString("FK_Flow")
            };

            $('#Msg').val(param.Message);

            //初始化人员选择窗口
            var selectEmpModalHtml = '<div class="modal fade" id="selectEmpsModal">' +
               '<div class="modal-dialog">'
                   + '<div class="modal-content" style="border-radius:0px;width:700px;">'
                      + '<div class="modal-header">'
                          + '<button type="button" class="close" style="color:white;opacity:1;" data-dismiss="modal" aria-hidden="true">&times;</button>'
                           + '<h4 class="modal-title">选择下一步接受人员列表人</h4>'
                       + '</div>'
                       + '<div class="modal-body">'
                           + '<iframe style="width:100%;border:0px;height:400px;" id="iframeSelectEmpsForm" name="iframeSelectEmpsForm"></iframe>'
                       + '</div>'
                   + '</div><!-- /.modal-content -->'
               + '</div><!-- /.modal-dialog -->'
           + '</div>';

            $('body').append($(selectEmpModalHtml));
            $('#iframeSelectEmpsForm').attr('src', "SelectEmps.htm?FK_Dept=" + getQueryStringByNameFromUrl("?" + $.cookie('CCS'), "FK_Dept") + "&s=" + Math.random());
            $('#BtnSelectEmps').bind('click', function () { $('#selectEmpsModal').modal().show(); });
            //$("section").show();
            $(".Msg").hide();

            // 初始化人员.   //开始加载数据.
            $.ajax({
                type: 'post',
                async: true,
                data: null,
                url: Handler + "?DoType=AccepterOfGener_Init&ToNode=" + GetQueryString("ToNode") + "&FK_Flow=" + GetQueryString("FK_Flow") + "&FK_Node=" + GetQueryString("FK_Node") + "&WorkID=" + GetQueryString("WorkID") + "&FID=" + GetQueryString("FID") + "&m=" + Math.random(),
                dataType: 'html',
                success: function (data) {

                    if (data.indexOf('err@') == 0) {
                        alert(data);
                        return;
                    }

                    var sas = JSON.parse(data);
                    BindTable(sas);
                }
            });
        });


        function BindTable(sas) {
            

            for (var i = 0; i < sas.length; i++) {
                var sa = sas[i];
                var row = "";
                row += "<tr>";
                row += "<td>" + i + "</td>";
                row += "<td>" + sa.FK_Emp + "</td>";
                row += "<td>" + sa.EmpName + "</td>";
                row += "<td><a href=\"javascript:DeleteIt(this,'" + sa.FK_Emp + "','"+sa.EmpName+"');\" >移除</a></td>";
                row += "</tr>";

                $("#Table1 tr:last").after(row);
            }
        }

        //得到行对象
        function ClearTable() {

            var table = $("#Table1");
            var trArr = table.children;
            for (var i = 0; i < trArr.length; i++) {

                var tr = trArr[i];
                if (tr.id == "title")
                    continue;

                table.remove(tr);
            }
        }

        function DeleteIt(row, empNo,empName) {

            if (window.confirm('您确定要移除[' + empNo +' , '+ empName + ']') == false)
                return;

            $.ajax({
                type: 'post',
                async: true,
                url: Handler + "?DoType=AccepterOfGener_Delete&FK_Emp=" + empNo + "&FK_Flow=" + GetQueryString("FK_Flow") + "&WorkID=" + GetQueryString("WorkID") + "&FID=" + GetQueryString("FID") + "&FK_Node=" + GetQueryString("FK_Node") + "&m=" + Math.random(),
                dataType: 'html',
                success: function (data) {

                    if (data.indexOf('err@') == 0 || data.indexOf('info@') == 0) {
                        alert(data);
                        return;
                    }

                    alert(data);

                    // 把返回的结果，重新绑定.
                    var sas = JSON.parse(data);
                    BindTable(sas);
                }
            });
        }
 

        //确定  执行下一步接受人员列表操作
        function AddEmps() {

            var emps = this.document.getElementById("TB_Emps").value;
            if (emps == "") {
               // alert('请输入要加签的人员ID,多个ID使用逗号分开.');
                return;
            }

            $.ajax({
                type: 'post',
                async: true,
                data: { FK_Flow: param.FK_Flow, WorkID: param.WorkID, FID: param.FID, FK_Node: param.FK_Node },
                url: Handler + "?DoType=AccepterOfGener_AddEmps&FK_Flow=" + param.FK_Flow + "&WorkID=" + param.WorkID + "&ToNode="+GetQueryString("ToNode") +"&FID=" + param.FID + "&FK_Node=" + param.FK_Node + "&m=" + Math.random() + "&AddEmps=" + emps,
                dataType: 'html',
                success: function (data) {

                    if (data.indexOf('err@') == 0) {
                        alert(data);
                        return;
                    }

                    if (data.indexOf('info@') == 0) {
                        $(".Msg").show();
                        $(".Msg").html(data);
                        return;
                    }

                    var gwls = JSON.parse(data);
                    BindTable(gwls);

                    document.getElementById("TB_Emps").value=""; 
                    return;
                }
            });
            $(".foot").hide();
        }

        function Send() {

            if (window.confirm('您确定要执行发送吗？') == false)
                return;

            var emps = this.document.getElementById("TB_Emps").value;
            this.AddEmps();


            $.ajax({
                type: 'post',
                async: true,
                url: Handler + "?DoType=AccepterOfGener_Send&FK_Flow=" + GetQueryString("FK_Flow") + "&WorkID=" + GetQueryString("WorkID") + "&FID=" + GetQueryString("FID") + "&FK_Node=" + GetQueryString("FK_Node") + "&m=" + Math.random() + "&ToNode=" + GetQueryString("ToNode"),
                dataType: 'html',
                success: function (data) {

                    if (data.indexOf('err@') == 0) {
                        $(".Msg").show();
                        $(".Msg").html(data);
                        return;
                    }

                    data = data.replace('@', '@<br>');

                    $(".Msg").show();
                    $(".Msg").html(data);

                    //隐藏table.
                    document.getElementById("Table1").style.display = "none";
                    document.getElementById("TB_Emps").style.display = "none";
                    document.getElementById("BtnSelectEmps").style.display = "none";
                    document.getElementById("Btn_AddEmps").style.display = "none";
                    document.getElementById("Btn_Send").style.display = "none";
                    document.getElementById("labInfo").style.display = "none";

                }
            });
        }

        //取消移交
        function Close() {
            if (window.parent != null && window.parent.returnWorkWindowClose != null) {
                window.parent.returnWorkWindowClose("");
            } else {
                $('body').append($('<div>' + "已取消操作" + '</div>'));
                window.close();
            }

            window.parent.close();
        }
        //设置选中的人员
        function selectEmpsWindowClose(data) {

            $('#selectEmpsModal').modal('hide');
            if (data == '取消') {
                return;
            }
            $('#TB_Emps').val(frames["iframeSelectEmpsForm"].window.returnVal.No);
        }
    
        //得到行对象
        function getRowObj(obj) {
            var i = 0;
            while (obj.tagName.toLowerCase() != "tr") {
                obj = obj.parentNode;
                if (obj.tagName.toLowerCase() == "table")
                    return null;
            }
            return obj;
        }

        //根据得到的行对象得到所在的行数 
        function getRowNo(obj) {
            var trObj = getRowObj(obj);
            var trArr = trObj.parentNode.children;
            for (var trNo = 0; trNo < trArr.length; trNo++) {
                if (trObj == trObj.parentNode.children[trNo]) {
                    alert(trNo + 1);
                }
            }
        }

        //删除行
        function delRow(obj) {
            var tr = this.getRowObj(obj);
            if (tr != null) {
                tr.parentNode.removeChild(tr);
            } else {
                throw new Error("the given object is not contained by the table");
            }
        }
         
</script> 

</head>
<body>
    <table id="Table1" style=" width:80%; ">
    <caption>下一步接受人员列表</caption>
    <tr id="title">
     <th style="width:19px;" >序</th>
     <th>编号 </th>
    <th>名称</th>
    <th>操作</th>
    </tr>
    </table>

    <br />
      <div>
       <div id="labInfo">
        输入要下一步接受人员列表人的编号(多个加签人使用逗号分开比如:zhangsan,lisi,wangwu)：
        <br />
        您也可以输入人员名称,多个名称用逗号分开,(比如:张三,李四,王五).
        <br />
        </div>
        <input type="text" id="TB_Emps" name="TB_Emps" value='' style=" width:400px; "/> 
         <input type="button" id="BtnSelectEmps" value='选择人员'/>
         <br />
         <input type="button" value="增加下一步接受人员列表人" id="Btn_AddEmps" onclick="AddEmps();"/>
         <input type="button" value="执行发送" onclick="Send();" id="Btn_Send"/>
         <input type="button" value="关闭" onclick="Close();"/>
    </div>

    <div class="Msg" style="text-align: center;"> <img src='../Img/loading.gif' alt="" />页面数据正在加载中，请稍候......</div>

<!--

<section style="display: none;">
    <div>
        请选择要下一步接受人员列表的人：
        <input type="text" id="ToEmp" name="ToEmp" value='' style="width: 80%;"/> <input type="button" id="BtnSelectEmps" value='选择接受人' style="position: relative; right: -562px; top: -41px; border-radius: 0px 25px 25px 0px; height: 27px;"/>
    </div>
    <div>
        下一步接受人员列表原因:
        <textarea name="Message" id="Message" style="vertical-align: top; width: 100%;"></textarea><br/>
    </div>
    <div style="margin: 20px auto;">
        <h5> 下一步接受人员列表模式:</h5>
        <input type="radio" value="0" name="RB_Model" checked=checked checked=checked id="RB_Model_0"/> <label for="RB_Model_0">下一步接受人员列表后直接发送给下一步处理人</label>
        <input type="radio" id="RB_Model_1" value="1" name="RB_Model"/> <label for="RB_Model_1">下一步接受人员列表后发送给我由我发送给下一步处理人</label>
    </div>
    <div style="position: fixed; bottom: 0px; right: 0px;" class="foot">
        <input type=button value="确定" onclick="ReturnWork();"/>
        <input type="button" id="" value="关闭" onclick="Close();"/>
    </div>
</section>-->

</body>
</html>
