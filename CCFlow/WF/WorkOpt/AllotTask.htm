<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>任务分配</title>

    <script type="text/javascript" src="../Scripts/QueryString.js"></script>
    <script type="text/javascript" src="../Scripts/bootstrap/js/jquery.min.js"></script>
    <link href="../../DataUser/Style/ccbpm.css" rel="Stylesheet" />

    <!-- 引用通用的js文件. -->
    <script type="text/javascript"   src="../Scripts/config.js" ></script>
    <script type="text/javascript"   src="../Comm/Gener.js" ></script>
    <script type="text/javascript" language="javascript" >

        var gwls = null;
        $(function () {

            var workID = GetQueryString("WorkID");
            var nodeID = GetQueryString("NodeID");

            //查询出来数据.
            gwls = new Entities("BP.WF.GenerWorkerLists");
            gwls.Retrieve("WorkID", workID, "FK_Node", nodeID);

            //有可能是分河流.
            if (gwls.length == 0)
                gwls.Retrieve("FID", workID, "FK_Node", nodeID);

            var html = "";
            html += "<ul>";
            for (var i = 0; i < gwls.length; i++) {

                var gwl = gwls[i];
                if (gwl.IsEable == 1)
                    html += "<li><label><input checked='checked' type=checkbox value='' id='" + gwl.FK_Emp + "' >" + gwl.FK_Emp + "," + gwl.FK_EmpText + "</label></li>";
                else
                    html += "<li><label><input type=checkbox value='' id='" + gwl.FK_Emp + "' >" + gwl.FK_Emp + "," + gwl.FK_EmpText + "</label></li>";
            }

            html += "</ul>";

            $("#info").html(html);
        });

        function Save() {

            for (var i = 0; i < gwls.length; i++) {

                var gwl = gwls[i];
                var gwl = new Entity("BP.WF.GenerWorkerList", gwl);

                //是否启用?
                //                var isEnable = false;
                //                if (gwl.IsEnable == 1)
                //                    isEnable = true;

                var cbId = "#CB_" + gwl.FK_Emp;
                $.each($('input:checkbox:checked'), function () {
                    if ($(this).attr('id') == gwl.FK_Emp) {
                        gwl.IsEnable = "1";
                        gwl.Update(); //执行更新.
                    } else {
                        gwl.IsEnable = "0";
                        gwl.Update(); //执行更新.
                    }
                });
                //                var cb = $("#CB_" + gwl.FK_Emp);
                //                if (cb.checked != isEnable) {
                //                    gwl.IsEnable = isEnable;
                //                    gwl.Update(); //执行更新.
                //                }
            }
           

            //保存状态与路径.
            var webUser = new WebUser();

            var rm = new Entity("BP.WF.RememberMe");
            rm.FK_Emp = webUser.No;
            rm.FK_Node = FK_Node;
            rm.SetPKVal(rm.FK_Node + "_" + rm.FK_Emp);
            rm.MyPK = rm.FK_Node + "_" + rm.FK_Emp;

            var obj = "";
            var objExt = "";
            
            //重新查询一次, 生成两个变量.
            gwls.Retrieve("WorkID", workID, "FK_Node", FK_Node, "IsEnable", 1);
          
            for (var i = 0; i < gwls.length; i++) {

                var gwl = gwls[i];
                if (gwl.IsEnable == 0)
                    continue;

                obj += gwl.FK_Emp + "@";
                objExt += gwl.FK_EmpText + "&nbsp;&nbsp;";
            }
            rm.Objs = obj;
            rm.ObjsExt = objExt;

            //生成如下两个变量.
            var emps = "";
            var empExts = "";
            for (var i = 0; i < gwls.length; i++) {
                var gwl = gwls[i];

                emps += gwl.FK_Emp + "@";

                var empInfo = gwl.FK_Emp + "," + gwl.FK_EmpText;

                if (obj.indexOf(gwl.FK_Emp) != -1)
                    empExts += "<font color=green>" + empInfo + "</font>&nbsp;&nbsp;";
                else
                    empExts += "<strike><font color=red>(" + empInfo + "</font></strike>&nbsp;&nbsp;";
            }

            rm.Emps = emps;
            rm.EmpsExt = empExts;

            rm.Save(); //执行保存.
            alert("分配成功");
        }
    </script>
</head>
<body >

<form id="cc">

<h3>工作分配</h3>

     <div id="info" ></div>

     <input type=button value='执行分配'  onclick='Save()' />

</form>

</body>
</html>
