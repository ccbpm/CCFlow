<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="../../Scripts/jquery-1.11.0.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../../Scripts/QueryString.js"></script>
    <script type="text/javascript" src="../../Scripts/config.js"></script>
    <script type="text/javascript" src="../../Comm/Gener.js"></script>

    <script src="../../Scripts/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <link href="../../Scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../../Scripts/bootstrap/css/font-awesome.css" rel="stylesheet" type="text/css" />
    <script src="../../Scripts/bootstrap/bootstrap-table/src/bootstrap-table.js" type="text/javascript"></script>
    <link href="../../Scripts/bootstrap/bootstrap-table/src/bootstrap-table.css" rel="stylesheet" type="text/css" />
    <script src="../../Scripts/bootstrap/bootstrap-table/src/locale/bootstrap-table-zh-CN.js" type="text/javascript"></script>

    <script src="../../Scripts/bootstrap/bootstrap-treeview/src/js/bootstrap-treeview.js" type="text/javascript"></script>
    <link href="../../Scripts/bootstrap/bootstrap-treeview/src/css/bootstrap-treeview.css" rel="stylesheet" type="text/css" />
    <style>
        ul li {
            list-style: none;
        }

        a, a:hover {
            text-decoration: none;
        }
    </style>
    <script type="text/javascript">

        var webUser = new WebUser();
        var WorkID = GetQueryString("WorkID");
        var NodeID = GetQueryString("ToNode");
        //初始化人员
        $(function () {


            var tps = new Entities("BP.Port.StationTypes");
            tps.RetrieveAll();

            var stas = new Entities("BP.Port.Stations");
            stas.RetrieveAll();

            var html = "<ul class='list-group'>";

            for (var idx = 0; idx < tps.length; idx++) {
                var tp = tps[idx];

                html += "<li >" + tp.Name;

                html += "<ul>";
                for (var i = 0; i < stas.length; i++) {
                    var sta = stas[i];
                    if (sta.FK_StationType != tp.No)
                        continue;

                    html += "<a href='#' onclick=ShowEmp('" + sta.No + "') id='" + sta.No + "' ><li class='list-group-item node-tree' data-nodeid='" + i + "' style='color:undefined;background-color:undefined;'>" + sta.Name + "</li></a>";
                }
                html += "</ul>";

                html += "</li>";
            }
            html += "</ul>";

            $("#stationsList").append(html);

        });

        //显示人员.
        function ShowEmp(StationNo) {
            //加载时清空人员列表
            $(".emplist").remove();
            //后台加载当前选中部门的人员列表
            var handler = new HttpHandler("BP.WF.HttpHandler.WF_WorkOpt_Selecter");
            handler.AddPara("StaNo", StationNo);
            var data = handler.DoMethodReturnString("ByStation_ShowEmps");
            var Emps = eval('(' + data + ')');
            var html = "";
            //html += " <tr>";
            //html += " <th class='bs-checkbox ' style='width:36px; ' data-field='_checkbox'>"
            //html += " <div class='th-inner '><label><input name='btSelectAll' type='checkbox'><span></span></label></div><div class='fht-cell' style='width: 35px; '></div></th>";
            //html += " <th style='' data-field='No'><div class='th-inner '>编号</div><div class='fht-cell' style='width: 551px; '></div></th>";
            //html += " <th style='' data-field='No'><div class='th-inner '>名称</div><div class='fht-cell' style='width: 386px; '></div></th>";
            //html += " </tr>";
            for (var i = 0; i < Emps.length; i++) {
                en = Emps[i];

                var en = new Entity("BP.Port.Emp", en.No);
                //html += "<a href='#'><li>&nbsp&nbsp" + en.Name + "</li></a>";
                html += "<tr class='emplist' data-index='" + i + "' data-uniqueid='" + en.No + "' >"
                html += "<td class='bs-checkbox ' ><input onclick=SelectEmp('" + en.No + "') id='" + en.Name + "' type='checkbox'></td>";
                html += "<td>" + en.No + "</td>";
                html += "<td>" + en.Name + "</td>";
                html += "</tr>";
            }
            $("#stationsEmpList").append(html)
        }
        //选择人员
        function SelectEmp(EmpNo) {
            
           //根据人员编号添加
            var en = new Entity("BP.Port.Emp", EmpNo);
            
            if (document.getElementById(en.Name).checked) {
                //添加到数据库 
                AddDataOfSelectAccper(en);
                var html = "";
                html += "<tr id='" + en.No + "' data-uniqueid='" + en.No + "'>"
                html += "<td class='bs-checkbox ' >" + en.No + "</td>";
                html += "<td>" + en.Name + "</td>";
                html += "<td><a class='newBtn btn-danger' href='#' onclick=removeRecord('" + en.No + "','" + en.Name + "')>X</a></td>";
                html += "</tr>"
               ;
                $("#selectEmpList").append(html);
            }
            else {
                //删除选中的人员
                removeRecord(en.No, en.Name);
                document.getElementById(en.No).remove();
            }
        }
        //数据库增加选择的人员
        function AddDataOfSelectAccper(en) {
            var empEn = new Entity("BP.WF.Template.SelectAccper");
            var empDept = new Entity("BP.Port.Dept", en.FK_Dept);
            empEn.MyPK = WorkID + "_" + NodeID + "_" + en.No;//设置主键
            empEn.FK_Node = GetQueryString("ToNode");
            empEn.WorkID = GetQueryString("WorkID");
            empEn.FK_Emp = en.No;
            empEn.EmpName = en.Name;
            empEn.DeptName = empDept.Name;
            empEn.Rec = webUser.No;
            if (empEn.RetrieveFromDBSources() == 0)
                empEn.Insert();
           
        }
        //删除按钮
        function removeRecord(No, Name) {
            var MyPK = WorkID + "_" + NodeID + "_" + No;
            var empEn = new Entity("BP.WF.Template.SelectAccper", MyPK);
            if (empEn.Delete()) {
                document.getElementById(Name).checked = false;
                document.getElementById(No).remove();
            }
            else {
                alert("删除失败！");
            }
        }
        function GotoUrl() {
            var url = "ByTeam.htm?WorkID=" + GetQueryString("WorkID") + "&ToNode=" + GetQueryString("ToNode");
            window.location.href = url;
        }
    </script>

</head>
<body>
    <div class="container-fluid">
        <br />
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-3 col-sm-3">
                        <h4 class="text-center" id="title">选择人员</h4>
                    </div>
                    <div class="col-md-9 col-sm-9">
                        <div class="pull-center search search-margin">
                            <input class="form-control" type="text" placeholder="" id="TB_Key">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br />
        <br />
        <!--左列-->
        <div class="row row-margin-top">
            <div class="col-md-4 col-sm-4" style="height:500px">
                <div id="stationsList" style="overflow-y:auto;height:100%">
                    <ul class="list-group">
                    </ul>
                </div>
            </div>

            <div class="col-md-8 col-sm-8">
                <div class="row" style="height:300px;">
                    <div class="col-md-12">
                        <table style="width: 976px;" class="table table-bordered table-hover" id="stationsEmpList">
                            <tr>
                                <th class="bs-checkbox " style="width: 36px; " data-field="_checkbox">
                                    <div class="th-inner "><label><input name="btSelectAll" type="checkbox"><span></span></label></div><div class="fht-cell" style="width: 35px;"></div>
                                </th>
                                <th style="" data-field="No"><div class="th-inner ">编号</div><div class="fht-cell" style="width: 551px;"></div></th>
                                <th style="" data-field="Name"><div class="th-inner ">名称</div><div class="fht-cell" style="width: 386px;"></div></th>
                            </tr>

                        </table>

                    </div>
                </div>
                <div class="row row-margin-top">
                    <div class="col-md-12">
                        <table  id="selectEmpList"style="width: 976px;" class="table table-bordered table-hover">
                            
                                <tr>
                                    <th style="" data-field="No">
                                        <div class="th-inner ">编号</div><div class="fht-cell" style="width: 456px;"></div>
                                    </th>
                                    <th style="" data-field="Name"><div class="th-inner ">名称</div><div class="fht-cell" style="width: 293px;"></div></th>
                                    <th style="" data-field="2"><div class="th-inner ">操作</div><div class="fht-cell" style="width: 223px;"></div></th>
                                </tr>
                            
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--<a onclick=""></a>
    <table class="table table-bordered" style="border:1px; border-color:black ">
        <tr>
            <td>(@)按岗位 ()<a onclick="GotoUrl()" href="#">按用户组</a> </td>
            <td>关键字:____ 查询 关闭 </td>
        </tr>
        <tr>
            <td id="stationsList" rowspan="2">
            </td>
            <td id="stationsEmpList">
            </td>
        </tr>
        <tr>
            <td id="selectEmpList" rowspan="2"></td>

        </tr>

    </table>-->

</body>
</html>
