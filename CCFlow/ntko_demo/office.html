<html>
<head>
    <meta content="IE=10" http-equiv="X-UA-Compatible" />
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>OFFICE文档控件示例</title>
    <link href="officecontrol/ntkoStyle.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="officecontrol/jquery-1.8.2.min.js"></script>
    <script type="text/javascript" src="officecontrol/ntko.js"></script>
    <script type="text/javascript">
        /**
         * 父页面传递过来的数据，通过方法ntkoGetParentData获取值
         * 如果需要把传过来的数据填充到文档里，在下方的文档打开完毕事件中去处理
         */
        var parentDataText;
        /**
        *用的.net版高管局OA来测试
        */
        var pageConfigs = {
            isedit: false,
            passwordKey: "jtt2018save",
            titleFlag: parseInt(ntko.getQuery("titleFlag")),
            recordID: ntko.getQuery("recordID"),
            wordtype: ntko.getQuery("wordtype"),
            instanceId: ntko.getQuery("instanceId")
        }
        pageConfigs.isedit = pageConfigs.titleFlag != 1;

        /**
         * 加载完毕后立刻执行
         * 在此初始化文档控件
         */
        window.onload = function () {
            //初始化文档控件
            ntko.init();
            ntko.prop("ToolBars", pageConfigs.isedit);
// ntko.createNew();
            // if (pageConfigs.titleFlag == 0) {
            //     ntko.createNew();
            // } else {
            //     ntko.beginOpenFromURL("/RequestHandler/ApiHandler.ashx?action=getSendFile&recordID=" + pageConfigs.recordID + "&wordtype=" + pageConfigs.wordtype + "&titleFlag=" + pageConfigs.titleFlag);
            // }
            ntko.openFromURL("http://192.168.100.205:8136/aboutus.docx");
        }
        /**
         * 在子页面定义的向父页面回传值的方法
         * 方法名不能自定义，必须是ntkoSendDataToParentPage
         */
        function ntkoSendDataToParentPage() {
            var callData = {
                size: 100,
                name: "文档大小"
            };
            var varData = JSON.stringify(callData);
            ntkoBrowser.ntkoSetReturnValueToParentPage("OnData", varData);

        }

        /**
         * 在子页面定义的获取父页面传值的方法
         * 方法名不能自定义，必须是ntkoGetParentData
         * 为了兼容各个浏览器，必须把传过来的数据进行decodeURI(decodeURI(data))处理
         */
        function ntkoGetParentData(data) {
            //这一步是必须的
            parentDataText = decodeURI(decodeURI(data));
        }

        /**
         * 将数据填充到文档的书签里
         */
        function ntkoDataToOffice(data) {
            if (ntko.bookMark.exists("ntko")) {
                ntko.bookMark.setValue("ntko", data);

                //改变书签字体大小颜色
                var ntkoc = ocx.ActiveDocument.bookMarks.count;
                for (var i = 1; i <= ntkoc; i++) {
                    var ntkoname = ocx.ActiveDocument.bookMarks.item(i).name;
                    if (ntkoname == "ntko") {
                        ocx.ActiveDocument.bookMarks.item(i).select();
                        ocx.ActiveDocument.Application.Selection.Font.Color = 255;
                        ocx.ActiveDocument.Application.Selection.Font.Bold = 9999998;
                        ocx.ActiveDocument.Application.Selection.Font.Size = 16;
                    }
                }
            }
        }

        /**
         * 保存文件到服务器
         */
        function saveToServer(closeFlag) {
            if (closeFlag == null || closeFlag == undefined) closeFlag = false;
            //var url = ""; //服务器地址
            var url = "/OA/GOV/Word/WordHandler.ashx?action=saveSendFile";
            var paras = [];
            if (pageConfigs.recordID !== "") {
                paras.push("fileName=" + pageConfigs.recordID + pageConfigs.wordtype);
                paras.push("guid=" + pageConfigs.instanceId);
            }
            paras.push("titleFlag=" + pageConfigs.titleFlag);
            var fileName = pageConfigs.recordID + pageConfigs.wordtype;//"保存的文件名称";
            var params = paras.join("&"); //额外提交的参数，以“&”分隔的参数－值对。例如参数值为：”key=thiskey&type=word&load=mywave”
            //隐藏痕迹
            ntko.showRevisionsFlag = false;
            ntko.setShowRevisions(ntko.showRevisionsFlag);
            //关闭痕迹保留
            ntko.setReviewMode(false);
            //设置为只读：有密码的话加上
            ntko.setReadOnly(true, pageConfigs.saveKey);

            ocx.ShowUIMessage("正在提交数据，请稍候...");
            ntko.saveToURL(url, fileName, params, function (result) {
                ocx.CloseUIMessage();
                if (typeof (result) === "string") {
                    result = $.parseJSON(result);
                }
                if (result.Status === 4) {
                    ocx.ShowTipMessage("提示", "登录超时或未登录！", true);
                    return;
                }
                if (closeFlag) {
                    ntkoclose();
                } else {
                    ocx.ShowTipMessage("提示", "保存成功！", false);
                    //处理完逻辑后初始化
                    initPage();
                }
            });


            // setTimeout(function() {
            // 	ocx.CloseUIMessage();
            // }, 2000);
        }

        function savePDFToServer() {
            if (ocx.IsPDFCreatorInstalled()) {
                ocx.ShowUIMessage("正在提交数据，请稍候...");


                setTimeout(function () {
                    ocx.CloseUIMessage();
                }, 2000);
            } else {
                ocx.ShowTipMessage("提示", "未安装PDFCreator转换器", true);
            }
        }

        function closeWindow() {
            if (pageConfigs.isedit) {
                var isAccept = ocx.ShowConfirmMessage("提示", "当前为编辑状态，是否需要将文档保存到服务器？\r\r“确定”将保存文档后返回办公系统。\r\r“取消”则直接返回办公系统。", false, true);
                if (isAccept) {
                    saveToServer(true);
                } else {

                    ntkoclose();
                }
            } else {
                ntkoclose();
            }
        }

        function initPage() {
            //先去除只读：有密码的话加上
            ntko.setReadOnly(false, pageConfigs.passwordKey);
            //默认隐藏痕迹
            ntko.showRevisionsFlag = false;
            ntko.setShowRevisions(ntko.showRevisionsFlag);
            if (pageConfigs.isedit) {
                //启用痕迹保留、设置留痕用户名
                ntko.setReviewMode(true, '用户名xxx');
            } else {
                ntko.setReadOnly(true, pageConfigs.saveKey);
            }
        }
    </script>


</head>



<body style="background-color: #E0E0E0;">
    <script type="text/javascript" for="TANGER_OCX" event="OnDocumentOpened(file, doc)">
        //文档打开完毕时执行
        setTimeout(function () {
            //添加自定义按钮
            var customToolButtons = [{
                ButtonText: "转换PDF",
                ImgIndex: 8
            }, {
                ButtonText: "正式打印",
                ImgIndex: 9
            }, {
                ButtonText: "套打",
                ImgIndex: 9
            }, {
                ButtonText: "显示/隐藏痕迹",
                ImgIndex: 13
            }, {
                ButtonText: "保存正文",
                ImgIndex: 5
            }, {
                ButtonText: "返回办公系统",
                ImgIndex: 14
            }, {
                ButtonText: "全屏/取消",
                ImgIndex: 6
            }];
            ntko.addCustomToolBar(customToolButtons);

            //设定自定义工具栏按钮状态：序号、按钮是否可用、按钮是否显示
            ocx.SetCustomToolButtonStatus(0, true, false);
            if (pageConfigs.titleFlag == 0) {
                ocx.SetCustomToolButtonStatus(1, true, false);
                ocx.SetCustomToolButtonStatus(2, true, false);
            }

            if (!pageConfigs.isedit) {
                //不可编辑时隐藏保存正文按钮
                ocx.SetCustomToolButtonStatus(4, true, false);
            }

            initPage();
            //ntkoDataToOffice(parentDataText);
        }, 100);
    </script>
    <script language="JScript" for="TANGER_OCX" event="AfterPublishAsPDFToURL(ret,code)">
        //保存为PDF后的事件处理监听
        alert(code);
        alert(ret);
    </script>
    <script language="javascript" for="TANGER_OCX" event="OnCustomToolBarCommand(btnIdx)">
        //自定义按钮事件,btnIdx对应添加时的序号，从0开始
        switch (btnIdx) {
            case 0:
                savePDFToServer();
                break;
            case 1:
                ntko.printDoc(false);
                break;
            case 2:
                if (!pageConfigs.isedit) {
                    //先去除只读：有密码的话加上
                    ntko.setReadOnly(false, pageConfigs.passwordKey);
                }
                ntko.htVisible(false);
                ntko.printDoc(false);
                ntko.htVisible(true);
                if (!pageConfigs.isedit) {
                    ntko.setReadOnly(true, pageConfigs.saveKey);
                }
                break;
            case 3:
                if (!pageConfigs.isedit) {
                    //先去除只读：有密码的话加上
                    ntko.setReadOnly(false, pageConfigs.passwordKey);
                }
                ntko.showRevisionsFlag = !ntko.showRevisionsFlag;
                ntko.setShowRevisions(ntko.showRevisionsFlag);
                if (!pageConfigs.isedit) {
                    ntko.setReadOnly(true, pageConfigs.saveKey);
                }
                break;
            case 4:
                saveToServer();
                break;
            case 5:
                closeWindow();
                break;
            case 6:
                ntko.fullScreenModeFlag = !ntko.fullScreenModeFlag;
                ntko.setFullScreenMode(ntko.fullScreenModeFlag);
                break;
        }
    </script>
    <div class="divBody">
        <script type="text/javascript" src="officecontrol/ntkoofficecontrol.min.js"></script>
    </div>
</body>
</html>
